{"version":3,"file":"start-webpack-server.js","names":["startWebpackServer","program","app","workerPool","store","report","panic","compiler","webpackActivity","websocketManager","webpackWatching","startServer","hooks","invalid","tap","pendingActivity","id","markWebpackStatusAsPending","watchRun","tapAsync","_","done","activityTimer","start","isFirstCompile","Promise","resolve","stats","suspend","urls","prepareUrls","https","host","port","isSuccessful","hasErrors","showExperimentNotices","printInstructions","sitePackageJson","name","open","openurl","localUrlForBrowser","console","log","chalk","yellow","hasWarnings","rawMessages","toJson","all","warnings","reportWebpackWarnings","errors","structureWebpackErrors","Stage","Develop","compilation","panicOnBuild","end","markWebpackStatusAsDone","emitter","emit"],"sources":["../../src/services/start-webpack-server.ts"],"sourcesContent":["import openurl from \"better-opn\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport chalk from \"chalk\"\nimport { Compiler } from \"webpack\"\nimport { Stage } from \"../commands/types\"\n\nimport {\n  reportWebpackWarnings,\n  structureWebpackErrors,\n} from \"../utils/webpack-error-utils\"\n\nimport { showExperimentNotices } from \"../utils/show-experiment-notice\"\nimport { printInstructions } from \"../utils/print-instructions\"\nimport { prepareUrls } from \"../utils/prepare-urls\"\nimport { startServer, IWebpackWatchingPauseResume } from \"../utils/start-server\"\nimport { WebsocketManager } from \"../utils/websocket-manager\"\nimport { IBuildContext } from \"./\"\nimport {\n  markWebpackStatusAsPending,\n  markWebpackStatusAsDone,\n} from \"../utils/webpack-status\"\nimport { emitter } from \"../redux\"\n\nexport async function startWebpackServer({\n  program,\n  app,\n  workerPool,\n  store,\n}: Partial<IBuildContext>): Promise<{\n  compiler: Compiler\n  websocketManager: WebsocketManager\n  webpackWatching: IWebpackWatchingPauseResume\n}> {\n  if (!program || !app || !store) {\n    report.panic(`Missing required params`)\n  }\n  let { compiler, webpackActivity, websocketManager, webpackWatching } =\n    await startServer(program, app, workerPool)\n\n  compiler.hooks.invalid.tap(`log compiling`, function () {\n    if (!webpackActivity) {\n      // mark webpack as pending if we are not in the middle of compilation already\n      // when input is invalidated during compilation, webpack will automatically\n      // run another compilation round before triggering `done` event\n      report.pendingActivity({ id: `webpack-develop` })\n      markWebpackStatusAsPending()\n    }\n  })\n\n  compiler.hooks.watchRun.tapAsync(`log compiling`, function (_, done) {\n    if (!webpackActivity) {\n      // there can be multiple `watchRun` events before receiving single `done` event\n      // webpack will not emit assets or `done` event until all pending invalidated\n      // inputs were compiled\n      webpackActivity = report.activityTimer(`Re-building development bundle`, {\n        id: `webpack-develop`,\n      })\n      webpackActivity.start()\n    }\n\n    done()\n  })\n\n  let isFirstCompile = true\n\n  return new Promise(resolve => {\n    compiler.hooks.done.tapAsync(\n      `print gatsby instructions`,\n      async function (stats, done) {\n        if (isFirstCompile) {\n          webpackWatching.suspend()\n        }\n\n        const urls = prepareUrls(\n          program.https ? `https` : `http`,\n          program.host,\n          program.port\n        )\n        const isSuccessful = !stats.hasErrors()\n\n        if (isSuccessful && isFirstCompile) {\n          // Show notices to users about potential experiments/feature flags they could\n          // try.\n          showExperimentNotices()\n          printInstructions(\n            program.sitePackageJson.name || `(Unnamed package)`,\n            urls\n          )\n\n          if (program.open) {\n            try {\n              await openurl(urls.localUrlForBrowser)\n            } catch {\n              console.log(\n                `${chalk.yellow(\n                  `warn`\n                )} Browser not opened because no browser was found`\n              )\n            }\n          }\n        }\n\n        isFirstCompile = false\n\n        if (webpackActivity) {\n          if (stats.hasWarnings()) {\n            const rawMessages = stats.toJson({ all: false, warnings: true })\n            reportWebpackWarnings(rawMessages.warnings, report)\n          }\n\n          if (!isSuccessful) {\n            const errors = structureWebpackErrors(\n              Stage.Develop,\n              stats.compilation.errors\n            )\n            webpackActivity.panicOnBuild(errors)\n          }\n          webpackActivity.end()\n          webpackActivity = null\n        }\n\n        markWebpackStatusAsDone()\n        done()\n        emitter.emit(`COMPILATION_DONE`, stats)\n        resolve({ compiler, websocketManager, webpackWatching })\n      }\n    )\n  })\n}\n"],"mappings":"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"}