{"version":3,"file":"resolve-module-exports.js","names":["staticallyAnalyzeExports","modulePath","resolver","resolveModule","absPath","exportNames","err","code","fs","readFileSync","ast","babelParseToAst","SyntaxError","codeFrame","codeFrameColumns","start","loc","highlightCode","report","panic","message","isCommonJS","isES6","traverse","ImportDeclaration","ExportNamedDeclaration","astPath","declaration","node","type","declarations","id","push","name","ExportSpecifier","exp","exported","exportName","ExportDefaultDeclaration","t","isIdentifier","isArrowFunctionExpression","isFunctionDeclaration","AssignmentExpression","nodeLeft","left","isMemberExpression","property","object","process","env","NODE_ENV","resolveModuleExports","mode","rootDir","cwd","moduleFilePath","resolveJSFilepath","filePath","rawImportedModule","maybeAddFileProtocol","importedModule","preferDefault","Object","keys","filter","error","testImportError"],"sources":["../../src/bootstrap/resolve-module-exports.ts"],"sourcesContent":["import * as fs from \"fs-extra\"\nimport * as t from \"@babel/types\"\nimport traverse from \"@babel/traverse\"\nimport { codeFrameColumns, SourceLocation } from \"@babel/code-frame\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport { babelParseToAst } from \"../utils/babel-parse-to-ast\"\nimport { testImportError } from \"../utils/test-import-error\"\nimport { resolveModule, ModuleResolver } from \"../utils/module-resolver\"\nimport { maybeAddFileProtocol, resolveJSFilepath } from \"./resolve-js-file-path\"\nimport { preferDefault } from \"./prefer-default\"\n\nconst staticallyAnalyzeExports = (\n  modulePath: string,\n  resolver = resolveModule\n): Array<string> => {\n  let absPath: string | undefined\n  const exportNames: Array<string> = []\n\n  try {\n    absPath = resolver(modulePath) as string\n  } catch (err) {\n    return exportNames // doesn't exist\n  }\n  const code = fs.readFileSync(absPath, `utf8`) // get file contents\n\n  let ast\n  try {\n    ast = babelParseToAst(code, absPath)\n  } catch (err) {\n    if (err instanceof SyntaxError) {\n      // Pretty print syntax errors\n      const codeFrame = codeFrameColumns(\n        code,\n        {\n          start: (err as unknown as { loc: SourceLocation[\"start\"] }).loc,\n        },\n        {\n          highlightCode: true,\n        }\n      )\n\n      report.panic(\n        `Syntax error in \"${absPath}\":\\n${err.message}\\n${codeFrame}`\n      )\n    } else {\n      // if it's not syntax error, just throw it\n      throw err\n    }\n  }\n\n  let isCommonJS = false\n  let isES6 = false\n\n  // extract names of exports from file\n  traverse(ast, {\n    // Check if the file is using ES6 imports\n    ImportDeclaration: function ImportDeclaration() {\n      isES6 = true\n    },\n\n    ExportNamedDeclaration: function ExportNamedDeclaration(astPath) {\n      const declaration = astPath.node.declaration\n\n      // get foo from `export const foo = bar`\n      if (\n        declaration?.type === `VariableDeclaration` &&\n        declaration.declarations[0]?.id.type === `Identifier`\n      ) {\n        isES6 = true\n        exportNames.push(declaration.declarations[0].id.name)\n      }\n\n      // get foo from `export function foo()`\n      if (\n        declaration?.type === `FunctionDeclaration` &&\n        declaration.id?.type === `Identifier`\n      ) {\n        isES6 = true\n        exportNames.push(declaration.id.name)\n      }\n    },\n\n    // get foo from `export { foo } from 'bar'`\n    // get foo from `export { foo }`\n    ExportSpecifier: function ExportSpecifier(astPath) {\n      isES6 = true\n      const exp = astPath?.node?.exported\n      if (!exp) {\n        return\n      }\n      if (exp.type === `Identifier`) {\n        const exportName = exp.name\n        if (exportName) {\n          exportNames.push(exportName)\n        }\n      }\n    },\n\n    // export default () => {}\n    // export default function() {}\n    // export default function foo() {}\n    // const foo = () => {}; export default foo\n    ExportDefaultDeclaration: function ExportDefaultDeclaration(astPath) {\n      const declaration = astPath.node.declaration\n      if (\n        !t.isIdentifier(declaration) &&\n        !t.isArrowFunctionExpression(declaration) &&\n        !t.isFunctionDeclaration(declaration)\n      ) {\n        return\n      }\n\n      let name = ``\n      if (t.isIdentifier(declaration)) {\n        name = declaration.name\n      } else if (t.isFunctionDeclaration(declaration) && declaration.id) {\n        name = declaration.id.name\n      }\n\n      const exportName = `export default${name ? ` ${name}` : ``}`\n      isES6 = true\n      exportNames.push(exportName)\n    },\n\n    AssignmentExpression: function AssignmentExpression(astPath) {\n      const nodeLeft = astPath.node.left\n\n      if (!t.isMemberExpression(nodeLeft)) {\n        return\n      }\n\n      // ignore marker property `__esModule`\n      if (\n        t.isIdentifier(nodeLeft.property) &&\n        nodeLeft.property.name === `__esModule`\n      ) {\n        return\n      }\n\n      // get foo from `exports.foo = bar`\n      if (\n        t.isIdentifier(nodeLeft.object) &&\n        nodeLeft.object.name === `exports`\n      ) {\n        isCommonJS = true\n        exportNames.push((nodeLeft.property as t.Identifier).name)\n      }\n\n      // get foo from `module.exports.foo = bar`\n      if (t.isMemberExpression(nodeLeft.object)) {\n        const exp: t.MemberExpression = nodeLeft.object\n\n        if (\n          t.isIdentifier(exp.object) &&\n          t.isIdentifier(exp.property) &&\n          exp.object.name === `module` &&\n          exp.property.name === `exports`\n        ) {\n          isCommonJS = true\n          exportNames.push((nodeLeft.property as t.Identifier).name)\n        }\n      }\n    },\n  })\n\n  if (isES6 && isCommonJS && process.env.NODE_ENV !== `test`) {\n    report.panic(\n      `This plugin file is using both CommonJS and ES6 module systems together which we don't support.\nYou'll need to edit the file to use just one or the other.\n\nplugin: ${modulePath}.js\n\nThis didn't cause a problem in Gatsby v1 so you might want to review the migration doc for this:\nhttps://gatsby.dev/no-mixed-modules\n      `\n    )\n  }\n  return exportNames\n}\n\ninterface IResolveModuleExportsOptions {\n  mode?: `analysis` | `import`\n  resolver?: ModuleResolver\n  rootDir?: string\n}\n\n/**\n * Given a path to a module, return an array of the module's exports.\n *\n * It can run in two modes:\n * 1. `analysis` mode gets exports via static analysis by traversing the file's AST with babel\n * 2. `import` mode gets exports by directly importing the module and accessing its properties\n *\n * At the time of writing, analysis mode is used for files that can be jsx (e.g. gatsby-browser, gatsby-ssr)\n * and import mode is used for files that can be js or mjs.\n *\n * Returns [] for invalid paths and modules without exports.\n */\nexport async function resolveModuleExports(\n  modulePath: string,\n  {\n    mode = `analysis`,\n    resolver = resolveModule,\n    rootDir = process.cwd(),\n  }: IResolveModuleExportsOptions = {}\n): Promise<Array<string>> {\n  if (mode === `import`) {\n    try {\n      const moduleFilePath = await resolveJSFilepath({\n        rootDir,\n        filePath: modulePath,\n      })\n\n      if (!moduleFilePath) {\n        return []\n      }\n\n      const rawImportedModule = await import(\n        maybeAddFileProtocol(moduleFilePath)\n      )\n\n      // If the module is cjs, the properties we care about are nested under a top-level `default` property\n      const importedModule = preferDefault(rawImportedModule)\n\n      return Object.keys(importedModule).filter(\n        exportName => exportName !== `__esModule`\n      )\n    } catch (error) {\n      if (!testImportError(modulePath, error)) {\n        // if module exists, but requiring it cause errors,\n        // show the error to the user and terminate build\n        report.panic(`Error in \"${modulePath}\":`, error)\n      }\n    }\n  } else {\n    return staticallyAnalyzeExports(modulePath, resolver)\n  }\n\n  return []\n}\n"],"mappings":"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"}