{"version":3,"file":"load-internal-plugins.js","names":["TYPESCRIPT_PLUGIN_NAME","loadInternalPlugins","config","rootDir","plugins","configuredPluginNames","Set","internalPlugins","filter","Boolean","forEach","relPath","absPath","path","join","__dirname","push","processPlugin","plugin","processedPlugin","add","name","resolve","require","options","slash","pathCheck","has","GATSBY_CLOUD_PLUGIN_NAME","incompatibleGatsbyCloudPlugin","reporter","panic","process","env","GATSBY_CLOUD","addGatsbyPluginCloudPluginWhenInstalled","GATSBY_PLUGIN_PREVIEW_NAME","addGatsbyPluginPreviewWhenInstalled","processedTypeScriptPlugin","allExtensions","isTSX","jsxPragma","cwd","id","createPluginId","version","createFileContentHash","pluginOptions","getResolvedFieldsForPlugin","program","store","getState","pageCreatorOptions","directory","pageCreatorPlugin","find","processedPageCreatorPlugin","uniquePlugins"],"sources":["../../../src/bootstrap/load-plugins/load-internal-plugins.ts"],"sourcesContent":["import { slash } from \"gatsby-core-utils\"\nimport { uniqWith, isEqual } from \"lodash\"\nimport path from \"path\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { store } from \"../../redux\"\nimport {\n  IPluginInfo,\n  IPluginRefObject,\n  IPluginRefOptions,\n  ISiteConfig,\n} from \"./types\"\nimport { processPlugin } from \"./process-plugin\"\nimport { createPluginId } from \"./utils/create-id\"\nimport { createFileContentHash } from \"./utils/create-hash\"\nimport {\n  addGatsbyPluginCloudPluginWhenInstalled,\n  addGatsbyPluginPreviewWhenInstalled,\n  incompatibleGatsbyCloudPlugin,\n  GATSBY_CLOUD_PLUGIN_NAME,\n  GATSBY_PLUGIN_PREVIEW_NAME,\n} from \"./utils/handle-gatsby-cloud\"\nimport { getResolvedFieldsForPlugin } from \"../../utils/parcel/compile-gatsby-files\"\n\nconst TYPESCRIPT_PLUGIN_NAME = `gatsby-plugin-typescript`\n\nexport function loadInternalPlugins(\n  config: ISiteConfig = {},\n  rootDir: string\n): Array<IPluginInfo> {\n  // Instantiate plugins.\n  const plugins: Array<IPluginInfo> = []\n  const configuredPluginNames = new Set()\n\n  // Add internal plugins\n  const internalPlugins = [\n    `../../internal-plugins/dev-404-page`,\n    `../../internal-plugins/load-babel-config`,\n    `../../internal-plugins/internal-data-bridge`,\n    `../../internal-plugins/prod-404-500`,\n    `../../internal-plugins/webpack-theme-component-shadowing`,\n    `../../internal-plugins/bundle-optimisations`,\n    `../../internal-plugins/functions`,\n  ].filter(Boolean) as Array<string>\n\n  internalPlugins.forEach(relPath => {\n    const absPath = path.join(__dirname, relPath)\n    plugins.push(processPlugin(absPath, rootDir))\n  })\n\n  // Add plugins from the site config.\n  if (config.plugins) {\n    config.plugins.forEach(plugin => {\n      const processedPlugin = processPlugin(plugin, rootDir)\n      plugins.push(processedPlugin)\n      configuredPluginNames.add(processedPlugin.name)\n    })\n  }\n\n  // the order of all of these page-creators matters. The \"last plugin wins\",\n  // so the user's site comes last, and each page-creator instance has to\n  // match the plugin definition order before that. This works fine for themes\n  // because themes have already been added in the proper order to the plugins\n  // array\n  plugins.forEach(plugin => {\n    plugins.push(\n      processPlugin(\n        {\n          resolve: require.resolve(`gatsby-plugin-page-creator`),\n          options: {\n            path: slash(path.join(plugin.resolve, `src/pages`)),\n            pathCheck: false,\n          },\n        },\n        rootDir\n      )\n    )\n  })\n\n  if (\n    configuredPluginNames.has(GATSBY_CLOUD_PLUGIN_NAME) &&\n    incompatibleGatsbyCloudPlugin(plugins)\n  ) {\n    reporter.panic(\n      `Plugin gatsby-plugin-gatsby-cloud is not compatible with your gatsby version. Please upgrade to gatsby-plugin-gatsby-cloud@next`\n    )\n  }\n\n  if (\n    !configuredPluginNames.has(GATSBY_CLOUD_PLUGIN_NAME) &&\n    (process.env.GATSBY_CLOUD === `true` || process.env.GATSBY_CLOUD === `1`)\n  ) {\n    addGatsbyPluginCloudPluginWhenInstalled(plugins, rootDir)\n  }\n\n  if (\n    !configuredPluginNames.has(GATSBY_PLUGIN_PREVIEW_NAME) &&\n    (process.env.GATSBY_CLOUD === `true` || process.env.GATSBY_CLOUD === `1`)\n  ) {\n    addGatsbyPluginPreviewWhenInstalled(plugins, rootDir)\n  }\n\n  // Support Typescript by default but allow users to override it\n  if (!configuredPluginNames.has(TYPESCRIPT_PLUGIN_NAME)) {\n    const processedTypeScriptPlugin = processPlugin(\n      {\n        resolve: require.resolve(TYPESCRIPT_PLUGIN_NAME),\n        options: {\n          // TODO(@mxstbr): Do not hard-code these defaults but infer them from the\n          // pluginOptionsSchema of gatsby-plugin-typescript\n          allExtensions: false,\n          isTSX: false,\n          jsxPragma: `React`,\n        },\n      },\n      rootDir\n    )\n    plugins.push(processedTypeScriptPlugin)\n  }\n\n  // Add the site's default \"plugin\" i.e. gatsby-x files in root of site.\n  plugins.push({\n    resolve: slash(process.cwd()),\n    id: createPluginId(`default-site-plugin`),\n    name: `default-site-plugin`,\n    version: createFileContentHash(process.cwd(), `gatsby-*`),\n    pluginOptions: {\n      plugins: [],\n    },\n    ...getResolvedFieldsForPlugin(rootDir, `default-site-plugin`),\n  })\n\n  const program = store.getState().program\n\n  // default options for gatsby-plugin-page-creator\n  let pageCreatorOptions: IPluginRefOptions | undefined = {\n    path: slash(path.join(program.directory, `src/pages`)),\n    pathCheck: false,\n  }\n\n  if (config.plugins) {\n    const pageCreatorPlugin = config.plugins.find(\n      (plugin): plugin is IPluginRefObject =>\n        typeof plugin !== `string` &&\n        plugin.resolve === `gatsby-plugin-page-creator` &&\n        slash((plugin.options && plugin.options.path) || ``) ===\n          slash(path.join(program.directory, `src/pages`))\n    )\n    if (pageCreatorPlugin) {\n      // override the options if there are any user specified options\n      pageCreatorOptions = pageCreatorPlugin.options\n    }\n  }\n\n  const processedPageCreatorPlugin = processPlugin(\n    {\n      resolve: require.resolve(`gatsby-plugin-page-creator`),\n      options: pageCreatorOptions,\n    },\n    rootDir\n  )\n\n  plugins.push(processedPageCreatorPlugin)\n\n  // Partytown plugin collects usage of <Script strategy={\"off-main-thread\"} />\n  // in `wrapRootElement`, so we have to make sure it's the last one running to be able to\n  // collect scripts that users might inject in their `wrapRootElement`\n  plugins.push(\n    processPlugin(\n      path.join(__dirname, `../../internal-plugins/partytown`),\n      rootDir\n    )\n  )\n\n  const uniquePlugins = uniqWith(plugins, isEqual)\n\n  return uniquePlugins\n}\n"],"mappings":"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"}