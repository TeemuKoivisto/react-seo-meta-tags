{"version":3,"file":"develop-process.js","names":["tracer","globalTracer","setTimeout","syncStaticDir","process","send","setInterval","type","onExit","SSGCount","DSGCount","SSRCount","page","store","getState","pages","values","mode","telemetry","trackCli","siteMeasurements","totalPagesCount","size","on","msg","action","exit","payload","openDebuggerPort","debugInfo","inspector","url","undefined","break","open","port","module","exports","program","global","__GATSBY","env","GATSBY_NODE_GLOBALS","JSON","parse","isTruthy","VERBOSE","verbose","reporter","setVerbose","userGetsSevenDayFeedback","showSevenDayFeedbackRequest","userPassesFeedbackRequestHeuristic","showFeedbackRequest","initTracer","GATSBY_OPEN_TRACING_CONFIG_FILE","openTracingConfigFile","markWebpackStatusAsPending","pendingActivity","id","startBackgroundUpdate","parseInt","hostname","host","detectPortInUseAndPrompt","e","message","app","express","parentSpan","startSpan","use","req","res","next","decodeURIComponent","path","status","machine","developMachine","withContext","pendingQueryRuns","Set","shouldRunInitialTypegen","service","interpret","logTransitions","start"],"sources":["../../src/commands/develop-process.ts"],"sourcesContent":["import { syncStaticDir } from \"../utils/get-static-dir\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport telemetry from \"gatsby-telemetry\"\nimport { isTruthy } from \"gatsby-core-utils\"\nimport express from \"express\"\nimport inspector from \"inspector\"\nimport { initTracer } from \"../utils/tracer\"\nimport { detectPortInUseAndPrompt } from \"../utils/detect-port-in-use-and-prompt\"\nimport onExit from \"signal-exit\"\nimport {\n  userGetsSevenDayFeedback,\n  userPassesFeedbackRequestHeuristic,\n  showFeedbackRequest,\n  showSevenDayFeedbackRequest,\n} from \"../utils/feedback\"\nimport { markWebpackStatusAsPending } from \"../utils/webpack-status\"\nimport { store } from \"../redux\"\n\nimport { IProgram, IDebugInfo } from \"./types\"\nimport { interpret } from \"xstate\"\nimport { globalTracer } from \"opentracing\"\nimport { developMachine } from \"../state-machines/develop\"\nimport { logTransitions } from \"../utils/state-machine-logging\"\n\nconst tracer = globalTracer()\n\n// const isInteractive = process.stdout.isTTY\n\n// Watch the static directory and copy files to public as they're added or\n// changed. Wait 10 seconds so copying doesn't interfere with the regular\n// bootstrap.\nsetTimeout(() => {\n  syncStaticDir()\n}, 10000)\n\n// Time for another story...\n// When the parent process is killed by SIGKILL, Node doesm't kill spawned child processes\n// Hence, we peiodically send a heart beat to the parent to check if it is still alive\n// This will crash with Error [ERR_IPC_CHANNEL_CLOSED]: Channel closed\n// and kill the orphaned child process as a result\nif (process.send) {\n  setInterval(() => {\n    // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n    process.send!({\n      type: `HEARTBEAT`,\n    })\n  }, 1000)\n}\n\nonExit(() => {\n  let SSGCount = 0\n  let DSGCount = 0\n  let SSRCount = 0\n  for (const page of store.getState().pages.values()) {\n    if (page.mode === `SSR`) {\n      SSRCount++\n    } else if (page.mode === `DSG`) {\n      DSGCount++\n    } else {\n      SSGCount++\n    }\n  }\n\n  telemetry.trackCli(`DEVELOP_STOP`, {\n    siteMeasurements: {\n      totalPagesCount: store.getState().pages.size,\n      SSRCount,\n      DSGCount,\n      SSGCount,\n    },\n  })\n})\n\nprocess.on(\n  `message`,\n  (msg: {\n    type: string\n    action: { type: string; payload: number | undefined }\n  }) => {\n    if (msg.type === `COMMAND` && msg.action.type === `EXIT`) {\n      process.exit(msg.action.payload)\n    }\n  }\n)\n\ninterface IDevelopArgs extends IProgram {\n  debugInfo: IDebugInfo | null\n}\n\nconst openDebuggerPort = (debugInfo: IDebugInfo): void => {\n  if (inspector.url() !== undefined) {\n    return // fixes #26708\n  }\n\n  if (debugInfo.break) {\n    inspector.open(debugInfo.port, undefined, true)\n    // eslint-disable-next-line no-debugger\n    debugger\n  } else {\n    inspector.open(debugInfo.port)\n  }\n}\n\nmodule.exports = async (program: IDevelopArgs): Promise<void> => {\n  // provide global Gatsby object\n  global.__GATSBY = process.env.GATSBY_NODE_GLOBALS\n    ? JSON.parse(process.env.GATSBY_NODE_GLOBALS)\n    : {}\n\n  if (isTruthy(process.env.VERBOSE)) {\n    program.verbose = true\n  }\n  reporter.setVerbose(program.verbose)\n\n  if (program.debugInfo) {\n    openDebuggerPort(program.debugInfo)\n  }\n\n  // We want to prompt the feedback request when users quit develop\n  // assuming they pass the heuristic check to know they are a user\n  // we want to request feedback from, and we're not annoying them.\n  process.on(`SIGINT`, async (): Promise<void> => {\n    if (await userGetsSevenDayFeedback()) {\n      showSevenDayFeedbackRequest()\n    } else if (await userPassesFeedbackRequestHeuristic()) {\n      showFeedbackRequest()\n    }\n    process.exit(0)\n  })\n\n  await initTracer(\n    process.env.GATSBY_OPEN_TRACING_CONFIG_FILE || program.openTracingConfigFile\n  )\n  markWebpackStatusAsPending()\n  reporter.pendingActivity({ id: `webpack-develop` })\n  telemetry.trackCli(`DEVELOP_START`)\n  telemetry.startBackgroundUpdate()\n\n  const port =\n    typeof program.port === `string` ? parseInt(program.port, 10) : program.port\n  const hostname = program.host\n  try {\n    program.port = await detectPortInUseAndPrompt(port, hostname)\n  } catch (e) {\n    if (e.message === `USER_REJECTED`) {\n      process.exit(0)\n    }\n\n    throw e\n  }\n\n  const app = express()\n  const parentSpan = tracer.startSpan(`bootstrap`)\n\n  app.use((req, res, next) => {\n    try {\n      decodeURIComponent(req.path)\n    } catch (e) {\n      return res.status(500).send(`URI malformatted`)\n    }\n\n    return next()\n  })\n\n  const machine = developMachine.withContext({\n    program,\n    parentSpan,\n    app,\n    reporter,\n    pendingQueryRuns: new Set([`/`]),\n    shouldRunInitialTypegen: true,\n  })\n\n  const service = interpret(machine)\n\n  if (program.verbose) {\n    logTransitions(service)\n  }\n\n  service.start()\n}\n"],"mappings":"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"}