{"version":3,"file":"feedback.js","names":["feedbackKey","lastDateKey","firstDateKey","sevenDayKey","setFeedbackDisabledValue","enabled","getConfigStore","set","showFeedbackRequest","Date","now","trackCli","name","report","log","showSevenDayFeedbackRequest","randomChanceToBeTrue","currentQuarter","Math","floor","getMonth","randomNumber","random","randomNumberWithinQuarter","getDayOfYear","userPassesFeedbackRequestHeuristic","randomlyPassingHeuristic","isFeedbackDisabled","lastDateValue","get","lastDate","threeMonthsAgo","setMonth","sevenDayFeedback","sevenDayDate","versionPoints","getGatsbyVersion","split","latestVersionPoints","default","latestVersion","e","versionsMatchOnMajorAndMinor","isCI","process","env","GATSBY_FEEDBACK_DISABLED","userGetsSevenDayFeedback","firstDateValue","sevenDaysAgo","setDate","getDate"],"sources":["../../src/utils/feedback.ts"],"sourcesContent":["import report from \"gatsby-cli/lib/reporter\"\nimport { getConfigStore, getGatsbyVersion, isCI } from \"gatsby-core-utils\"\nimport { trackCli } from \"gatsby-telemetry\"\nimport getDayOfYear from \"date-fns/getDayOfYear\"\n\nconst feedbackKey = `feedback.disabled`\nconst lastDateKey = `feedback.lastRequestDate`\nconst firstDateKey = `feedback.firstCheckDate`\nconst sevenDayKey = `feedback.sevenDayFeedbackDate`\n\n// This function is designed to be used by `gatsby feedback --disable`\n// and `gatsby feedback --enable`. This key is used to determine\n// if a user is allowed to be solicited for feedback\nexport function setFeedbackDisabledValue(enabled: boolean): void {\n  getConfigStore().set(feedbackKey, enabled)\n}\n\n// Print the feedback request to the user\nexport function showFeedbackRequest(): void {\n  getConfigStore().set(lastDateKey, Date.now())\n  trackCli(`SHOW_FEEDBACK_LINK`, {\n    name: `https://gatsby.dev/feedback`,\n  })\n  report.log(\n    `\\n\\nHello! Will you help Gatsby improve by taking a four question survey?\\nIt takes less than five minutes and your ideas and feedback will be very helpful.`\n  )\n  report.log(`\\nGive us your feedback here: https://gatsby.dev/feedback\\n\\n`)\n}\n\nexport function showSevenDayFeedbackRequest(): void {\n  getConfigStore().set(sevenDayKey, Date.now())\n  trackCli(`SHOW_SEVEN_DAY_FEEDBACK_LINK`, {\n    name: `https://gatsby.dev/feedback-survey`,\n  })\n  report.log(\n    `\\n\\nHi there! Will you tell us about how you're learning Gatsby? \\nIt takes less than 5 minutes and your feedback will help us make installing and using Gatsby so much better.`\n  )\n  report.log(\n    `\\nGive us your feedback here: https://gatsby.dev/feedback-survey\\n\\n`\n  )\n}\n\nconst randomChanceToBeTrue = (): boolean => {\n  // This is spreading the request volume over the quarter.\n  // We are grabbing a randomNumber within the spread of a first day\n  // of a quarter, to the last day\n  const currentQuarter = Math.floor((new Date().getMonth() + 3) / 3)\n  const randomNumber = Math.floor(\n    Math.random() *\n      // One quarter year in days (roughly)\n      (30 * 3)\n  )\n  const randomNumberWithinQuarter = randomNumber + 30 * 3 * (currentQuarter - 1)\n\n  return randomNumberWithinQuarter === getDayOfYear(new Date())\n}\n\n// We are only showing feedback requests to users in if they pass a few checks:\n// 1. They pass a Math.random() check. This is a skateboard version of not sending out all requests in one day.\n// 2. Gatsby is not running in CI\n// 3. They don't have the environment variable to disable feedback present\n// 4. They haven't disabled the feedback mechanism\n// 5. It's been at least 3 months since the last feedback request\n// 6. They are on the most recent version of Gatsby\nexport async function userPassesFeedbackRequestHeuristic(): Promise<boolean> {\n  // Heuristic 1\n  // We originally wrote this to have a single chance of hitting.\n  // We wanted to up the chance by 5x, so this is our crude - temporary -\n  // way of giving the user 5 chances to passing.\n  const randomlyPassingHeuristic =\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue() ||\n    randomChanceToBeTrue()\n\n  if (!randomlyPassingHeuristic) {\n    return false\n  }\n\n  if (isFeedbackDisabled()) {\n    return false\n  }\n\n  // Heuristic 5\n  const lastDateValue = getConfigStore().get(lastDateKey)\n  // 5.a if the user has never received the feedback request, this is undefined\n  //     Which is effectively a pass, because it's been ~infinity~ since they last\n  //     received a request from us.\n  if (lastDateValue) {\n    const lastDate = new Date(lastDateValue)\n    const threeMonthsAgo = new Date()\n    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3)\n\n    if (lastDate > threeMonthsAgo) {\n      return false\n    }\n  }\n\n  // 5.b\n  // we don't want to give them this survey right after the seven day feedback survey\n  const sevenDayFeedback = getConfigStore().get(sevenDayKey)\n  if (sevenDayFeedback) {\n    const sevenDayDate = new Date(sevenDayFeedback)\n    const threeMonthsAgo = new Date()\n    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3)\n\n    if (sevenDayDate > threeMonthsAgo) {\n      return false\n    }\n  }\n\n  // Heuristic 6\n  const versionPoints = getGatsbyVersion().split(`.`)\n  let latestVersionPoints: Array<string> = []\n  try {\n    const { default: latestVersion } = await import(`latest-version`)\n    latestVersionPoints = (await latestVersion(`gatsby`)).split(`.`)\n  } catch (e) {\n    // do nothing.\n    // if the request fails, then we should just not show the feedback request\n    // because this in theory could happen often and we don't want to be spammy.\n    // In this case, we are guaranteed to have `versionsMatchOnMajorAndMinor` === false\n  }\n\n  // Since we push versions very frequently. So thinking that users will\n  // be on the latest patch is potentially unrealistic. So we are just\n  // comparing on major and minor version points.\n  const versionsMatchOnMajorAndMinor =\n    versionPoints[0] === latestVersionPoints[0] &&\n    versionPoints[1] === latestVersionPoints[1]\n\n  if (versionsMatchOnMajorAndMinor === false) {\n    return false\n  }\n\n  // If all of the above passed, then the user is able to be prompted\n  // for feedback\n  return true\n}\n\nfunction isFeedbackDisabled(): boolean {\n  // Reasoning for this order: Checking for CI fixes issues like\n  // https://github.com/gatsbyjs/gatsby/issues/30647\n  // TODO: Additionally prevent getConfigStore from erroring\n\n  // Heuristic 2\n  if (isCI()) {\n    return true\n  }\n\n  // Heuristic 3\n  if (process.env.GATSBY_FEEDBACK_DISABLED === `1`) {\n    return true\n  }\n\n  // Heuristic 4\n  if (getConfigStore().get(feedbackKey) === true) {\n    return true\n  }\n\n  return false\n}\n\nexport async function userGetsSevenDayFeedback(): Promise<boolean> {\n  if (isFeedbackDisabled()) return false\n\n  if (getConfigStore().get(sevenDayKey)) return false\n\n  const firstDateValue = getConfigStore().get(firstDateKey)\n\n  if (!firstDateValue) {\n    getConfigStore().set(firstDateKey, Date.now()) // set this for the first time\n    return false\n  } else {\n    const lastDate = new Date(firstDateValue)\n    const sevenDaysAgo = new Date()\n    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\n\n    if (lastDate > sevenDaysAgo) {\n      return false\n    }\n  }\n  return true\n}\n"],"mappings":"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"}