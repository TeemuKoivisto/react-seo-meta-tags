{"version":3,"file":"middleware.js","names":["expressBuiltinMiddleware","urlencoded","text","json","raw","createSetContextFunctionMiddleware","getFunctions","prepareFn","showDebugMessageInResponse","executeFunction","req","res","next","functions","pathFragment","params","functionObj","find","functionRoute","some","f","matchPath","matchResult","reachMatch","userConfig","pathToFunction","absoluteCompiledFilePath","fnToExecute","require","cache","resolve","fn","config","default","e","message","includes","originalAbsoluteFilePath","undefined","reporter","error","headersSent","status","send","sendStatus","context","createConfig","setCookies","_res","cookies","headers","cookie","parse","bodyParserMiddlewareWithConfig","type","bodyParser","bodyParserConfig","verbose","start","Date","now","Promise","end","log","functionMiddlewares","middlewareConfig","setContext","multer","any"],"sources":["../../../src/internal-plugins/functions/middleware.ts"],"sourcesContent":["import { match as reachMatch } from \"@gatsbyjs/reach-router\"\nimport cookie from \"cookie\"\nimport { urlencoded, text, json, raw } from \"express\"\nimport type { RequestHandler, Request, Response, NextFunction } from \"express\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport multer from \"multer\"\n\nimport {\n  createConfig,\n  IGatsbyFunctionConfigProcessed,\n  IGatsbyBodyParserConfigProcessed,\n} from \"./config\"\nimport type { IGatsbyFunction } from \"../../redux/types\"\n\nconst expressBuiltinMiddleware = {\n  urlencoded,\n  text,\n  json,\n  raw,\n}\n\ninterface IGatsbyRequestContext {\n  functionObj: IGatsbyFunction\n  fnToExecute: (req: Request, res: Response) => void | Promise<void>\n  // we massage params early in setContext middleware, but apparently other middlewares\n  // reset it, so we will store those on our context and restore later\n  params: Request[\"params\"]\n  config: IGatsbyFunctionConfigProcessed\n  showDebugMessageInResponse: boolean\n}\n\ninterface IGatsbyInternalRequest extends Request {\n  context?: IGatsbyRequestContext\n}\n\ntype IGatsbyMiddleware = (\n  req: IGatsbyInternalRequest,\n  res: Response,\n  next: NextFunction\n) => Promise<void> | void\n\ninterface ICreateMiddlewareConfig {\n  getFunctions: () => Array<IGatsbyFunction>\n  prepareFn?: (functionObj: IGatsbyFunction) => Promise<void> | void\n  showDebugMessageInResponse?: boolean\n}\n\nfunction createSetContextFunctionMiddleware({\n  getFunctions,\n  prepareFn,\n  showDebugMessageInResponse,\n}: ICreateMiddlewareConfig): IGatsbyMiddleware {\n  return async function executeFunction(\n    req: IGatsbyInternalRequest,\n    res: Response,\n    next: NextFunction\n  ): Promise<void> {\n    const functions = getFunctions()\n    const { \"0\": pathFragment } = req.params\n\n    // Check first for exact matches.\n    let functionObj = functions.find(\n      ({ functionRoute }) => functionRoute === pathFragment\n    )\n\n    if (!functionObj) {\n      // Check if there's any matchPaths that match.\n      // We loop until we find the first match.\n      functions.some(f => {\n        if (f.matchPath) {\n          const matchResult = reachMatch(f.matchPath, pathFragment)\n          if (matchResult) {\n            req.params = matchResult.params\n            if (req.params[`*`]) {\n              // Backwards compatability for v3\n              // TODO remove in v5\n              req.params[`0`] = req.params[`*`]\n            }\n            functionObj = f\n\n            return true\n          }\n        }\n\n        return false\n      })\n    }\n\n    if (functionObj) {\n      let userConfig\n      if (prepareFn) {\n        await prepareFn(functionObj)\n      }\n\n      const pathToFunction = functionObj.absoluteCompiledFilePath\n      let fnToExecute\n      try {\n        delete require.cache[require.resolve(pathToFunction)]\n        const fn = require(pathToFunction)\n        userConfig = fn?.config\n\n        fnToExecute = (fn && fn.default) || fn\n      } catch (e) {\n        if (e?.message?.includes(`fnToExecute is not a function`)) {\n          e.message = `${functionObj.originalAbsoluteFilePath} does not export a function.`\n        }\n\n        fnToExecute = undefined\n        reporter.error(e)\n        if (!res.headersSent) {\n          if (showDebugMessageInResponse) {\n            res\n              .status(500)\n              .send(\n                `Error when executing function \"${functionObj.originalAbsoluteFilePath}\":<br /><br />${e.message}`\n              )\n          } else {\n            res.sendStatus(500)\n          }\n        }\n        return\n      }\n\n      if (fnToExecute) {\n        req.context = {\n          functionObj,\n          fnToExecute,\n          params: req.params,\n          config: createConfig(userConfig, functionObj),\n          showDebugMessageInResponse: showDebugMessageInResponse ?? false,\n        }\n      }\n    }\n\n    next()\n  }\n}\n\nfunction setCookies(\n  req: IGatsbyInternalRequest,\n  _res: Response,\n  next: NextFunction\n): void {\n  const cookies = req.headers.cookie\n\n  if (!cookies) {\n    return next()\n  }\n\n  req.cookies = cookie.parse(cookies)\n\n  return next()\n}\n\nfunction bodyParserMiddlewareWithConfig(\n  type: keyof IGatsbyBodyParserConfigProcessed\n): IGatsbyMiddleware {\n  return function (\n    req: IGatsbyInternalRequest,\n    res: Response,\n    next: NextFunction\n  ): void {\n    if (req.context && req.context.config.bodyParser) {\n      const bodyParserConfig = req.context.config.bodyParser[type]\n      expressBuiltinMiddleware[type](bodyParserConfig)(req, res, next)\n    } else {\n      next()\n    }\n  }\n}\n\nasync function executeFunction(\n  req: IGatsbyInternalRequest,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  if (req.context) {\n    reporter.verbose(`Running ${req.context.functionObj.functionRoute}`)\n    req.params = req.context.params\n    const start = Date.now()\n    const context = req.context\n    // we don't want to leak internal context to actual request handler\n    delete req.context\n    try {\n      await Promise.resolve(context.fnToExecute(req, res))\n    } catch (e) {\n      if (e?.message?.includes(`fnToExecute is not a function`)) {\n        e.message = `${context.functionObj.originalAbsoluteFilePath} does not export a function.`\n      }\n\n      reporter.error(e)\n      // Don't send the error if that would cause another error.\n      if (!res.headersSent) {\n        if (context.showDebugMessageInResponse) {\n          res\n            .status(500)\n            .send(\n              `Error when executing function \"${context.functionObj.originalAbsoluteFilePath}\":<br /><br />${e.message}`\n            )\n        } else {\n          res.sendStatus(500)\n        }\n      }\n    }\n\n    const end = Date.now()\n    reporter.log(\n      `Executed function \"/api/${context.functionObj.functionRoute}\" in ${\n        end - start\n      }ms`\n    )\n  } else {\n    next()\n  }\n}\n\nexport function functionMiddlewares(\n  middlewareConfig: ICreateMiddlewareConfig\n): Array<RequestHandler> {\n  const setContext = createSetContextFunctionMiddleware(middlewareConfig)\n\n  return [\n    setCookies,\n    setContext,\n    multer().any(),\n    bodyParserMiddlewareWithConfig(`raw`),\n    bodyParserMiddlewareWithConfig(`text`),\n    bodyParserMiddlewareWithConfig(`urlencoded`),\n    bodyParserMiddlewareWithConfig(`json`),\n    executeFunction,\n  ]\n}\n"],"mappings":"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"}