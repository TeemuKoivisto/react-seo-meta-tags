{"version":3,"file":"corejs-resolver.js","names":["coreJs2FileRegex","replaceMap","CoreJSResolver","constructor","_coreJSNodeModulesPath","path","dirname","require","resolve","apply","resolver","target","ensureHook","coreJsModulePath","request","resolveContext","callback","innerRequest","startsWith","coreJsRequest","resolveMessage","test","forEach","search","replace","doResolve","err","result","undefined","getHook","tapAsync"],"sources":["../../../../src/utils/webpack/plugins/corejs-resolver.ts"],"sourcesContent":["import Resolver from \"enhanced-resolve/lib/Resolver\"\nimport path from \"path\"\n\n// Core-js uses es6, es7 & web prefixes, which we'll convert to core-js 3\nconst coreJs2FileRegex = /\\/modules\\/(es6|es7|web)\\.|\\/es6\\/|\\/es7\\//\n\n// Try to replace core-js2 files to core-js@3 to reduce file size\nconst replaceMap = [\n  [`/es6.`, `/es.`],\n  [`/es7.`, `/es.`],\n  [`/es6/`, `/es/`],\n  [`/es7/`, `/es/`],\n  [`/es7/`, `/es/`],\n  [`web.dom.iterable`, `web.dom-collections.iterator.js`],\n  [`typed.data-view`, `data-view`],\n  [`regexp.match`, `string.match`],\n  [`regexp.replace`, `string.replace`],\n  [`regexp.search`, `string.search`],\n  [`regexp.split`, `string.split`],\n]\n\ninterface IRequest {\n  request?: string\n  path: string\n}\n\n/**\n * Babel-preset is set to corejs@3 which will add automatic polyfills. If a project has core-js@2 installed in their root or a package got compiled with core-js@2\n * we need to convert it to corejs@3 because core-js@2 isn't available or we might add multiple polyfills for the same problem.\n *\n * The resolver converts core-js@2 imports to core-js@3 imports to make our bundle as small as possible.\n */\nexport class CoreJSResolver {\n  _coreJSNodeModulesPath: string\n\n  constructor() {\n    // Get the nodemodules directory where core-js of gatsby lives\n    // it might be inside gatsby/node_modules when multiple core-js versions are loaded\n    this._coreJSNodeModulesPath = path.dirname(\n      path.dirname(require.resolve(`core-js`))\n    )\n  }\n\n  apply(resolver: Resolver): void {\n    const target = resolver.ensureHook(`resolve`)\n    const coreJsModulePath = this._coreJSNodeModulesPath\n\n    function resolve(\n      request: IRequest,\n      resolveContext: unknown,\n      callback: (err?: Error | null, result?: unknown) => void\n    ): void {\n      const innerRequest = request.request || request.path\n\n      // we only care about core-js\n      if (!innerRequest || !innerRequest.startsWith(`core-js/`)) {\n        return void callback()\n      }\n\n      let coreJsRequest = innerRequest\n      let resolveMessage = `alias core-js@3 to gatsby's core-js package`\n\n      // preset-env adds packages from modules/ so we rewrite them to our gatsby package\n      if (coreJs2FileRegex.test(coreJsRequest)) {\n        replaceMap.forEach(([search, replace]) => {\n          coreJsRequest = coreJsRequest.replace(search, replace)\n        })\n\n        resolveMessage = `map core-js@2(${innerRequest}) to corejs@3(${coreJsRequest})`\n      }\n\n      return void resolver.doResolve(\n        target,\n        {\n          ...request,\n          request: path.resolve(coreJsModulePath, coreJsRequest),\n        },\n        resolveMessage,\n        resolveContext,\n        (err, result) => {\n          if (err) {\n            return callback(err)\n          }\n\n          // if a rename fails we try to load the original file\n          // this could error when our mapping isn't complete. I've tested this on a couple of sites\n          // and couldn't find anything but you never know.\n          if (result === undefined) {\n            return callback()\n          }\n\n          return callback(null, result)\n        }\n      )\n    }\n\n    resolver.getHook(`described-resolve`).tapAsync(`CoreJSResolver`, resolve)\n    resolver.getHook(`file`).tapAsync(`CoreJSResolver`, resolve)\n  }\n}\n"],"mappings":";;;;;AACA;AAEA;AACA,MAAMA,gBAAgB,GAAG,4CAA4C;;AAErE;AACA,MAAMC,UAAU,GAAG,CACjB,CAAE,OAAM,EAAG,MAAK,CAAC,EACjB,CAAE,OAAM,EAAG,MAAK,CAAC,EACjB,CAAE,OAAM,EAAG,MAAK,CAAC,EACjB,CAAE,OAAM,EAAG,MAAK,CAAC,EACjB,CAAE,OAAM,EAAG,MAAK,CAAC,EACjB,CAAE,kBAAiB,EAAG,iCAAgC,CAAC,EACvD,CAAE,iBAAgB,EAAG,WAAU,CAAC,EAChC,CAAE,cAAa,EAAG,cAAa,CAAC,EAChC,CAAE,gBAAe,EAAG,gBAAe,CAAC,EACpC,CAAE,eAAc,EAAG,eAAc,CAAC,EAClC,CAAE,cAAa,EAAG,cAAa,CAAC,CACjC;AAOD;AACA;AACA;AACA;AACA;AACA;AACO,MAAMC,cAAc,CAAC;EAG1BC,WAAW,GAAG;IACZ;IACA;IACA,IAAI,CAACC,sBAAsB,GAAGC,aAAI,CAACC,OAAO,CACxCD,aAAI,CAACC,OAAO,CAACC,OAAO,CAACC,OAAO,CAAE,SAAQ,CAAC,CAAC,CACzC;EACH;EAEAC,KAAK,CAACC,QAAkB,EAAQ;IAC9B,MAAMC,MAAM,GAAGD,QAAQ,CAACE,UAAU,CAAE,SAAQ,CAAC;IAC7C,MAAMC,gBAAgB,GAAG,IAAI,CAACT,sBAAsB;IAEpD,SAASI,OAAO,CACdM,OAAiB,EACjBC,cAAuB,EACvBC,QAAwD,EAClD;MACN,MAAMC,YAAY,GAAGH,OAAO,CAACA,OAAO,IAAIA,OAAO,CAACT,IAAI;;MAEpD;MACA,IAAI,CAACY,YAAY,IAAI,CAACA,YAAY,CAACC,UAAU,CAAE,UAAS,CAAC,EAAE;QACzD,OAAO,KAAKF,QAAQ,EAAE;MACxB;MAEA,IAAIG,aAAa,GAAGF,YAAY;MAChC,IAAIG,cAAc,GAAI,6CAA4C;;MAElE;MACA,IAAIpB,gBAAgB,CAACqB,IAAI,CAACF,aAAa,CAAC,EAAE;QACxClB,UAAU,CAACqB,OAAO,CAAC,CAAC,CAACC,MAAM,EAAEC,OAAO,CAAC,KAAK;UACxCL,aAAa,GAAGA,aAAa,CAACK,OAAO,CAACD,MAAM,EAAEC,OAAO,CAAC;QACxD,CAAC,CAAC;QAEFJ,cAAc,GAAI,iBAAgBH,YAAa,iBAAgBE,aAAc,GAAE;MACjF;MAEA,OAAO,KAAKT,QAAQ,CAACe,SAAS,CAC5Bd,MAAM,EACN;QACE,GAAGG,OAAO;QACVA,OAAO,EAAET,aAAI,CAACG,OAAO,CAACK,gBAAgB,EAAEM,aAAa;MACvD,CAAC,EACDC,cAAc,EACdL,cAAc,EACd,CAACW,GAAG,EAAEC,MAAM,KAAK;QACf,IAAID,GAAG,EAAE;UACP,OAAOV,QAAQ,CAACU,GAAG,CAAC;QACtB;;QAEA;QACA;QACA;QACA,IAAIC,MAAM,KAAKC,SAAS,EAAE;UACxB,OAAOZ,QAAQ,EAAE;QACnB;QAEA,OAAOA,QAAQ,CAAC,IAAI,EAAEW,MAAM,CAAC;MAC/B,CAAC,CACF;IACH;IAEAjB,QAAQ,CAACmB,OAAO,CAAE,mBAAkB,CAAC,CAACC,QAAQ,CAAE,gBAAe,EAAEtB,OAAO,CAAC;IACzEE,QAAQ,CAACmB,OAAO,CAAE,MAAK,CAAC,CAACC,QAAQ,CAAE,gBAAe,EAAEtB,OAAO,CAAC;EAC9D;AACF;AAAC"}