{"version":3,"file":"webpack-error-utils.js","names":["stageCodeToReadableLabel","StageEnum","BuildJavascript","BuildHTML","DevelopHTML","Develop","transformWebpackError","stage","webpackError","castedWebpackError","location","loc","start","end","error","matches","message","match","line","Number","column","id","context","stageLabel","sourceMessage","name","packageName","BreakingChangeRegex","test","breakingMatch","deprecationReason","filePath","module","resource","file","removeResourceQuery","moduleName","moduleNameWithoutQuery","replace","structureWebpackErrors","Array","isArray","map","e","reportWebpackWarnings","warnings","reporter","warningMessages","warning","formatWebpackMessages","errors","forEach","warn"],"sources":["../../src/utils/webpack-error-utils.ts"],"sourcesContent":["import { Reporter } from \"gatsby-cli/lib/reporter/reporter\"\nimport { WebpackError, StatsCompilation, Module, NormalModule } from \"webpack\"\nimport { Stage as StageEnum } from \"../commands/types\"\nimport formatWebpackMessages from \"react-dev-utils/formatWebpackMessages\"\n\nconst stageCodeToReadableLabel: Record<StageEnum, string> = {\n  [StageEnum.BuildJavascript]: `Generating JavaScript bundles`,\n  [StageEnum.BuildHTML]: `Generating SSR bundle`,\n  [StageEnum.DevelopHTML]: `Generating development SSR bundle`,\n  [StageEnum.Develop]: `Generating development JavaScript bundle`,\n}\n\ninterface IFileLocation {\n  line: number\n  column: number\n}\n\ninterface IWebpackError {\n  name: string\n  message: string\n  file?: string\n  error?: {\n    message: string\n    loc?: {\n      start: IFileLocation\n      end: IFileLocation\n    }\n  }\n  module: Module\n  loc?: {\n    start: IFileLocation\n    end: IFileLocation\n  }\n}\n\ninterface ITransformedWebpackError {\n  id: string\n  filePath: string\n  location?: {\n    start: IFileLocation\n    end: IFileLocation\n  }\n  context: {\n    stage: StageEnum\n    stageLabel: string\n    sourceMessage?: string\n    [key: string]: unknown\n  }\n}\n\nconst transformWebpackError = (\n  stage: StageEnum,\n  webpackError: WebpackError\n): ITransformedWebpackError => {\n  const castedWebpackError = webpackError as unknown as IWebpackError\n\n  let location\n  if (castedWebpackError.loc && castedWebpackError.loc.start) {\n    location = {\n      start: castedWebpackError.loc.start,\n      end: castedWebpackError.loc.end,\n    }\n  }\n\n  if (!location && castedWebpackError.error?.loc) {\n    if (castedWebpackError.error.loc.start) {\n      location = castedWebpackError.error.loc\n    } else {\n      location = {\n        start: castedWebpackError.error.loc,\n      }\n    }\n  }\n\n  // try to get location out of stacktrace\n  if (!location) {\n    const matches = castedWebpackError.message.match(/\\((\\d+):(\\d+)\\)/)\n    if (matches && matches[1] && matches[2]) {\n      location = {\n        start: {\n          line: Number(matches[1]),\n          column: Number(matches[2]),\n        },\n      }\n    }\n  }\n\n  let id = `98123`\n  const context: ITransformedWebpackError[\"context\"] = {\n    stage,\n    stageLabel: stageCodeToReadableLabel[stage],\n    // TODO use formatWebpackMessages like in warnings\n    sourceMessage:\n      castedWebpackError.error?.message ?? castedWebpackError.message,\n  }\n\n  // When a module cannot be found we can short circuit\n  if (castedWebpackError.name === `ModuleNotFoundError`) {\n    const matches =\n      castedWebpackError.error?.message.match(\n        /Can't resolve '(.*?)' in '(.*?)'/m\n      ) ?? []\n\n    id = `98124`\n    context.packageName = matches?.[1]\n    context.sourceMessage = matches?.[0]\n\n    // get Breaking change message out of error\n    // it shows extra information for things that changed with webpack\n    const BreakingChangeRegex = /BREAKING CHANGE[\\D\\n\\d]+$/\n    if (BreakingChangeRegex.test(castedWebpackError.message)) {\n      const breakingMatch =\n        castedWebpackError.message.match(BreakingChangeRegex)\n\n      context.deprecationReason = breakingMatch?.[0]\n    }\n  }\n\n  return {\n    id,\n    filePath:\n      (castedWebpackError?.module as NormalModule)?.resource ??\n      castedWebpackError.file,\n    location,\n    context,\n    // We use original error to display stack trace for the most part.\n    // In case of webpack error stack will include internals of webpack\n    // or one of loaders (for example babel-loader) and doesn't provide\n    // much value to user, so it's purposely omitted.\n\n    // error: webpackError?.error || webpackError,\n  }\n}\n\n// With the introduction of Head API, the modulePath can have a resourceQuery so this function can be used to remove it\nconst removeResourceQuery = (\n  moduleName: string | undefined\n): string | undefined => {\n  const moduleNameWithoutQuery = moduleName?.replace(\n    /(\\?|&)export=(default|head)$/,\n    ``\n  )\n\n  return moduleNameWithoutQuery\n}\n\nexport const structureWebpackErrors = (\n  stage: StageEnum,\n  webpackError: WebpackError | Array<WebpackError>\n): Array<ITransformedWebpackError> | ITransformedWebpackError => {\n  if (Array.isArray(webpackError)) {\n    return webpackError.map(e => transformWebpackError(stage, e))\n  }\n\n  return transformWebpackError(stage, webpackError)\n}\n\nexport const reportWebpackWarnings = (\n  warnings: StatsCompilation[\"warnings\"] = [],\n  reporter: Reporter\n): void => {\n  let warningMessages: Array<string> = []\n  if (typeof warnings[0] === `string`) {\n    warningMessages = warnings as unknown as Array<string>\n  } else if (\n    warnings[0]?.message &&\n    removeResourceQuery(warnings[0]?.moduleName)\n  ) {\n    warningMessages = warnings.map(\n      warning =>\n        `${removeResourceQuery(warning.moduleName)}\\n\\n${warning.message}`\n    )\n  } else if (warnings[0]?.message) {\n    warningMessages = warnings.map(warning => warning.message)\n  }\n\n  formatWebpackMessages({\n    errors: [],\n    warnings: warningMessages,\n  }).warnings.forEach(warning => reporter.warn(warning))\n}\n"],"mappings":"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"}