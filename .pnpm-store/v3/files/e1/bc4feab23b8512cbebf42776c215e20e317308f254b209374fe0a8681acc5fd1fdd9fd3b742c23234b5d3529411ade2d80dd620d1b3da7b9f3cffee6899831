{"version":3,"file":"babel-loader-helpers.js","names":["loadCachedConfig","pluginBabelConfig","stages","test","plugins","presets","process","env","NODE_ENV","require","path","join","cwd","getCustomOptions","stage","options","configItemsMemoCache","Map","prepareOptions","babel","customOptions","resolve","reactRuntime","reactImportSource","isPageTemplate","resourceQuery","configItemsMemoCacheKey","has","get","requiredPlugins","createConfigItem","staticQueryDir","type","apis","includes","push","requiredPresets","fallbackPresets","reduxPlugins","reduxPresets","forEach","plugin","name","dirname","preset","toReturn","set","addRequiredPresetOptions","gatsbyPresetResolved","index","findIndex","p","file","resolved","mergeConfigItemOptions","items","itemToMerge","i"],"sources":["../../src/utils/babel-loader-helpers.ts"],"sourcesContent":["import path from \"path\"\nimport _ from \"lodash\"\nimport Babel, {\n  ConfigItem,\n  PluginItem,\n  CreateConfigItemOptions,\n} from \"@babel/core\"\n\nimport { IBabelStage } from \"../redux/types\"\nimport { Stage } from \"../commands/types\"\n\ninterface ILoadCachedConfigReturnType {\n  stages: {\n    test: IBabelStage\n  }\n}\n\nconst loadCachedConfig = (): ILoadCachedConfigReturnType => {\n  let pluginBabelConfig = {\n    stages: {\n      test: { plugins: [], presets: [] },\n    },\n  }\n  if (process.env.NODE_ENV !== `test`) {\n    pluginBabelConfig = require(path.join(\n      process.cwd(),\n      `./.cache/babelState.json`\n    ))\n  }\n  return pluginBabelConfig\n}\n\nexport const getCustomOptions = (stage: Stage): IBabelStage[\"options\"] => {\n  const pluginBabelConfig = loadCachedConfig()\n  return pluginBabelConfig.stages[stage].options\n}\n\n/**\n * https://babeljs.io/docs/en/babel-core#createconfigitem\n * If this function is called multiple times for a given plugin,\n * Babel will call the plugin's function itself multiple times.\n * If you have a clear set of expected plugins and presets to inject,\n * pre-constructing the config items would be recommended.\n */\nconst configItemsMemoCache = new Map()\n\nexport interface ICustomOptions extends Record<string, unknown> {\n  stage: Stage\n  resourceQuery: string\n}\n\nexport const prepareOptions = (\n  babel: typeof Babel,\n  customOptions: ICustomOptions,\n  resolve: RequireResolve = require.resolve\n): Array<Array<PluginItem>> => {\n  const {\n    stage,\n    reactRuntime,\n    reactImportSource,\n    isPageTemplate,\n    resourceQuery,\n  } = customOptions\n\n  const configItemsMemoCacheKey = `${stage}-${isPageTemplate}-${resourceQuery}`\n\n  if (configItemsMemoCache.has(configItemsMemoCacheKey)) {\n    return configItemsMemoCache.get(configItemsMemoCacheKey)\n  }\n\n  const pluginBabelConfig = loadCachedConfig()\n\n  // Required plugins/presets\n  const requiredPlugins = [\n    babel.createConfigItem(\n      [\n        resolve(`babel-plugin-remove-graphql-queries`),\n        { stage, staticQueryDir: `page-data/sq/d` },\n      ],\n      {\n        type: `plugin`,\n      }\n    ),\n  ]\n\n  if ((stage === `develop` || stage === `build-javascript`) && isPageTemplate) {\n    const apis = [`getServerData`, `config`]\n\n    if (\n      resourceQuery.includes(`?export=default`) ||\n      resourceQuery.includes(`&export=default`)\n    ) {\n      apis.push(`Head`)\n    }\n\n    if (\n      resourceQuery.includes(`?export=head`) ||\n      resourceQuery.includes(`&export=head`)\n    ) {\n      apis.push(`default`)\n    }\n\n    requiredPlugins.push(\n      babel.createConfigItem(\n        [\n          resolve(`./babel/babel-plugin-remove-api`),\n          {\n            apis,\n          },\n        ],\n        {\n          type: `plugin`,\n        }\n      )\n    )\n  }\n\n  if (\n    stage === `develop` ||\n    stage === `build-html` ||\n    stage === `develop-html`\n  ) {\n    requiredPlugins.push(\n      babel.createConfigItem(\n        [resolve(`./babel/babel-plugin-add-slice-placeholder-location`)],\n        {\n          type: `plugin`,\n        }\n      )\n    )\n  }\n\n  const requiredPresets: Array<PluginItem> = []\n\n  if (stage === `develop`) {\n    requiredPlugins.push(\n      babel.createConfigItem([resolve(`react-refresh/babel`)], {\n        type: `plugin`,\n      })\n    )\n  }\n\n  // Fallback preset\n  const fallbackPresets: Array<ConfigItem> = []\n\n  fallbackPresets.push(\n    babel.createConfigItem(\n      [\n        resolve(`babel-preset-gatsby`),\n        {\n          stage,\n          reactRuntime,\n          reactImportSource,\n        },\n      ],\n      {\n        type: `preset`,\n      }\n    )\n  )\n\n  // Go through babel state and create config items for presets/plugins from.\n  const reduxPlugins: Array<PluginItem> = []\n  const reduxPresets: Array<PluginItem> = []\n\n  if (stage) {\n    pluginBabelConfig.stages[stage].plugins.forEach(plugin => {\n      reduxPlugins.push(\n        babel.createConfigItem([resolve(plugin.name), plugin.options], {\n          dirname: plugin.name,\n          type: `plugin`,\n        })\n      )\n    })\n    pluginBabelConfig.stages[stage].presets.forEach(preset => {\n      reduxPresets.push(\n        babel.createConfigItem([resolve(preset.name), preset.options], {\n          dirname: preset.name,\n          type: `preset`,\n        })\n      )\n    })\n  }\n\n  const toReturn = [\n    reduxPresets,\n    reduxPlugins,\n    requiredPresets,\n    requiredPlugins,\n    fallbackPresets,\n  ]\n\n  configItemsMemoCache.set(configItemsMemoCacheKey, toReturn)\n\n  return toReturn\n}\n\nexport const addRequiredPresetOptions = (\n  babel: typeof Babel,\n  presets: Array<ConfigItem>,\n  options: { stage?: Stage } = {},\n  resolve: RequireResolve = require.resolve\n): Array<PluginItem> => {\n  // Always pass `stage` option to babel-preset-gatsby\n  //  (even if defined in custom babelrc)\n  const gatsbyPresetResolved = resolve(`babel-preset-gatsby`)\n  const index = presets.findIndex(\n    p => p.file!.resolved === gatsbyPresetResolved\n  )\n\n  if (index !== -1) {\n    presets[index] = babel.createConfigItem(\n      [\n        gatsbyPresetResolved,\n        { ...presets[index].options, stage: options.stage },\n      ],\n      { type: `preset` }\n    )\n  }\n  return presets\n}\n\nexport const mergeConfigItemOptions = ({\n  items,\n  itemToMerge,\n  type,\n  babel,\n}: {\n  items: Array<ConfigItem>\n  itemToMerge: ConfigItem\n  type: CreateConfigItemOptions[\"type\"]\n  babel: typeof Babel\n}): Array<ConfigItem> => {\n  const index = _.findIndex(\n    items,\n    i => i.file?.resolved === itemToMerge.file?.resolved\n  )\n\n  // If this exist, merge the options, otherwise, add it to the array\n  if (index !== -1) {\n    items[index] = babel.createConfigItem(\n      [\n        itemToMerge.file?.resolved,\n        _.merge({}, items[index].options, itemToMerge.options),\n      ],\n      {\n        type,\n      }\n    )\n  } else {\n    items.push(itemToMerge)\n  }\n\n  return items\n}\n"],"mappings":"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"}