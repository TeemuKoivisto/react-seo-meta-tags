{"version":3,"file":"gatsby-dependents.js","names":["getAllDependencies","pkg","Set","Object","entries","dependencies","devDependencies","optionalDependencies","readJSON","file","buffer","readFile","JSON","parse","toString","getTreeFromNodeModules","dir","results","Map","requireFromHere","createRequireFromPath","packageJSON","require","resolve","join","error","Promise","all","Array","from","map","name","version","currentDependency","path","dirname","test","has","set","values","getGatsbyDependents","program","store","getState","directory"],"sources":["../../src/utils/gatsby-dependents.ts"],"sourcesContent":["import { store } from \"../redux\"\nimport { memoize } from \"lodash\"\n\nimport { createRequireFromPath } from \"gatsby-core-utils\"\nimport { join, dirname } from \"path\"\nimport { PackageJson } from \"../..\"\nimport { readFile } from \"fs-extra\"\n\ninterface IDependency {\n  name: string\n  version: string\n  path: string\n}\n\nconst getAllDependencies = (pkg: PackageJson): Set<[string, string]> =>\n  new Set([\n    ...Object.entries(pkg.dependencies || {}),\n    ...Object.entries(pkg.devDependencies || {}),\n    ...Object.entries(pkg.optionalDependencies || {}),\n  ])\n\nconst readJSON = async (file: string): Promise<PackageJson> => {\n  const buffer = await readFile(file)\n  return JSON.parse(buffer.toString())\n}\n\nconst getTreeFromNodeModules = async (\n  dir: string,\n  results: Map<string, IDependency> = new Map()\n): Promise<Array<IDependency>> => {\n  const requireFromHere = createRequireFromPath(`${dir}/:internal:`)\n  let packageJSON: PackageJson\n  try {\n    packageJSON = await readJSON(require.resolve(join(dir, `package.json`)))\n  } catch (error) {\n    packageJSON = {}\n  }\n\n  await Promise.all(\n    Array.from(getAllDependencies(packageJSON)).map(async ([name, version]) => {\n      try {\n        const currentDependency: IDependency = {\n          name,\n          version,\n          path: dirname(requireFromHere.resolve(`${name}/package.json`)),\n        }\n\n        // Include anything that has `gatsby` in its name but not `gatsby` itself\n        if (\n          /gatsby/.test(currentDependency.name) &&\n          currentDependency.name !== `gatsby`\n        ) {\n          await getTreeFromNodeModules(currentDependency.path, results)\n          if (!results.has(currentDependency.name))\n            results.set(currentDependency.name, currentDependency)\n        }\n      } catch (error) {\n        // Sometimes dev dependencies of dependencies aren't installed\n        // when using `yarn`. This is okay and safe to ignore.\n      }\n    })\n  )\n\n  return Array.from(results.values())\n}\n\nexport const getGatsbyDependents = memoize(\n  async (): Promise<Array<IDependency>> => {\n    const { program } = store.getState()\n    return getTreeFromNodeModules(program.directory)\n  }\n)\n"],"mappings":";;;;;;AAAA;AAGA;AACA;AAEA;AAQA,MAAMA,kBAAkB,GAAIC,GAAgB,IAC1C,IAAIC,GAAG,CAAC,CACN,GAAGC,MAAM,CAACC,OAAO,CAACH,GAAG,CAACI,YAAY,IAAI,CAAC,CAAC,CAAC,EACzC,GAAGF,MAAM,CAACC,OAAO,CAACH,GAAG,CAACK,eAAe,IAAI,CAAC,CAAC,CAAC,EAC5C,GAAGH,MAAM,CAACC,OAAO,CAACH,GAAG,CAACM,oBAAoB,IAAI,CAAC,CAAC,CAAC,CAClD,CAAC;AAEJ,MAAMC,QAAQ,GAAG,MAAOC,IAAY,IAA2B;EAC7D,MAAMC,MAAM,GAAG,MAAM,IAAAC,iBAAQ,EAACF,IAAI,CAAC;EACnC,OAAOG,IAAI,CAACC,KAAK,CAACH,MAAM,CAACI,QAAQ,EAAE,CAAC;AACtC,CAAC;AAED,MAAMC,sBAAsB,GAAG,OAC7BC,GAAW,EACXC,OAAiC,GAAG,IAAIC,GAAG,EAAE,KACb;EAChC,MAAMC,eAAe,GAAG,IAAAC,sCAAqB,EAAE,GAAEJ,GAAI,aAAY,CAAC;EAClE,IAAIK,WAAwB;EAC5B,IAAI;IACFA,WAAW,GAAG,MAAMb,QAAQ,CAACc,OAAO,CAACC,OAAO,CAAC,IAAAC,UAAI,EAACR,GAAG,EAAG,cAAa,CAAC,CAAC,CAAC;EAC1E,CAAC,CAAC,OAAOS,KAAK,EAAE;IACdJ,WAAW,GAAG,CAAC,CAAC;EAClB;EAEA,MAAMK,OAAO,CAACC,GAAG,CACfC,KAAK,CAACC,IAAI,CAAC7B,kBAAkB,CAACqB,WAAW,CAAC,CAAC,CAACS,GAAG,CAAC,OAAO,CAACC,IAAI,EAAEC,OAAO,CAAC,KAAK;IACzE,IAAI;MACF,MAAMC,iBAA8B,GAAG;QACrCF,IAAI;QACJC,OAAO;QACPE,IAAI,EAAE,IAAAC,aAAO,EAAChB,eAAe,CAACI,OAAO,CAAE,GAAEQ,IAAK,eAAc,CAAC;MAC/D,CAAC;;MAED;MACA,IACE,QAAQ,CAACK,IAAI,CAACH,iBAAiB,CAACF,IAAI,CAAC,IACrCE,iBAAiB,CAACF,IAAI,KAAM,QAAO,EACnC;QACA,MAAMhB,sBAAsB,CAACkB,iBAAiB,CAACC,IAAI,EAAEjB,OAAO,CAAC;QAC7D,IAAI,CAACA,OAAO,CAACoB,GAAG,CAACJ,iBAAiB,CAACF,IAAI,CAAC,EACtCd,OAAO,CAACqB,GAAG,CAACL,iBAAiB,CAACF,IAAI,EAAEE,iBAAiB,CAAC;MAC1D;IACF,CAAC,CAAC,OAAOR,KAAK,EAAE;MACd;MACA;IAAA;EAEJ,CAAC,CAAC,CACH;EAED,OAAOG,KAAK,CAACC,IAAI,CAACZ,OAAO,CAACsB,MAAM,EAAE,CAAC;AACrC,CAAC;AAEM,MAAMC,mBAAmB,GAAG,uBACjC,YAAyC;EACvC,MAAM;IAAEC;EAAQ,CAAC,GAAGC,YAAK,CAACC,QAAQ,EAAE;EACpC,OAAO5B,sBAAsB,CAAC0B,OAAO,CAACG,SAAS,CAAC;AAClD,CAAC,CACF;AAAA"}