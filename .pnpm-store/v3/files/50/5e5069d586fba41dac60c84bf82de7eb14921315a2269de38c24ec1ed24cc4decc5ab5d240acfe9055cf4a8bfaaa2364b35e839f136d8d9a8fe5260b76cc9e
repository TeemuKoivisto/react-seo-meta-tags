{"version":3,"file":"cache-folder-resolver.js","names":["CacheFolderResolver","constructor","requestsFolder","apply","resolver","process","versions","pnp","target","ensureHook","getHook","tapAsync","request","resolveContext","callback","req","path","startsWith","packageMatch","exec","obj","__dirname","doResolve"],"sources":["../../../../src/utils/webpack/plugins/cache-folder-resolver.ts"],"sourcesContent":["import Resolver from \"enhanced-resolve/lib/Resolver\"\n\ninterface IRequest {\n  request?: string\n  path: string\n}\n\ntype ProcessWithPNP = NodeJS.ProcessVersions & { pnp?: string }\n\n/**\n * To support PNP we have to make sure dependencies resolved from the .cache folder should be resolved from the gatsby package directory\n */\nexport class CacheFolderResolver {\n  private requestsFolder: string\n\n  constructor(requestsFolder: string) {\n    this.requestsFolder = requestsFolder\n  }\n\n  apply(resolver: Resolver): void {\n    if (!(process.versions as ProcessWithPNP).pnp) {\n      return\n    }\n\n    const target = resolver.ensureHook(`raw-module`)\n    resolver\n      .getHook(`raw-module`)\n      .tapAsync(\n        `CacheFolderResolver`,\n        (\n          request: IRequest,\n          resolveContext: unknown,\n          callback: (err?: Error | null, result?: unknown) => void\n        ) => {\n          const req = request.request\n          if (!req) {\n            return callback()\n          }\n\n          if (!request.path.startsWith(this.requestsFolder)) {\n            return callback()\n          }\n\n          const packageMatch = /^(@[^/]+\\/)?[^/]+/.exec(req)\n          if (!packageMatch) {\n            return callback()\n          }\n\n          // We change the issuer but keep everything as is and re-run resolve\n          const obj = {\n            ...request,\n            path: __dirname,\n          }\n\n          return resolver.doResolve(\n            target,\n            obj,\n            `change issuer to gatsby package by cache-folder-resolver to fix pnp`,\n            resolveContext,\n            callback\n          )\n        }\n      )\n  }\n}\n"],"mappings":";;;;AASA;AACA;AACA;AACO,MAAMA,mBAAmB,CAAC;EAG/BC,WAAW,CAACC,cAAsB,EAAE;IAClC,IAAI,CAACA,cAAc,GAAGA,cAAc;EACtC;EAEAC,KAAK,CAACC,QAAkB,EAAQ;IAC9B,IAAI,CAAEC,OAAO,CAACC,QAAQ,CAAoBC,GAAG,EAAE;MAC7C;IACF;IAEA,MAAMC,MAAM,GAAGJ,QAAQ,CAACK,UAAU,CAAE,YAAW,CAAC;IAChDL,QAAQ,CACLM,OAAO,CAAE,YAAW,CAAC,CACrBC,QAAQ,CACN,qBAAoB,EACrB,CACEC,OAAiB,EACjBC,cAAuB,EACvBC,QAAwD,KACrD;MACH,MAAMC,GAAG,GAAGH,OAAO,CAACA,OAAO;MAC3B,IAAI,CAACG,GAAG,EAAE;QACR,OAAOD,QAAQ,EAAE;MACnB;MAEA,IAAI,CAACF,OAAO,CAACI,IAAI,CAACC,UAAU,CAAC,IAAI,CAACf,cAAc,CAAC,EAAE;QACjD,OAAOY,QAAQ,EAAE;MACnB;MAEA,MAAMI,YAAY,GAAG,mBAAmB,CAACC,IAAI,CAACJ,GAAG,CAAC;MAClD,IAAI,CAACG,YAAY,EAAE;QACjB,OAAOJ,QAAQ,EAAE;MACnB;;MAEA;MACA,MAAMM,GAAG,GAAG;QACV,GAAGR,OAAO;QACVI,IAAI,EAAEK;MACR,CAAC;MAED,OAAOjB,QAAQ,CAACkB,SAAS,CACvBd,MAAM,EACNY,GAAG,EACF,qEAAoE,EACrEP,cAAc,EACdC,QAAQ,CACT;IACH,CAAC,CACF;EACL;AACF;AAAC"}