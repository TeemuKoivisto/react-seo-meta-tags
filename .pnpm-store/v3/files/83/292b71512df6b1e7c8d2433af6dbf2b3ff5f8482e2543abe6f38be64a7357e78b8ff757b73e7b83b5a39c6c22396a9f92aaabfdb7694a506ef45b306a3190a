{"version":3,"file":"tracking-unsafe-module-wrapper.js","names":["global","unsafeBuiltinUsage","createProxyHandler","prefix","options","get","target","key","value","path","toString","ignore","includes","fieldDescriptor","Object","getOwnPropertyDescriptor","writable","wrapper","args","myErrorHolder","name","Error","captureStackTrace","stack","push","apply","Proxy","wrapModuleWithTracking","moduleName","mod","require","exports"],"sources":["../../ssr-builtin-trackers/tracking-unsafe-module-wrapper.js"],"sourcesContent":["// initializing global here for unsafe builtin usage at import time\nglobal.unsafeBuiltinUsage = []\n\nfunction createProxyHandler(prefix, options) {\n  return {\n    get: function (target, key) {\n      const value = target[key]\n      const path = key && key.toString ? `${prefix}.${key.toString()}` : prefix\n\n      if (options.ignore.includes(path)) {\n        return value\n      }\n\n      const fieldDescriptor = Object.getOwnPropertyDescriptor(target, key)\n      if (fieldDescriptor && !fieldDescriptor.writable) {\n        // this is to prevent errors like:\n        // ```\n        // TypeError: 'get' on proxy: property 'constants' is a read - only and\n        // non - configurable data property on the proxy target but the proxy\n        // did not return its actual value\n        // (expected '[object Object]' but got '[object Object]')\n        // ```\n        return value\n      }\n\n      if (typeof value === `function`) {\n        return function wrapper(...args) {\n          const myErrorHolder = {\n            name: `Unsafe builtin usage ${path}`,\n          }\n          Error.captureStackTrace(myErrorHolder, wrapper)\n\n          // - loadPageDataSync already is tracked with dedicated warning messages,\n          // so skipping marking it to avoid multiple messages for same usage\n          // - node-gyp-build will use fs.readDirSync in attempt to load binaries\n          // this should be ok to ignore.\n          if (\n            !myErrorHolder.stack.includes(`loadPageDataSync`) &&\n            !myErrorHolder.stack.includes(`node-gyp-build`)\n          ) {\n            global.unsafeBuiltinUsage.push(myErrorHolder.stack)\n          }\n\n          return value.apply(target, args)\n        }\n      } else if (typeof value === `object` && value !== null) {\n        return new Proxy(value, createProxyHandler(path, options))\n      }\n\n      return value\n    },\n  }\n}\n\nfunction wrapModuleWithTracking(moduleName, options = {}) {\n  if (!options.ignore) {\n    options.ignore = []\n  }\n\n  const mod = require(moduleName)\n  return new Proxy(mod, createProxyHandler(moduleName, options))\n}\n\nexports.wrapModuleWithTracking = wrapModuleWithTracking\n"],"mappings":";;AAAA;AACAA,MAAM,CAACC,kBAAkB,GAAG,EAAE;AAE9B,SAASC,kBAAkB,CAACC,MAAM,EAAEC,OAAO,EAAE;EAC3C,OAAO;IACLC,GAAG,EAAE,UAAUC,MAAM,EAAEC,GAAG,EAAE;MAC1B,MAAMC,KAAK,GAAGF,MAAM,CAACC,GAAG,CAAC;MACzB,MAAME,IAAI,GAAGF,GAAG,IAAIA,GAAG,CAACG,QAAQ,GAAI,GAAEP,MAAO,IAAGI,GAAG,CAACG,QAAQ,EAAG,EAAC,GAAGP,MAAM;MAEzE,IAAIC,OAAO,CAACO,MAAM,CAACC,QAAQ,CAACH,IAAI,CAAC,EAAE;QACjC,OAAOD,KAAK;MACd;MAEA,MAAMK,eAAe,GAAGC,MAAM,CAACC,wBAAwB,CAACT,MAAM,EAAEC,GAAG,CAAC;MACpE,IAAIM,eAAe,IAAI,CAACA,eAAe,CAACG,QAAQ,EAAE;QAChD;QACA;QACA;QACA;QACA;QACA;QACA;QACA,OAAOR,KAAK;MACd;MAEA,IAAI,OAAOA,KAAK,KAAM,UAAS,EAAE;QAC/B,OAAO,SAASS,OAAO,CAAC,GAAGC,IAAI,EAAE;UAC/B,MAAMC,aAAa,GAAG;YACpBC,IAAI,EAAG,wBAAuBX,IAAK;UACrC,CAAC;UACDY,KAAK,CAACC,iBAAiB,CAACH,aAAa,EAAEF,OAAO,CAAC;;UAE/C;UACA;UACA;UACA;UACA,IACE,CAACE,aAAa,CAACI,KAAK,CAACX,QAAQ,CAAE,kBAAiB,CAAC,IACjD,CAACO,aAAa,CAACI,KAAK,CAACX,QAAQ,CAAE,gBAAe,CAAC,EAC/C;YACAZ,MAAM,CAACC,kBAAkB,CAACuB,IAAI,CAACL,aAAa,CAACI,KAAK,CAAC;UACrD;UAEA,OAAOf,KAAK,CAACiB,KAAK,CAACnB,MAAM,EAAEY,IAAI,CAAC;QAClC,CAAC;MACH,CAAC,MAAM,IAAI,OAAOV,KAAK,KAAM,QAAO,IAAIA,KAAK,KAAK,IAAI,EAAE;QACtD,OAAO,IAAIkB,KAAK,CAAClB,KAAK,EAAEN,kBAAkB,CAACO,IAAI,EAAEL,OAAO,CAAC,CAAC;MAC5D;MAEA,OAAOI,KAAK;IACd;EACF,CAAC;AACH;AAEA,SAASmB,sBAAsB,CAACC,UAAU,EAAExB,OAAO,GAAG,CAAC,CAAC,EAAE;EACxD,IAAI,CAACA,OAAO,CAACO,MAAM,EAAE;IACnBP,OAAO,CAACO,MAAM,GAAG,EAAE;EACrB;EAEA,MAAMkB,GAAG,GAAGC,OAAO,CAACF,UAAU,CAAC;EAC/B,OAAO,IAAIF,KAAK,CAACG,GAAG,EAAE3B,kBAAkB,CAAC0B,UAAU,EAAExB,OAAO,CAAC,CAAC;AAChE;AAEA2B,OAAO,CAACJ,sBAAsB,GAAGA,sBAAsB"}