{"version":3,"file":"index.js","names":["tracer","globalTracer","bootstrap","initialContext","spanArgs","parentSpan","childOf","startSpan","bootstrapContext","shouldRunCreatePagesStatefully","context","initialize","workerPool","program","store","getState","directory","slash","all","loadConfigAndPlugins","siteDirectory","customizeSchema","sourceNodes","buildSchema","gatsbyNodeGraphQLFunction","createGraphQLRunner","reporter","createPages","handleStalePageData","savePartialStateToDisk","extractQueries","writeOutRedirects","startRedirectListener","postBootstrap","finish"],"sources":["../../src/bootstrap/index.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\nimport { slash } from \"gatsby-core-utils\"\nimport { startRedirectListener } from \"./redirects-writer\"\nimport {\n  IBuildContext,\n  initialize,\n  customizeSchema,\n  sourceNodes,\n  buildSchema,\n  createPages,\n  extractQueries,\n  writeOutRedirects,\n  postBootstrap,\n} from \"../services\"\nimport { Runner, createGraphQLRunner } from \"./create-graphql-runner\"\nimport { globalTracer } from \"opentracing\"\nimport type { GatsbyWorkerPool } from \"../utils/worker/pool\"\nimport { handleStalePageData } from \"../utils/page-data\"\nimport { savePartialStateToDisk } from \"../redux\"\nimport { IProgram } from \"../commands/types\"\n\nconst tracer = globalTracer()\n\nexport async function bootstrap(\n  initialContext: Partial<IBuildContext> & { program: IProgram }\n): Promise<{\n  gatsbyNodeGraphQLFunction: Runner\n  workerPool: GatsbyWorkerPool\n}> {\n  const spanArgs = initialContext.parentSpan\n    ? { childOf: initialContext.parentSpan }\n    : {}\n\n  const parentSpan = tracer.startSpan(`bootstrap`, spanArgs)\n\n  const bootstrapContext: IBuildContext & {\n    shouldRunCreatePagesStatefully: boolean\n  } = {\n    ...initialContext,\n    parentSpan,\n    shouldRunCreatePagesStatefully: true,\n  }\n\n  const context = {\n    ...bootstrapContext,\n    ...(await initialize(bootstrapContext)),\n  }\n\n  const workerPool = context.workerPool\n\n  const program = context.store.getState().program\n  const directory = slash(program.directory)\n\n  workerPool.all.loadConfigAndPlugins({ siteDirectory: directory, program })\n\n  await customizeSchema(context)\n  await sourceNodes(context)\n\n  await buildSchema(context)\n\n  context.gatsbyNodeGraphQLFunction = createGraphQLRunner(\n    context.store,\n    reporter\n  )\n\n  await createPages(context)\n\n  await handleStalePageData(parentSpan)\n\n  savePartialStateToDisk([`inferenceMetadata`])\n\n  workerPool.all.buildSchema()\n\n  await extractQueries(context)\n\n  savePartialStateToDisk([`components`, `staticQueryComponents`])\n\n  await writeOutRedirects(context)\n\n  startRedirectListener()\n\n  await postBootstrap(context)\n\n  parentSpan.finish()\n\n  return {\n    gatsbyNodeGraphQLFunction: context.gatsbyNodeGraphQLFunction,\n    workerPool,\n  }\n}\n"],"mappings":";;;;;AAAA;AACA;AACA;AACA;AAWA;AACA;AAEA;AACA;AAGA,MAAMA,MAAM,GAAG,IAAAC,yBAAY,GAAE;AAEtB,eAAeC,SAAS,CAC7BC,cAA8D,EAI7D;EACD,MAAMC,QAAQ,GAAGD,cAAc,CAACE,UAAU,GACtC;IAAEC,OAAO,EAAEH,cAAc,CAACE;EAAW,CAAC,GACtC,CAAC,CAAC;EAEN,MAAMA,UAAU,GAAGL,MAAM,CAACO,SAAS,CAAE,WAAU,EAAEH,QAAQ,CAAC;EAE1D,MAAMI,gBAEL,GAAG;IACF,GAAGL,cAAc;IACjBE,UAAU;IACVI,8BAA8B,EAAE;EAClC,CAAC;EAED,MAAMC,OAAO,GAAG;IACd,GAAGF,gBAAgB;IACnB,IAAI,MAAM,IAAAG,oBAAU,EAACH,gBAAgB,CAAC;EACxC,CAAC;EAED,MAAMI,UAAU,GAAGF,OAAO,CAACE,UAAU;EAErC,MAAMC,OAAO,GAAGH,OAAO,CAACI,KAAK,CAACC,QAAQ,EAAE,CAACF,OAAO;EAChD,MAAMG,SAAS,GAAG,IAAAC,sBAAK,EAACJ,OAAO,CAACG,SAAS,CAAC;EAE1CJ,UAAU,CAACM,GAAG,CAACC,oBAAoB,CAAC;IAAEC,aAAa,EAAEJ,SAAS;IAAEH;EAAQ,CAAC,CAAC;EAE1E,MAAM,IAAAQ,yBAAe,EAACX,OAAO,CAAC;EAC9B,MAAM,IAAAY,qBAAW,EAACZ,OAAO,CAAC;EAE1B,MAAM,IAAAa,qBAAW,EAACb,OAAO,CAAC;EAE1BA,OAAO,CAACc,yBAAyB,GAAG,IAAAC,wCAAmB,EACrDf,OAAO,CAACI,KAAK,EACbY,iBAAQ,CACT;EAED,MAAM,IAAAC,qBAAW,EAACjB,OAAO,CAAC;EAE1B,MAAM,IAAAkB,6BAAmB,EAACvB,UAAU,CAAC;EAErC,IAAAwB,6BAAsB,EAAC,CAAE,mBAAkB,CAAC,CAAC;EAE7CjB,UAAU,CAACM,GAAG,CAACK,WAAW,EAAE;EAE5B,MAAM,IAAAO,wBAAc,EAACpB,OAAO,CAAC;EAE7B,IAAAmB,6BAAsB,EAAC,CAAE,YAAW,EAAG,uBAAsB,CAAC,CAAC;EAE/D,MAAM,IAAAE,2BAAiB,EAACrB,OAAO,CAAC;EAEhC,IAAAsB,sCAAqB,GAAE;EAEvB,MAAM,IAAAC,uBAAa,EAACvB,OAAO,CAAC;EAE5BL,UAAU,CAAC6B,MAAM,EAAE;EAEnB,OAAO;IACLV,yBAAyB,EAAEd,OAAO,CAACc,yBAAyB;IAC5DZ;EACF,CAAC;AACH"}