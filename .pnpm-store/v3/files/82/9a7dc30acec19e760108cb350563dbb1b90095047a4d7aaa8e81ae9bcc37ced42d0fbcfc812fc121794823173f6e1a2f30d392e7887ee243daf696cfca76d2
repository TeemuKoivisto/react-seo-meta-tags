{"version":3,"file":"partial-hydration-reference-loader.js","names":["createNamedReference","name","normalizedModuleKey","createDefaultReference","partialHydrationReferenceLoader","content","includes","references","hasClientExportDirective","createNormalizedModuleKey","resourcePath","rootContext","walk","parse","ecmaVersion","sourceType","ExpressionStatement","plainAcornNode","node","directive","ExportNamedDeclaration","declaration","type","id","declarations","push","value","properties","element","elements","specifiers","length","specifier","exported","ExportDefaultDeclaration","AssignmentExpression","left","object","property","join","module","exports"],"sources":["../../../../src/utils/webpack/loaders/partial-hydration-reference-loader.ts"],"sourcesContent":["/* eslint-disable @babel/no-invalid-this */\nimport { parse } from \"acorn-loose\"\nimport { simple as walk } from \"acorn-walk\"\nimport type { LoaderDefinitionFunction } from \"webpack\"\nimport type { Node } from \"acorn-loose\"\nimport type {\n  ExportNamedDeclaration,\n  ExportDefaultDeclaration,\n  AssignmentExpression,\n  Directive,\n} from \"estree\"\nimport { createNormalizedModuleKey } from \"../utils/create-normalized-module-key\"\n\nfunction createNamedReference(\n  name: string,\n  normalizedModuleKey: string\n): string {\n  return `export const ${name} = {\n    $$typeof: Symbol.for('react.module.reference'),\n    filepath: '${normalizedModuleKey}',\n    name: '${name}'\n  }`\n}\n\nfunction createDefaultReference(\n  name: string,\n  normalizedModuleKey: string\n): string {\n  return `export default {\n    $$typeof: Symbol.for('react.module.reference'),\n    filepath: '${normalizedModuleKey}',\n    name: '${name}'\n  }`\n}\n\nconst partialHydrationReferenceLoader: LoaderDefinitionFunction<\n  Record<string, unknown>\n> = async function partialHydrationReferenceLoader(content) {\n  if (!content.includes(`use client`)) {\n    return content\n  }\n\n  const references: Array<string> = []\n  let hasClientExportDirective = false\n\n  const normalizedModuleKey = createNormalizedModuleKey(\n    this.resourcePath,\n    this.rootContext\n  )\n\n  walk(parse(content, { ecmaVersion: 2020, sourceType: `module` }), {\n    ExpressionStatement(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as Directive\n\n      if (node.directive === `use client`) {\n        hasClientExportDirective = true\n      }\n    },\n    ExportNamedDeclaration(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as ExportNamedDeclaration\n\n      if (!hasClientExportDirective) return\n\n      // Handle cases shown in `fixtures/esm-declaration.js`\n      switch (node?.declaration?.type) {\n        case `VariableDeclaration`:\n          for (const { id } of node.declaration.declarations || []) {\n            if (id.type === `Identifier` && id.name) {\n              references.push(\n                createNamedReference(id.name, normalizedModuleKey)\n              )\n            }\n\n            if (id.type === `ObjectPattern`) {\n              // @ts-ignore Wrong type\n              for (const { value } of id.properties) {\n                if (value.type === `Identifier` && value.name) {\n                  references.push(\n                    createNamedReference(value.name, normalizedModuleKey)\n                  )\n                }\n              }\n            }\n\n            if (id.type === `ArrayPattern`) {\n              for (const element of id.elements || []) {\n                if (element?.type === `Identifier` && element.name) {\n                  references.push(\n                    createNamedReference(element.name, normalizedModuleKey)\n                  )\n                }\n              }\n            }\n          }\n          break\n        case `FunctionDeclaration`:\n        case `ClassDeclaration`:\n          if (\n            node.declaration.id?.type === `Identifier` &&\n            node.declaration.id.name\n          ) {\n            references.push(\n              createNamedReference(\n                node.declaration.id.name,\n                normalizedModuleKey\n              )\n            )\n          }\n          break\n      }\n\n      // Handle cases shown in `fixtures/esm-list.js`\n      if (node.specifiers.length) {\n        for (const specifier of node.specifiers) {\n          if (\n            specifier.type === `ExportSpecifier` &&\n            specifier.exported.type === `Identifier` &&\n            specifier.exported.name\n          ) {\n            if (specifier.exported.name === `default`) {\n              references.push(\n                createDefaultReference(`default`, normalizedModuleKey)\n              )\n            } else {\n              references.push(\n                createNamedReference(\n                  specifier.exported.name,\n                  normalizedModuleKey\n                )\n              )\n            }\n          }\n        }\n      }\n    },\n    ExportDefaultDeclaration(plainAcornNode: Node) {\n      const node = plainAcornNode as unknown as ExportDefaultDeclaration\n\n      if (!hasClientExportDirective) return\n\n      switch (node.declaration.type) {\n        // Handle cases shown in `fixtures/esm-default-expression.js`\n        case `Identifier`:\n          if (node.declaration.name) {\n            references.push(\n              createDefaultReference(`default`, normalizedModuleKey)\n            )\n          }\n          break\n        case `FunctionDeclaration`:\n        case `ClassDeclaration`:\n          references.push(\n            createDefaultReference(`default`, normalizedModuleKey)\n          )\n          break\n      }\n    },\n    // TODO: Explore how to only walk top level tokens\n    AssignmentExpression(plainAcornNode) {\n      const node = plainAcornNode as unknown as AssignmentExpression\n      const { left } = node\n\n      if (!hasClientExportDirective) return\n\n      // Handle cases shown in `fixtures/cjs-exports.js`\n      if (\n        left?.type === `MemberExpression` &&\n        left?.object?.type === `Identifier` &&\n        left.object?.name === `exports` &&\n        left?.property?.type === `Identifier` &&\n        left.property?.name\n      ) {\n        references.push(\n          createNamedReference(left.property.name, normalizedModuleKey)\n        )\n      }\n    },\n  })\n\n  return hasClientExportDirective ? references.join(`\\n`) : content\n}\n\nmodule.exports = partialHydrationReferenceLoader\n"],"mappings":"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"}