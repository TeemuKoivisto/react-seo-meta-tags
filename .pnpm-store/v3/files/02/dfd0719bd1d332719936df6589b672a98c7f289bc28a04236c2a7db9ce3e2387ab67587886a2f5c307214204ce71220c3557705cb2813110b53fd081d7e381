{"version":3,"file":"redirects-writer.js","names":["lastHash","bootstrapFinished","writeRedirects","program","redirects","pages","store","getState","redirectMatchingPageWarnings","browserRedirects","redirect","alternativePath","fromPath","endsWith","slice","hasSamePage","has","push","toPath","redirectInBrowser","ignoreCase","toLowerCase","length","reporter","warn","join","newHash","md5","JSON","stringify","fs","writeFile","joinPath","directory","debouncedWriteRedirects","startRedirectListener","emitter","on"],"sources":["../../src/bootstrap/redirects-writer.ts"],"sourcesContent":["import _ from \"lodash\"\nimport fs from \"fs-extra\"\nimport { joinPath, md5 } from \"gatsby-core-utils\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { store, emitter } from \"../redux\"\nimport { IRedirect } from \"../redux/types\"\n\nlet lastHash: string | null = null\nlet bootstrapFinished = false\n\nexport const writeRedirects = async (): Promise<void> => {\n  bootstrapFinished = true\n\n  const { program, redirects, pages } = store.getState()\n\n  const redirectMatchingPageWarnings: Array<string> = []\n  const browserRedirects: Array<IRedirect> = []\n\n  for (const redirect of redirects) {\n    const alternativePath = redirect.fromPath.endsWith(`/`)\n      ? redirect.fromPath.slice(0, -1)\n      : redirect.fromPath + `/`\n\n    let hasSamePage: boolean\n\n    if (\n      (hasSamePage = pages.has(redirect.fromPath)) ||\n      pages.has(alternativePath)\n    ) {\n      redirectMatchingPageWarnings.push(\n        ` - page: \"${\n          hasSamePage ? redirect.fromPath : alternativePath\n        }\" and redirect: \"${redirect.fromPath}\" -> \"${redirect.toPath}\"`\n      )\n    }\n    // Filter for redirects that are meant for the browser.\n    if (redirect.redirectInBrowser) {\n      browserRedirects.push({\n        ...redirect,\n        fromPath: redirect.ignoreCase\n          ? redirect.fromPath.toLowerCase()\n          : redirect.fromPath,\n      })\n    }\n  }\n\n  if (redirectMatchingPageWarnings.length > 0) {\n    reporter.warn(\n      `There are routes that match both page and redirect. Pages take precedence over redirects so the redirect will not work:\\n${redirectMatchingPageWarnings.join(\n        `\\n`\n      )}`\n    )\n  }\n\n  const newHash = await md5(JSON.stringify(browserRedirects))\n\n  if (newHash === lastHash) {\n    return\n  }\n\n  lastHash = newHash\n\n  await fs.writeFile(\n    joinPath(program.directory, `.cache/redirects.json`),\n    JSON.stringify(browserRedirects, null, 2)\n  )\n}\n\nconst debouncedWriteRedirects = _.debounce(() => {\n  // Don't write redirects again until bootstrap has finished.\n  if (bootstrapFinished) {\n    writeRedirects()\n  }\n}, 250)\n\nexport const startRedirectListener = (): void => {\n  emitter.on(`CREATE_REDIRECT`, () => {\n    debouncedWriteRedirects()\n  })\n}\n"],"mappings":";;;;;;AACA;AACA;AACA;AACA;AAGA,IAAIA,QAAuB,GAAG,IAAI;AAClC,IAAIC,iBAAiB,GAAG,KAAK;AAEtB,MAAMC,cAAc,GAAG,YAA2B;EACvDD,iBAAiB,GAAG,IAAI;EAExB,MAAM;IAAEE,OAAO;IAAEC,SAAS;IAAEC;EAAM,CAAC,GAAGC,YAAK,CAACC,QAAQ,EAAE;EAEtD,MAAMC,4BAA2C,GAAG,EAAE;EACtD,MAAMC,gBAAkC,GAAG,EAAE;EAE7C,KAAK,MAAMC,QAAQ,IAAIN,SAAS,EAAE;IAChC,MAAMO,eAAe,GAAGD,QAAQ,CAACE,QAAQ,CAACC,QAAQ,CAAE,GAAE,CAAC,GACnDH,QAAQ,CAACE,QAAQ,CAACE,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAC9BJ,QAAQ,CAACE,QAAQ,GAAI,GAAE;IAE3B,IAAIG,WAAoB;IAExB,IACE,CAACA,WAAW,GAAGV,KAAK,CAACW,GAAG,CAACN,QAAQ,CAACE,QAAQ,CAAC,KAC3CP,KAAK,CAACW,GAAG,CAACL,eAAe,CAAC,EAC1B;MACAH,4BAA4B,CAACS,IAAI,CAC9B,aACCF,WAAW,GAAGL,QAAQ,CAACE,QAAQ,GAAGD,eACnC,oBAAmBD,QAAQ,CAACE,QAAS,SAAQF,QAAQ,CAACQ,MAAO,GAAE,CACjE;IACH;IACA;IACA,IAAIR,QAAQ,CAACS,iBAAiB,EAAE;MAC9BV,gBAAgB,CAACQ,IAAI,CAAC;QACpB,GAAGP,QAAQ;QACXE,QAAQ,EAAEF,QAAQ,CAACU,UAAU,GACzBV,QAAQ,CAACE,QAAQ,CAACS,WAAW,EAAE,GAC/BX,QAAQ,CAACE;MACf,CAAC,CAAC;IACJ;EACF;EAEA,IAAIJ,4BAA4B,CAACc,MAAM,GAAG,CAAC,EAAE;IAC3CC,iBAAQ,CAACC,IAAI,CACV,4HAA2HhB,4BAA4B,CAACiB,IAAI,CAC1J,IAAG,CACJ,EAAC,CACJ;EACH;EAEA,MAAMC,OAAO,GAAG,MAAM,IAAAC,oBAAG,EAACC,IAAI,CAACC,SAAS,CAACpB,gBAAgB,CAAC,CAAC;EAE3D,IAAIiB,OAAO,KAAK1B,QAAQ,EAAE;IACxB;EACF;EAEAA,QAAQ,GAAG0B,OAAO;EAElB,MAAMI,gBAAE,CAACC,SAAS,CAChB,IAAAC,yBAAQ,EAAC7B,OAAO,CAAC8B,SAAS,EAAG,uBAAsB,CAAC,EACpDL,IAAI,CAACC,SAAS,CAACpB,gBAAgB,EAAE,IAAI,EAAE,CAAC,CAAC,CAC1C;AACH,CAAC;AAAA;AAED,MAAMyB,uBAAuB,GAAG,wBAAW,MAAM;EAC/C;EACA,IAAIjC,iBAAiB,EAAE;IACrBC,cAAc,EAAE;EAClB;AACF,CAAC,EAAE,GAAG,CAAC;AAEA,MAAMiC,qBAAqB,GAAG,MAAY;EAC/CC,cAAO,CAACC,EAAE,CAAE,iBAAgB,EAAE,MAAM;IAClCH,uBAAuB,EAAE;EAC3B,CAAC,CAAC;AACJ,CAAC;AAAA"}