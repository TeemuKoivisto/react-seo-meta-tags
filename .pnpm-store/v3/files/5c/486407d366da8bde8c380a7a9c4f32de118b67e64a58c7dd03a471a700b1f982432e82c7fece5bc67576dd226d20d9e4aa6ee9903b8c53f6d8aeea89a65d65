{"version":3,"file":"index.js","names":["PAGE_QUERY_ENQUEUING_TIMEOUT","queryStates","predictableActionArguments","initial","id","on","SOURCE_FILE_CHANGED","actions","QUERY_RUN_REQUESTED","states","extractingQueries","invoke","src","onDone","target","waitingPendingQueries","after","writingRequires","calculatingDirtyQueries","entry","assign","pendingQueryRuns","Set","currentlyHandledPendingQueryRuns","runningStaticQueries","runningPageQueries","runningSliceQueries","waitingForJobs","always","cond","ctx","filesDirty","size","done","type","queryRunningMachine","createMachine","queryActions","services","queryRunningServices"],"sources":["../../../src/state-machines/query-running/index.ts"],"sourcesContent":["import { MachineConfig, createMachine, assign } from \"xstate\"\nimport { IQueryRunningContext } from \"./types\"\nimport { queryRunningServices } from \"./services\"\nimport { queryActions } from \"./actions\"\n\n/**\n * This is a child state machine, spawned to perform the query running\n */\n\nconst PAGE_QUERY_ENQUEUING_TIMEOUT = 50\n\nexport const queryStates: MachineConfig<IQueryRunningContext, any, any> = {\n  predictableActionArguments: true,\n  initial: `extractingQueries`,\n  id: `queryRunningMachine`,\n  on: {\n    SOURCE_FILE_CHANGED: {\n      actions: `markSourceFilesDirty`,\n    },\n    QUERY_RUN_REQUESTED: {\n      actions: `trackRequestedQueryRun`,\n    },\n  },\n  states: {\n    extractingQueries: {\n      id: `extracting-queries`,\n      invoke: {\n        id: `extracting-queries`,\n        src: `extractQueries`,\n        onDone: {\n          target: `waitingPendingQueries`,\n        },\n      },\n    },\n    // This state exists solely because \"extractQueries\" finishes too early.\n    // It finishes before extracted queries are enqueued for execution.\n    // As a result calculateDirtyQueries doesn't see them and they are not executed.\n    //\n    // This happens because extracted queries are enqueued for execution with setTimeout(x, 0)\n    // wrapper in actions of redux/machines/page-component which fires after \"extractQueries\" finishes.\n    //\n    // see https://github.com/gatsbyjs/gatsby/issues/26580\n    //\n    // FIXME: this has to be fixed properly by not leaving \"extractingQueries\" state\n    //   until all extracted queries are enqueued for execution (but requires a refactor)\n    waitingPendingQueries: {\n      id: `waiting-pending-queries`,\n      after: {\n        [PAGE_QUERY_ENQUEUING_TIMEOUT]: {\n          target: `writingRequires`,\n          actions: `markSourceFilesClean`,\n        },\n      },\n    },\n    writingRequires: {\n      invoke: {\n        src: `writeOutRequires`,\n        id: `writing-requires`,\n        onDone: {\n          target: `calculatingDirtyQueries`,\n        },\n      },\n    },\n    calculatingDirtyQueries: {\n      entry: assign<IQueryRunningContext>(({ pendingQueryRuns }) => {\n        return {\n          pendingQueryRuns: new Set(),\n          currentlyHandledPendingQueryRuns: pendingQueryRuns,\n        }\n      }),\n      invoke: {\n        id: `calculating-dirty-queries`,\n        src: `calculateDirtyQueries`,\n        onDone: {\n          target: `runningStaticQueries`,\n          actions: [\n            `assignDirtyQueries`,\n            `clearCurrentlyHandledPendingQueryRuns`,\n          ],\n        },\n      },\n    },\n    runningStaticQueries: {\n      invoke: {\n        src: `runStaticQueries`,\n        id: `running-static-queries`,\n        onDone: {\n          target: `runningPageQueries`,\n        },\n      },\n    },\n    runningPageQueries: {\n      invoke: {\n        src: `runPageQueries`,\n        id: `running-page-queries`,\n        onDone: {\n          target: `runningSliceQueries`,\n        },\n      },\n    },\n    runningSliceQueries: {\n      invoke: {\n        src: `runSliceQueries`,\n        id: `running-slice-queries`,\n        onDone: {\n          target: `waitingForJobs`,\n          actions: `flushPageData`,\n        },\n      },\n    },\n    // This waits for the jobs API to finish\n    waitingForJobs: {\n      // If files are dirty go and extract again\n      always: [\n        {\n          cond: (ctx): boolean => !!ctx.filesDirty,\n          target: `extractingQueries`,\n        },\n        {\n          cond: ({ pendingQueryRuns }): boolean =>\n            !!pendingQueryRuns && pendingQueryRuns.size > 0,\n          target: `calculatingDirtyQueries`,\n        },\n      ],\n      invoke: {\n        src: `waitUntilAllJobsComplete`,\n        id: `waiting-for-jobs`,\n        onDone: {\n          target: `done`,\n        },\n      },\n    },\n    done: {\n      type: `final`,\n    },\n  },\n}\nexport const queryRunningMachine = createMachine(queryStates, {\n  actions: queryActions,\n  services: queryRunningServices,\n})\n"],"mappings":"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"}