{"version":3,"file":"index.js","names":["emitter","mett","readState","state","readFromCache","nodes","nodesByType","Map","forEach","node","type","internal","has","set","get","id","telemetry","trackCli","cacheStatus","e","multi","dispatch","next","action","Array","isArray","filter","Boolean","map","configureStore","initialState","createStore","combineReducers","reducers","applyMiddleware","thunk","store","process","env","GATSBY_WORKER_POOL_WORKER","replaceReducer","customReducers","saveState","GATSBY_DISABLE_CACHE_PERSISTENCE","undefined","getState","writeToCache","status","components","jobsV2","staticQueryComponents","webpackCompilationHash","pageDataStats","pages","pendingPageDataWrites","staticQueriesByTemplate","queries","html","slices","slicesByTemplate","savePartialStateToDisk","optionalPrefix","transformState","contents","savedContents","loadPartialStateFromDisk","subscribe","lastAction","emit"],"sources":["../../src/redux/index.ts"],"sourcesContent":["import {\n  applyMiddleware,\n  combineReducers,\n  createStore,\n  DeepPartial,\n  Middleware,\n  ReducersMapObject,\n  Store,\n} from \"redux\"\nimport _ from \"lodash\"\nimport telemetry from \"gatsby-telemetry\"\n\nimport { mett } from \"../utils/mett\"\nimport thunk, { ThunkMiddleware, ThunkAction, ThunkDispatch } from \"redux-thunk\"\nimport * as reducers from \"./reducers\"\nimport { writeToCache, readFromCache } from \"./persist\"\nimport { IGatsbyState, ActionsUnion, GatsbyStateKeys } from \"./types\"\n\n// Create event emitter for actions\nexport const emitter = mett()\n\n// Read old node data from cache.\nexport const readState = (): IGatsbyState => {\n  try {\n    const state = readFromCache() as IGatsbyState\n    if (state.nodes) {\n      // re-create nodesByType\n      state.nodesByType = new Map()\n      state.nodes.forEach(node => {\n        const { type } = node.internal\n        if (!state.nodesByType.has(type)) {\n          state.nodesByType.set(type, new Map())\n        }\n        // The `.has` and `.set` calls above make this safe\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n        state.nodesByType.get(type)!.set(node.id, node)\n      })\n    }\n\n    // jsonDataPaths was removed in the per-page-manifest\n    // changes. Explicitly delete it here to cover case where user\n    // runs gatsby the first time after upgrading.\n    delete state[`jsonDataPaths`]\n\n    telemetry.trackCli(`CACHE_STATUS`, {\n      cacheStatus: `WARM`,\n    })\n\n    return state\n  } catch (e) {\n    telemetry.trackCli(`CACHE_STATUS`, {\n      cacheStatus: `COLD`,\n    })\n\n    return {} as IGatsbyState\n  }\n}\n\nexport interface IMultiDispatch {\n  <T extends ActionsUnion | ThunkAction<any, IGatsbyState, any, ActionsUnion>>(\n    action: Array<T>\n  ): Array<T>\n}\n\n/**\n * Redux middleware handling array of actions\n */\nconst multi: Middleware<IMultiDispatch> =\n  ({ dispatch }) =>\n  next =>\n  (action: ActionsUnion): ActionsUnion | Array<ActionsUnion> =>\n    Array.isArray(action) ? action.filter(Boolean).map(dispatch) : next(action)\n\nexport type GatsbyReduxStore = Store<IGatsbyState> & {\n  dispatch: ThunkDispatch<IGatsbyState, any, ActionsUnion> & IMultiDispatch\n}\n\nexport const configureStore = (initialState: IGatsbyState): GatsbyReduxStore =>\n  createStore(\n    combineReducers<IGatsbyState>({ ...reducers }),\n    initialState,\n    applyMiddleware(thunk as ThunkMiddleware<IGatsbyState, ActionsUnion>, multi)\n  )\n\nexport const store: GatsbyReduxStore = configureStore(\n  process.env.GATSBY_WORKER_POOL_WORKER ? ({} as IGatsbyState) : readState()\n)\n\n/**\n * Allows overloading some reducers (e.g. when setting a custom datastore)\n */\nexport function replaceReducer(\n  customReducers: Partial<ReducersMapObject<IGatsbyState>>\n): void {\n  store.replaceReducer(\n    combineReducers<IGatsbyState>({ ...reducers, ...customReducers })\n  )\n}\n\n// Persist state.\nexport const saveState = (): void => {\n  if (process.env.GATSBY_DISABLE_CACHE_PERSISTENCE) {\n    // do not persist cache if above env var is set.\n    // this is to temporarily unblock builds that hit the v8.serialize related\n    // Node.js buffer size exceeding kMaxLength fatal crashes\n    return undefined\n  }\n\n  const state = store.getState()\n\n  return writeToCache({\n    nodes: state.nodes,\n    status: state.status,\n    components: state.components,\n    jobsV2: state.jobsV2,\n    staticQueryComponents: state.staticQueryComponents,\n    webpackCompilationHash: state.webpackCompilationHash,\n    pageDataStats: state.pageDataStats,\n    pages: state.pages,\n    pendingPageDataWrites: state.pendingPageDataWrites,\n    staticQueriesByTemplate: state.staticQueriesByTemplate,\n    queries: state.queries,\n    html: state.html,\n    slices: state.slices,\n    slicesByTemplate: state.slicesByTemplate,\n  })\n}\n\nexport const savePartialStateToDisk = (\n  slices: Array<GatsbyStateKeys>,\n  optionalPrefix?: string,\n  transformState?: <T extends DeepPartial<IGatsbyState>>(state: T) => T\n): void => {\n  const state = store.getState()\n  const contents = _.pick(state, slices)\n  const savedContents = transformState ? transformState(contents) : contents\n\n  return writeToCache(savedContents, slices, optionalPrefix)\n}\n\nexport const loadPartialStateFromDisk = (\n  slices: Array<GatsbyStateKeys>,\n  optionalPrefix?: string\n): DeepPartial<IGatsbyState> => {\n  try {\n    return readFromCache(slices, optionalPrefix) as DeepPartial<IGatsbyState>\n  } catch (e) {\n    // ignore errors.\n  }\n  return {} as IGatsbyState\n}\n\nstore.subscribe(() => {\n  const lastAction = store.getState().lastAction\n  emitter.emit(lastAction.type, lastAction)\n})\n"],"mappings":"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"}