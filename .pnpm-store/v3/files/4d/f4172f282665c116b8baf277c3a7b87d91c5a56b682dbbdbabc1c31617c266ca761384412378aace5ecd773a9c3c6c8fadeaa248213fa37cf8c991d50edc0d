{"version":3,"file":"is-file.js","names":["getFirstValueAt","node","selector","value","getValueAt","Array","isArray","withBaseDir","dir","p","path","posix","join","slash","findAncestorNode","childNode","predicate","getNode","parent","undefined","getBaseDir","internal","type","getAbsolutePath","relativePath","withDir","map","getFilePath","fieldPath","typeName","split","looksLikeFile","isAbsolute","mime","getType","isRelative","isRelativeUrl","normalizedPath","getNodesByType","find","isFile","filePath","filePathExists","some","absolutePath"],"sources":["../../../src/schema/infer/is-file.ts"],"sourcesContent":["import path from \"path\"\nimport { slash } from \"gatsby-core-utils\"\nimport mime from \"mime\"\nimport isRelative from \"is-relative\"\nimport isRelativeUrl from \"is-relative-url\"\nimport { getValueAt } from \"../../utils/get-value-at\"\nimport { getNode, getNodesByType } from \"../../datastore\"\nimport { IGatsbyNode } from \"../../redux/types\"\n\nconst getFirstValueAt = (\n  node: IGatsbyNode,\n  selector: string | Array<string>\n): string => {\n  let value = getValueAt(node, selector)\n  while (Array.isArray(value)) {\n    value = value[0]\n  }\n  return value\n}\n\nconst withBaseDir =\n  (dir: string) =>\n  (p: string): string =>\n    path.posix.join(dir, slash(p))\n\nconst findAncestorNode = (\n  childNode: IGatsbyNode,\n  predicate: (n: IGatsbyNode) => boolean\n): IGatsbyNode | null => {\n  let node: IGatsbyNode | undefined = childNode\n  do {\n    if (predicate(node)) {\n      return node\n    }\n    node = getNode(node.parent)\n  } while (node !== undefined)\n  return null\n}\n\nconst getBaseDir = (node: IGatsbyNode): string | null => {\n  if (node) {\n    const { dir } = findAncestorNode(\n      node,\n      node => node.internal.type === `File`\n    ) || { dir: `` }\n    return typeof dir === `string` ? dir : null\n  }\n  return null\n}\n\nconst getAbsolutePath = (\n  node: IGatsbyNode,\n  relativePath: string\n): string | Array<string> | null => {\n  const dir = getBaseDir(node)\n  const withDir = withBaseDir(dir ?? ``)\n  return dir\n    ? Array.isArray(relativePath)\n      ? relativePath.map(withDir)\n      : withDir(relativePath)\n    : null\n}\n\nconst getFilePath = (\n  fieldPath: string,\n  relativePath: string\n): string | Array<string> | null => {\n  const [typeName, ...selector] = Array.isArray(fieldPath)\n    ? fieldPath\n    : fieldPath.split(`.`)\n\n  if (typeName === `File`) return null\n\n  const looksLikeFile =\n    !path.isAbsolute(relativePath) &&\n    mime.getType(relativePath) !== null &&\n    // FIXME: Do we need all of this?\n    mime.getType(relativePath) !== `application/x-msdownload` &&\n    isRelative(relativePath) &&\n    isRelativeUrl(relativePath)\n\n  if (!looksLikeFile) return null\n\n  const normalizedPath = slash(relativePath)\n  const node = getNodesByType(typeName).find(\n    node => getFirstValueAt(node, selector) === normalizedPath\n  )\n\n  return node ? getAbsolutePath(node, normalizedPath) : null\n}\n\nexport const isFile = (fieldPath: string, relativePath: string): boolean => {\n  const filePath = getFilePath(fieldPath, relativePath)\n  if (!filePath) return false\n  const filePathExists = getNodesByType(`File`).some(\n    node => node.absolutePath === filePath\n  )\n  return filePathExists\n}\n"],"mappings":"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"}