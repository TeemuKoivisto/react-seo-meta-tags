{"version":3,"file":"recompile.js","names":["recompile","context","stats","Promise","all","recompileDevBundle","recompileSSRBundle","webpackWatching","reporter","panic","resolve","finish","emitter","off","on","resume","suspend","program","websocketManager","recompiledFiles","Set","includesSSRComponent","verbose","close","rendererPath","buildRenderer","Stage","DevelopHTML","clearRequireCacheRecursively","emitStaleServerData","result","Array","from","map","path","isSSRPageComponent","some","isSSR","filename","fs","pathExists","lstat","isFile","text","readFile","includes"],"sources":["../../src/services/recompile.ts"],"sourcesContent":["/* eslint-disable no-unused-expressions */\nimport { IBuildContext } from \"./types\"\nimport * as fs from \"fs-extra\"\nimport { Stats } from \"webpack\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { emitter } from \"../redux\"\nimport { buildRenderer } from \"../commands/build-html\"\nimport { Stage } from \"../commands/types\"\nimport { clearRequireCacheRecursively } from \"../utils/clear-require-cache\"\n\nexport async function recompile(context: IBuildContext): Promise<Stats> {\n  const [stats] = await Promise.all([\n    recompileDevBundle(context),\n    recompileSSRBundle(context),\n  ])\n  return stats\n}\n\nasync function recompileDevBundle({\n  webpackWatching,\n}: IBuildContext): Promise<Stats> {\n  if (!webpackWatching) {\n    reporter.panic(`Missing compiler`)\n  }\n  return new Promise<Stats>(resolve => {\n    function finish(stats: Stats): void {\n      emitter.off(`COMPILATION_DONE`, finish)\n      resolve(stats)\n    }\n    emitter.on(`COMPILATION_DONE`, finish)\n    webpackWatching.resume()\n    // Suspending is just a flag, so it's safe to re-suspend right away\n    webpackWatching.suspend()\n  })\n}\n\nasync function recompileSSRBundle({\n  program,\n  websocketManager,\n  recompiledFiles = new Set(),\n}: IBuildContext): Promise<void> {\n  if (!(await includesSSRComponent(recompiledFiles))) {\n    return\n  }\n  reporter.verbose(`Recompiling SSR bundle`)\n\n  const { close, rendererPath } = await buildRenderer(\n    program,\n    Stage.DevelopHTML\n  )\n\n  clearRequireCacheRecursively(rendererPath)\n\n  if (websocketManager) {\n    websocketManager.emitStaleServerData()\n  }\n\n  await close()\n}\n\nasync function includesSSRComponent(\n  recompiledFiles: Set<string>\n): Promise<boolean> {\n  const result = await Promise.all(\n    Array.from(recompiledFiles).map(path => isSSRPageComponent(path))\n  )\n  return result.some(isSSR => isSSR === true)\n}\n\nasync function isSSRPageComponent(filename: string): Promise<boolean> {\n  if (\n    !(await fs.pathExists(filename)) ||\n    !(await fs.lstat(filename)).isFile()\n  ) {\n    return false\n  }\n  const text = await fs.readFile(filename, `utf8`)\n  return text.includes(`getServerData`)\n}\n"],"mappings":";;;;;AAEA;AAEA;AACA;AACA;AACA;AACA;AAA2E;AAAA;AAR3E;;AAUO,eAAeA,SAAS,CAACC,OAAsB,EAAkB;EACtE,MAAM,CAACC,KAAK,CAAC,GAAG,MAAMC,OAAO,CAACC,GAAG,CAAC,CAChCC,kBAAkB,CAACJ,OAAO,CAAC,EAC3BK,kBAAkB,CAACL,OAAO,CAAC,CAC5B,CAAC;EACF,OAAOC,KAAK;AACd;AAEA,eAAeG,kBAAkB,CAAC;EAChCE;AACa,CAAC,EAAkB;EAChC,IAAI,CAACA,eAAe,EAAE;IACpBC,iBAAQ,CAACC,KAAK,CAAE,kBAAiB,CAAC;EACpC;EACA,OAAO,IAAIN,OAAO,CAAQO,OAAO,IAAI;IACnC,SAASC,MAAM,CAACT,KAAY,EAAQ;MAClCU,cAAO,CAACC,GAAG,CAAE,kBAAiB,EAAEF,MAAM,CAAC;MACvCD,OAAO,CAACR,KAAK,CAAC;IAChB;IACAU,cAAO,CAACE,EAAE,CAAE,kBAAiB,EAAEH,MAAM,CAAC;IACtCJ,eAAe,CAACQ,MAAM,EAAE;IACxB;IACAR,eAAe,CAACS,OAAO,EAAE;EAC3B,CAAC,CAAC;AACJ;AAEA,eAAeV,kBAAkB,CAAC;EAChCW,OAAO;EACPC,gBAAgB;EAChBC,eAAe,GAAG,IAAIC,GAAG;AACZ,CAAC,EAAiB;EAC/B,IAAI,EAAE,MAAMC,oBAAoB,CAACF,eAAe,CAAC,CAAC,EAAE;IAClD;EACF;EACAX,iBAAQ,CAACc,OAAO,CAAE,wBAAuB,CAAC;EAE1C,MAAM;IAAEC,KAAK;IAAEC;EAAa,CAAC,GAAG,MAAM,IAAAC,wBAAa,EACjDR,OAAO,EACPS,YAAK,CAACC,WAAW,CAClB;EAED,IAAAC,+CAA4B,EAACJ,YAAY,CAAC;EAE1C,IAAIN,gBAAgB,EAAE;IACpBA,gBAAgB,CAACW,mBAAmB,EAAE;EACxC;EAEA,MAAMN,KAAK,EAAE;AACf;AAEA,eAAeF,oBAAoB,CACjCF,eAA4B,EACV;EAClB,MAAMW,MAAM,GAAG,MAAM3B,OAAO,CAACC,GAAG,CAC9B2B,KAAK,CAACC,IAAI,CAACb,eAAe,CAAC,CAACc,GAAG,CAACC,IAAI,IAAIC,kBAAkB,CAACD,IAAI,CAAC,CAAC,CAClE;EACD,OAAOJ,MAAM,CAACM,IAAI,CAACC,KAAK,IAAIA,KAAK,KAAK,IAAI,CAAC;AAC7C;AAEA,eAAeF,kBAAkB,CAACG,QAAgB,EAAoB;EACpE,IACE,EAAE,MAAMC,EAAE,CAACC,UAAU,CAACF,QAAQ,CAAC,CAAC,IAChC,CAAC,CAAC,MAAMC,EAAE,CAACE,KAAK,CAACH,QAAQ,CAAC,EAAEI,MAAM,EAAE,EACpC;IACA,OAAO,KAAK;EACd;EACA,MAAMC,IAAI,GAAG,MAAMJ,EAAE,CAACK,QAAQ,CAACN,QAAQ,EAAG,MAAK,CAAC;EAChD,OAAOK,IAAI,CAACE,QAAQ,CAAE,eAAc,CAAC;AACvC"}