{"version":3,"file":"partial-hydration.js","names":["PARTIAL_HYDRATION_CHUNK_REASON","PartialHydrationPlugin","name","_collectedCssModules","Set","_previousManifest","constructor","manifestPath","reporter","_manifestPath","_reporter","_generateManifest","compilation","rootContext","moduleGraph","chunkGraph","json","mapOriginalModuleToPotentiallyConcatanetedModule","Map","recordModule","id","module","exports","chunkIds","normalModule","moduleExports","forEach","originalExport","resolvedExport","chunks","modules","mod","buildInfo","rsc","normalizedModuleKey","createNormalizedModuleKey","resource","undefined","ClientModulesToRecord","recordModuleExports","childMap","set","exportInfo","getExportsInfo","isReexport","targetInfo","getTarget","has","get","push","export","newClientModules","chunkGroups","chunkGroup","chunk","chunkModules","getChunkModulesIterable","add","subMod","clientModule","incomingConnections","getIncomingConnections","connection","dependency","originalModule","resolvedMap","resolvedModule","getModuleChunksIterable","moduleId","getModuleId","Array","from","clear","addClientModuleEntries","compiler","clientModules","cssModules","visited","collectCssModules","type","outgoingConnections","getOutgoingConnections","asyncRequires","NormalModule","request","endsWith","dependencyBlock","getParentBlock","AsyncDependenciesBlock","chunkName","startsWith","originModule","includes","removeConnection","Error","clientSSRLoader","map","path","relative","options","context","userRequest","join","clientComponentEntryDep","webpack","EntryPlugin","createDependency","addEntry","entry","Promise","resolve","reject","oldEntry","entries","includeDependencies","hooks","call","addModuleTree","err","failedEntry","succeedEntry","e","console","log","apply","beforeCompile","tap","previousManifest","fs","existsSync","JSON","parse","readFileSync","error","panic","finishMake","tapPromise","parentCompilation","thisCompilation","normalModuleFactory","parserCallback","parser","program","ast","hasClientExportDirective","body","find","statement","directive","state","for","optimizeChunks","appChunk","modulesToInsertIntoApp","cssModule","usedInChunks","isInAnyChunk","_","sort","a","b","getPostOrderIndex","connectChunkAndModule","group","groupsIterable","getModulePostOrderIndex","setModulePostOrderIndex","_modulePostOrderIndices","size","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_REPORT","manifest","emitManifestPath","replace","emitAsset","sources","RawSource","stringify"],"sources":["../../../../src/utils/webpack/plugins/partial-hydration.ts"],"sourcesContent":["import * as path from \"path\"\nimport fs from \"fs-extra\"\nimport { createNormalizedModuleKey } from \"../utils/create-normalized-module-key\"\nimport webpack, {\n  Module,\n  NormalModule,\n  javascript,\n  Compilation,\n  Compiler,\n  AsyncDependenciesBlock,\n} from \"webpack\"\nimport type Reporter from \"gatsby-cli/lib/reporter\"\n\ninterface IModuleExport {\n  id: string\n  chunks: Array<string>\n  name: string\n}\n\ninterface IDirective {\n  directive?: string\n}\n\nexport const PARTIAL_HYDRATION_CHUNK_REASON = `PartialHydration client module`\n\n/**\n * inspiration and code mostly comes from https://github.com/facebook/react/blob/3f70e68cea8d2ed0f53d35420105ae20e22ce428/packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js\n */\nexport class PartialHydrationPlugin {\n  name = `PartialHydrationPlugin`\n\n  _manifestPath: string // Absolute path to where the manifest file should be written\n  _reporter: typeof Reporter\n\n  _collectedCssModules = new Set<webpack.Module>()\n  _previousManifest = {}\n\n  constructor(manifestPath: string, reporter: typeof Reporter) {\n    this._manifestPath = manifestPath\n    this._reporter = reporter\n  }\n\n  _generateManifest(\n    compilation: Compilation,\n    rootContext: string\n  ): Record<string, Record<string, IModuleExport>> {\n    const moduleGraph = compilation.moduleGraph\n    const chunkGraph = compilation.chunkGraph\n\n    const json: Record<string, Record<string, IModuleExport>> = {}\n    const mapOriginalModuleToPotentiallyConcatanetedModule = new Map()\n    // @see https://github.com/facebook/react/blob/3f70e68cea8d2ed0f53d35420105ae20e22ce428/packages/react-server-dom-webpack/src/ReactFlightWebpackPlugin.js#L220-L252\n    const recordModule = (\n      id: string,\n      module: Module | NormalModule,\n      exports: Array<{ originalExport: string; resolvedExport: string }>,\n      chunkIds: Array<string>\n    ): void => {\n      const normalModule: NormalModule = module as NormalModule\n\n      const moduleExports: Record<string, IModuleExport> = {}\n      exports.forEach(({ originalExport, resolvedExport }) => {\n        moduleExports[originalExport] = {\n          id: id,\n          chunks: chunkIds,\n          name: resolvedExport,\n        }\n      })\n\n      // @ts-ignore\n      if (normalModule.modules) {\n        // @ts-ignore\n        normalModule.modules.forEach(mod => {\n          if (mod.buildInfo.rsc) {\n            const normalizedModuleKey = createNormalizedModuleKey(\n              mod.resource,\n              rootContext\n            )\n\n            if (normalizedModuleKey !== undefined) {\n              json[normalizedModuleKey] = moduleExports\n            }\n          }\n        })\n      } else {\n        if (normalModule.buildInfo.rsc) {\n          const normalizedModuleKey = createNormalizedModuleKey(\n            normalModule.resource,\n            rootContext\n          )\n\n          if (normalizedModuleKey !== undefined) {\n            json[normalizedModuleKey] = moduleExports\n          }\n        }\n      }\n    }\n\n    const ClientModulesToRecord: Map<\n      webpack.Module,\n      Map<\n        webpack.Module,\n        Array<{\n          originalExport: string\n          resolvedExport: string\n        }>\n      >\n    > = new Map()\n\n    function recordModuleExports(module): any {\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const childMap = new Map()\n      ClientModulesToRecord.set(module, childMap)\n\n      for (const exportInfo of moduleGraph.getExportsInfo(module).exports) {\n        if (exportInfo.isReexport()) {\n          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n          const targetInfo = exportInfo.getTarget(moduleGraph)!\n          if (!childMap.has(targetInfo.module)) {\n            childMap.set(targetInfo.module, [])\n          }\n\n          childMap.get(targetInfo.module)?.push({\n            originalExport: exportInfo.name,\n            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n            resolvedExport: targetInfo.export![0],\n          })\n        } else {\n          if (!childMap.has(module)) {\n            childMap.set(module, [])\n          }\n\n          childMap.get(module)?.push({\n            originalExport: exportInfo.name,\n            resolvedExport: exportInfo.name,\n          })\n        }\n      }\n    }\n\n    const newClientModules = new Set<webpack.Module>()\n    compilation.chunkGroups.forEach(chunkGroup => {\n      chunkGroup.chunks.forEach((chunk: webpack.Chunk) => {\n        const chunkModules =\n          compilation.chunkGraph.getChunkModulesIterable(chunk)\n        for (const mod of chunkModules) {\n          if (mod.buildInfo.rsc) {\n            mapOriginalModuleToPotentiallyConcatanetedModule.set(mod, mod)\n            newClientModules.add(mod)\n          }\n\n          // @ts-ignore\n          if (mod.modules) {\n            // @ts-ignore\n            for (const subMod of mod.modules) {\n              if (subMod.buildInfo.rsc) {\n                mapOriginalModuleToPotentiallyConcatanetedModule.set(\n                  subMod,\n                  mod\n                )\n                newClientModules.add(mod)\n              }\n            }\n          }\n        }\n      })\n    })\n\n    for (const clientModule of newClientModules) {\n      recordModuleExports(clientModule)\n\n      const incomingConnections =\n        moduleGraph.getIncomingConnections(clientModule)\n\n      for (const connection of incomingConnections) {\n        if (connection.dependency) {\n          if (ClientModulesToRecord.has(connection.module)) {\n            continue\n          }\n\n          recordModuleExports(connection.module)\n        }\n      }\n    }\n\n    for (const [originalModule, resolvedMap] of ClientModulesToRecord) {\n      for (const [resolvedModule, exports] of resolvedMap) {\n        const chunkIds: Set<string> = new Set()\n\n        const chunks = chunkGraph.getModuleChunksIterable(resolvedModule)\n\n        for (const chunk of chunks) {\n          if (chunk.id) {\n            chunkIds.add(chunk.id as string)\n          }\n        }\n\n        const moduleId = chunkGraph.getModuleId(resolvedModule) as string\n        recordModule(moduleId, originalModule, exports, Array.from(chunkIds))\n      }\n    }\n\n    ClientModulesToRecord.clear()\n\n    return json\n  }\n\n  async addClientModuleEntries(\n    // @ts-ignore\n    compiler: Compiler,\n    compilation: Compilation\n  ): Promise<void> {\n    const clientModules: Array<webpack.NormalModule> = []\n    const cssModules = (this._collectedCssModules = new Set())\n\n    const visited = new Set<webpack.Module>()\n    function collectCssModules(module: webpack.Module): void {\n      if (visited.has(module)) {\n        return\n      }\n      visited.add(module)\n      if (module.buildInfo.rsc) {\n        return\n      }\n\n      if (module.type === `css/mini-extract`) {\n        cssModules.add(module)\n      }\n\n      const outgoingConnections =\n        compilation.moduleGraph.getOutgoingConnections(module)\n\n      for (const connection of outgoingConnections) {\n        if (connection.dependency) {\n          collectCssModules(connection.module)\n        }\n      }\n    }\n\n    let asyncRequires: NormalModule | null = null\n    for (const module of compilation.modules) {\n      if (module instanceof NormalModule) {\n        if (module.buildInfo.rsc) {\n          clientModules.push(module)\n        } else if (module.request.endsWith(`export=default`)) {\n          const incomingConnections =\n            compilation.moduleGraph.getIncomingConnections(module)\n\n          for (const connection of incomingConnections) {\n            if (connection.dependency) {\n              const dependencyBlock = compilation.moduleGraph.getParentBlock(\n                connection.dependency\n              )\n\n              if (\n                dependencyBlock instanceof AsyncDependenciesBlock &&\n                dependencyBlock?.chunkName?.startsWith(`slice---`)\n              ) {\n                continue\n              }\n\n              if (connection.originModule instanceof NormalModule) {\n                if (\n                  connection.originModule.resource.includes(`async-requires`)\n                ) {\n                  asyncRequires = connection.originModule\n\n                  // Remove page template \"import\" from async-requires.\n                  // Note that if other imports to a template will remain it will remain in the bundle:\n                  // that can happen if template is marked with \"use client\" or if other client component\n                  // will import it. We don't want to force remove template - we just want to remove the\n                  // import from async-requires and let webpack remove it rom the bundle (or rather just not add it)\n                  // if it's not used anywhere else\n                  compilation.moduleGraph.removeConnection(\n                    connection.dependency\n                  )\n                }\n              }\n            }\n          }\n\n          // find css modules that are imported by this module\n          collectCssModules(module)\n        }\n      }\n    }\n\n    if (!asyncRequires) {\n      throw new Error(`couldn't find async-requires module`)\n    }\n\n    const clientSSRLoader = `gatsby/dist/utils/webpack/loaders/client-components-requires-writer-loader?modules=${clientModules\n      .map(\n        module =>\n          `./` +\n          path.relative(\n            compilation.options.context as string,\n            module.userRequest\n          )\n      )\n      .join(`,`)}!`\n\n    const clientComponentEntryDep = webpack.EntryPlugin.createDependency(\n      clientSSRLoader,\n      {\n        name: `app`,\n      }\n    )\n    await this.addEntry(compilation, ``, clientComponentEntryDep, {\n      name: `app`,\n    })\n  }\n\n  addEntry(\n    compilation: Compilation,\n    context: string,\n    entry: any /* Dependency */,\n    options: {\n      name: string\n    } /* EntryOptions */\n  ): Promise<any> /* Promise<module> */ {\n    return new Promise((resolve, reject) => {\n      // @ts-ignore\n      try {\n        const oldEntry = compilation.entries.get(options.name)\n        if (!oldEntry) {\n          resolve(null)\n          return\n        }\n\n        oldEntry.includeDependencies.push(entry)\n        compilation.hooks.addEntry.call(entry, options)\n        compilation.addModuleTree(\n          {\n            context,\n            dependency: entry,\n          },\n          // @ts-ignore\n          (err: Error | undefined, module: any) => {\n            if (err) {\n              compilation.hooks.failedEntry.call(entry, options, err)\n              return reject(err)\n            }\n\n            compilation.hooks.succeedEntry.call(entry, options, module)\n            return resolve(module)\n          }\n        )\n      } catch (e) {\n        console.log({ e })\n        reject(e)\n      }\n    })\n  }\n\n  apply(compiler: webpack.Compiler): void {\n    // Restore manifest from the previous compilation, otherwise it will be wiped since files aren't visited on cached builds\n    compiler.hooks.beforeCompile.tap(this.name, () => {\n      try {\n        const previousManifest = fs.existsSync(this._manifestPath)\n\n        if (!previousManifest) {\n          return\n        }\n\n        this._previousManifest = JSON.parse(\n          fs.readFileSync(this._manifestPath, `utf-8`)\n        )\n      } catch (error) {\n        this._reporter.panic({\n          id: `80001`,\n          context: {},\n          error,\n        })\n      }\n    })\n\n    compiler.hooks.finishMake.tapPromise(this.name, async compilation => {\n      if (compilation.compiler.parentCompilation) {\n        // child compilation happen for css modules for example, we only care about the main compilation\n        return\n      }\n      await this.addClientModuleEntries(compiler, compilation)\n    })\n\n    compiler.hooks.thisCompilation.tap(\n      this.name,\n      (compilation, { normalModuleFactory }) => {\n        const parserCallback = (parser: javascript.JavascriptParser): void => {\n          parser.hooks.program.tap(this.name, ast => {\n            const hasClientExportDirective = ast.body.find(\n              statement =>\n                statement.type === `ExpressionStatement` &&\n                (statement as IDirective).directive === `use client`\n            )\n\n            const module = parser.state.module\n\n            if (hasClientExportDirective) {\n              // this metadata will be preserved on warm builds, so we don't need to force parse modules\n              // each time, as webpack will manage going through parsing of module is invalidated\n              module.buildInfo.rsc = true\n            }\n          })\n        }\n\n        normalModuleFactory.hooks.parser\n          .for(`javascript/auto`)\n          .tap(this.name, parserCallback)\n        normalModuleFactory.hooks.parser\n          .for(`javascript/esm`)\n          .tap(this.name, parserCallback)\n        normalModuleFactory.hooks.parser\n          .for(`javascript/dynamic`)\n          .tap(this.name, parserCallback)\n\n        // add dangling css modules to the app entry\n        compilation.hooks.optimizeChunks.tap(this.name, () => {\n          let appChunk: webpack.Chunk | null = null\n          for (const chunk of compilation.chunks) {\n            if (chunk.name === `app`) {\n              appChunk = chunk\n              break\n            }\n          }\n\n          if (!appChunk) {\n            throw new Error(`\"app\" chunk not found`)\n          }\n\n          const modulesToInsertIntoApp: Array<webpack.Module> = []\n\n          for (const cssModule of this._collectedCssModules) {\n            const usedInChunks =\n              compilation.chunkGraph.getModuleChunksIterable(cssModule)\n\n            let isInAnyChunk = false\n\n            for (const _ of usedInChunks) {\n              isInAnyChunk = true\n              break\n            }\n            if (!isInAnyChunk) {\n              modulesToInsertIntoApp.push(cssModule)\n            }\n          }\n\n          for (const cssModule of modulesToInsertIntoApp.sort(\n            (a, b) =>\n              compilation.moduleGraph.getPostOrderIndex(a) -\n              compilation.moduleGraph.getPostOrderIndex(b)\n          )) {\n            compilation.chunkGraph.connectChunkAndModule(appChunk, cssModule)\n\n            for (const group of appChunk.groupsIterable) {\n              if (!group.getModulePostOrderIndex(cssModule)) {\n                group.setModulePostOrderIndex(\n                  cssModule,\n                  // @ts-ignore\n                  group._modulePostOrderIndices.size + 1\n                )\n              }\n            }\n          }\n        })\n\n        // generate client components manifest\n        compilation.hooks.processAssets.tap(\n          {\n            name: this.name,\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_REPORT,\n          },\n          () => {\n            const manifest = this._generateManifest(\n              compilation,\n              compilation.options.context as string\n            )\n\n            /**\n             * `emitAsset` is unclear about what the path should be relative to and absolute paths don't work. This works so we'll go with that.\n             * @see {@link https://webpack.js.org/api/compilation-object/#emitasset}\n             */\n            const emitManifestPath = `..${this._manifestPath.replace(\n              compiler.context,\n              ``\n            )}`\n\n            compilation.emitAsset(\n              emitManifestPath,\n              new webpack.sources.RawSource(\n                JSON.stringify(\n                  { ...this._previousManifest, ...manifest },\n                  null,\n                  2\n                ),\n                false\n              )\n            )\n          }\n        )\n      }\n    )\n  }\n}\n"],"mappings":"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"}