{"version":3,"file":"validate-component.js","names":["validationCache","Set","isNotTestEnv","process","env","NODE_ENV","isProductionEnv","validateComponent","args","input","pluginName","errorIdMap","component","error","id","noPath","context","componentPath","getPathToLayoutComponent","errorContext","has","path","isAbsolute","notAbsolute","fs","existsSync","doesNotExist","includes","fileContent","readFileSync","empty","panicOnBuild","extname","includesDefaultExport","match","noDefaultExport","add","clearValidationCache","clear"],"sources":["../../src/utils/validate-component.ts"],"sourcesContent":["import path from \"path\"\nimport fs from \"fs-extra\"\nimport { getPathToLayoutComponent } from \"gatsby-core-utils/parse-component-path\"\nimport { IPageInput as ICreatePageInput } from \"../redux/actions/public\"\nimport { ICreateSliceInput } from \"../redux/actions/restricted\"\n\nconst validationCache = new Set<string>()\n\ninterface IErrorMeta {\n  id: string\n  context: Record<string, unknown>\n}\n\ninterface IErrorIdMap {\n  noPath: string\n  notAbsolute: string\n  doesNotExist: string\n  empty: string\n  noDefaultExport: string\n}\n\nconst isNotTestEnv = process.env.NODE_ENV !== `test`\nconst isProductionEnv = process.env.NODE_ENV === `production`\n\nexport function validateComponent(args: {\n  input: ICreatePageInput | ICreateSliceInput\n  pluginName: string\n  errorIdMap: IErrorIdMap\n}): { error?: IErrorMeta; panicOnBuild?: boolean } {\n  const { input, pluginName, errorIdMap } = args || {}\n\n  // No component path passed\n  if (!input?.component) {\n    return {\n      error: {\n        id: errorIdMap.noPath,\n        context: {\n          pluginName,\n          input,\n        },\n      },\n    }\n  }\n\n  const componentPath = getPathToLayoutComponent(input?.component)\n\n  const errorContext = {\n    input,\n    pluginName,\n    componentPath,\n  }\n\n  // Component path already validated in previous pass\n  if (validationCache.has(componentPath)) {\n    return {}\n  }\n\n  // Component path must be absolute\n  if (!path.isAbsolute(componentPath)) {\n    return {\n      error: {\n        id: errorIdMap.notAbsolute,\n        context: errorContext,\n      },\n    }\n  }\n\n  // Component path must exist\n  if (isNotTestEnv) {\n    if (!fs.existsSync(componentPath)) {\n      return {\n        error: {\n          id: errorIdMap.doesNotExist,\n          context: errorContext,\n        },\n      }\n    }\n  }\n\n  if (!componentPath.includes(`/.cache/`) && isProductionEnv) {\n    const fileContent = fs.readFileSync(componentPath, `utf-8`)\n\n    // Component must not be empty\n    if (fileContent === ``) {\n      return {\n        error: {\n          id: errorIdMap.empty,\n          context: errorContext,\n        },\n        panicOnBuild: true,\n      }\n    }\n\n    // Component must have a default export\n    if ([`.js`, `.jsx`, `.ts`, `.tsx`].includes(path.extname(componentPath))) {\n      const includesDefaultExport =\n        fileContent.includes(`export default`) ||\n        fileContent.includes(`module.exports`) ||\n        fileContent.includes(`exports.default`) ||\n        fileContent.includes(`exports[\"default\"]`) ||\n        fileContent.match(/export \\{.* as default.*\\}/s) ||\n        fileContent.match(/export \\{\\s*default\\s*\\}/s)\n\n      if (!includesDefaultExport) {\n        return {\n          error: {\n            id: errorIdMap.noDefaultExport,\n            context: errorContext,\n          },\n          panicOnBuild: true,\n        }\n      }\n    }\n  }\n\n  validationCache.add(componentPath)\n  return {}\n}\n\nexport function clearValidationCache(): void {\n  validationCache.clear()\n}\n"],"mappings":";;;;;;AAAA;AACA;AACA;AAIA,MAAMA,eAAe,GAAG,IAAIC,GAAG,EAAU;AAezC,MAAMC,YAAY,GAAGC,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAM,MAAK;AACpD,MAAMC,eAAe,GAAGH,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAM,YAAW;AAEtD,SAASE,iBAAiB,CAACC,IAIjC,EAAkD;EACjD,MAAM;IAAEC,KAAK;IAAEC,UAAU;IAAEC;EAAW,CAAC,GAAGH,IAAI,IAAI,CAAC,CAAC;;EAEpD;EACA,IAAI,EAACC,KAAK,aAALA,KAAK,eAALA,KAAK,CAAEG,SAAS,GAAE;IACrB,OAAO;MACLC,KAAK,EAAE;QACLC,EAAE,EAAEH,UAAU,CAACI,MAAM;QACrBC,OAAO,EAAE;UACPN,UAAU;UACVD;QACF;MACF;IACF,CAAC;EACH;EAEA,MAAMQ,aAAa,GAAG,IAAAC,4CAAwB,EAACT,KAAK,aAALA,KAAK,uBAALA,KAAK,CAAEG,SAAS,CAAC;EAEhE,MAAMO,YAAY,GAAG;IACnBV,KAAK;IACLC,UAAU;IACVO;EACF,CAAC;;EAED;EACA,IAAIjB,eAAe,CAACoB,GAAG,CAACH,aAAa,CAAC,EAAE;IACtC,OAAO,CAAC,CAAC;EACX;;EAEA;EACA,IAAI,CAACI,aAAI,CAACC,UAAU,CAACL,aAAa,CAAC,EAAE;IACnC,OAAO;MACLJ,KAAK,EAAE;QACLC,EAAE,EAAEH,UAAU,CAACY,WAAW;QAC1BP,OAAO,EAAEG;MACX;IACF,CAAC;EACH;;EAEA;EACA,IAAIjB,YAAY,EAAE;IAChB,IAAI,CAACsB,gBAAE,CAACC,UAAU,CAACR,aAAa,CAAC,EAAE;MACjC,OAAO;QACLJ,KAAK,EAAE;UACLC,EAAE,EAAEH,UAAU,CAACe,YAAY;UAC3BV,OAAO,EAAEG;QACX;MACF,CAAC;IACH;EACF;EAEA,IAAI,CAACF,aAAa,CAACU,QAAQ,CAAE,UAAS,CAAC,IAAIrB,eAAe,EAAE;IAC1D,MAAMsB,WAAW,GAAGJ,gBAAE,CAACK,YAAY,CAACZ,aAAa,EAAG,OAAM,CAAC;;IAE3D;IACA,IAAIW,WAAW,KAAM,EAAC,EAAE;MACtB,OAAO;QACLf,KAAK,EAAE;UACLC,EAAE,EAAEH,UAAU,CAACmB,KAAK;UACpBd,OAAO,EAAEG;QACX,CAAC;QACDY,YAAY,EAAE;MAChB,CAAC;IACH;;IAEA;IACA,IAAI,CAAE,KAAI,EAAG,MAAK,EAAG,KAAI,EAAG,MAAK,CAAC,CAACJ,QAAQ,CAACN,aAAI,CAACW,OAAO,CAACf,aAAa,CAAC,CAAC,EAAE;MACxE,MAAMgB,qBAAqB,GACzBL,WAAW,CAACD,QAAQ,CAAE,gBAAe,CAAC,IACtCC,WAAW,CAACD,QAAQ,CAAE,gBAAe,CAAC,IACtCC,WAAW,CAACD,QAAQ,CAAE,iBAAgB,CAAC,IACvCC,WAAW,CAACD,QAAQ,CAAE,oBAAmB,CAAC,IAC1CC,WAAW,CAACM,KAAK,CAAC,6BAA6B,CAAC,IAChDN,WAAW,CAACM,KAAK,CAAC,2BAA2B,CAAC;MAEhD,IAAI,CAACD,qBAAqB,EAAE;QAC1B,OAAO;UACLpB,KAAK,EAAE;YACLC,EAAE,EAAEH,UAAU,CAACwB,eAAe;YAC9BnB,OAAO,EAAEG;UACX,CAAC;UACDY,YAAY,EAAE;QAChB,CAAC;MACH;IACF;EACF;EAEA/B,eAAe,CAACoC,GAAG,CAACnB,aAAa,CAAC;EAClC,OAAO,CAAC,CAAC;AACX;AAEO,SAASoB,oBAAoB,GAAS;EAC3CrC,eAAe,CAACsC,KAAK,EAAE;AACzB"}