{"version":3,"file":"node-manifest.js","names":["ONE_DAY","DEFAULT_MAX_DAYS_OLD","nodeManifestReducer","state","action","type","manifestId","pluginName","node","updatedAtUTC","payload","maxDaysOld","Number","process","env","NODE_MANIFEST_MAX_DAYS_OLD","nodeLastUpdatedAtUTC","Date","getTime","isNaN","reporter","warn","shouldCreateNodeManifest","now","id","push"],"sources":["../../../src/redux/reducers/node-manifest.ts"],"sourcesContent":["import reporter from \"gatsby-cli/lib/reporter\"\n\nimport {\n  IGatsbyState,\n  ICreateNodeManifest,\n  IDeleteNodeManifests,\n} from \"../types\"\n\nconst ONE_DAY = 1000 * 60 * 60 * 24 // ms * sec * min * hr.\nconst DEFAULT_MAX_DAYS_OLD = 30\n\nexport const nodeManifestReducer = (\n  state: IGatsbyState[\"nodeManifests\"] = [],\n  action: ICreateNodeManifest | IDeleteNodeManifests\n): IGatsbyState[\"nodeManifests\"] => {\n  switch (action.type) {\n    case `CREATE_NODE_MANIFEST`: {\n      const { manifestId, pluginName, node, updatedAtUTC } = action.payload\n\n      const maxDaysOld =\n        Number(process.env.NODE_MANIFEST_MAX_DAYS_OLD) || DEFAULT_MAX_DAYS_OLD\n\n      if (updatedAtUTC) {\n        const nodeLastUpdatedAtUTC: number = new Date(updatedAtUTC).getTime()\n        if (\n          (nodeLastUpdatedAtUTC as any) instanceof Date &&\n          !isNaN(nodeLastUpdatedAtUTC)\n        ) {\n          reporter.warn(\n            `Plugin ${pluginName} called unstable_createNodeManifest with an updatedAtUTC that isn't a proper value to instantiate a Date.`\n          )\n\n          return state\n        }\n\n        const shouldCreateNodeManifest =\n          Date.now() - nodeLastUpdatedAtUTC <= maxDaysOld * ONE_DAY\n\n        if (!shouldCreateNodeManifest) {\n          return state\n        }\n      }\n\n      if (typeof manifestId !== `string`) {\n        reporter.warn(\n          `Plugin ${pluginName} called unstable_createNodeManifest with a manifestId that isn't a string.`\n        )\n\n        return state\n      }\n\n      if (!node?.id) {\n        reporter.warn(\n          `Plugin ${pluginName} called unstable_createNodeManifest but didn't provide a node.`\n        )\n\n        return state\n      }\n\n      state.push({\n        manifestId,\n        pluginName,\n        node: {\n          id: node.id,\n        },\n      })\n\n      return state\n    }\n\n    case `DELETE_NODE_MANIFESTS`: {\n      state = []\n\n      return state\n    }\n\n    default:\n      return state\n  }\n}\n"],"mappings":";;;;;AAAA;AAQA,MAAMA,OAAO,GAAG,IAAI,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,EAAC;AACpC,MAAMC,oBAAoB,GAAG,EAAE;AAExB,MAAMC,mBAAmB,GAAG,CACjCC,KAAoC,GAAG,EAAE,EACzCC,MAAkD,KAChB;EAClC,QAAQA,MAAM,CAACC,IAAI;IACjB,KAAM,sBAAqB;MAAE;QAC3B,MAAM;UAAEC,UAAU;UAAEC,UAAU;UAAEC,IAAI;UAAEC;QAAa,CAAC,GAAGL,MAAM,CAACM,OAAO;QAErE,MAAMC,UAAU,GACdC,MAAM,CAACC,OAAO,CAACC,GAAG,CAACC,0BAA0B,CAAC,IAAId,oBAAoB;QAExE,IAAIQ,YAAY,EAAE;UAChB,MAAMO,oBAA4B,GAAG,IAAIC,IAAI,CAACR,YAAY,CAAC,CAACS,OAAO,EAAE;UACrE,IACGF,oBAAoB,YAAoBC,IAAI,IAC7C,CAACE,KAAK,CAACH,oBAAoB,CAAC,EAC5B;YACAI,iBAAQ,CAACC,IAAI,CACV,UAASd,UAAW,2GAA0G,CAChI;YAED,OAAOJ,KAAK;UACd;UAEA,MAAMmB,wBAAwB,GAC5BL,IAAI,CAACM,GAAG,EAAE,GAAGP,oBAAoB,IAAIL,UAAU,GAAGX,OAAO;UAE3D,IAAI,CAACsB,wBAAwB,EAAE;YAC7B,OAAOnB,KAAK;UACd;QACF;QAEA,IAAI,OAAOG,UAAU,KAAM,QAAO,EAAE;UAClCc,iBAAQ,CAACC,IAAI,CACV,UAASd,UAAW,4EAA2E,CACjG;UAED,OAAOJ,KAAK;QACd;QAEA,IAAI,EAACK,IAAI,aAAJA,IAAI,eAAJA,IAAI,CAAEgB,EAAE,GAAE;UACbJ,iBAAQ,CAACC,IAAI,CACV,UAASd,UAAW,gEAA+D,CACrF;UAED,OAAOJ,KAAK;QACd;QAEAA,KAAK,CAACsB,IAAI,CAAC;UACTnB,UAAU;UACVC,UAAU;UACVC,IAAI,EAAE;YACJgB,EAAE,EAAEhB,IAAI,CAACgB;UACX;QACF,CAAC,CAAC;QAEF,OAAOrB,KAAK;MACd;IAEA,KAAM,uBAAsB;MAAE;QAC5BA,KAAK,GAAG,EAAE;QAEV,OAAOA,KAAK;MACd;IAEA;MACE,OAAOA,KAAK;EAAA;AAElB,CAAC;AAAA"}