{"version":3,"file":"resolve-plugin.js","names":["resolvePlugin","plugin","rootDir","pluginName","resolve","validLocalPlugin","localPluginPath","checkLocalPlugin","packageJSON","JSON","parse","fs","readFileSync","name","warnOnIncompatiblePeerDependency","id","createPluginId","version","createFileContentHash","getResolvedFieldsForPlugin","requireSource","createRequireFromPath","require","resolvedPath","slash","path","dirname","isAbsolute","err","process","env","gatsby_log_level","reporter","panicOnBuild","Error"],"sources":["../../../src/bootstrap/load-plugins/resolve-plugin.ts"],"sourcesContent":["import path from \"path\"\nimport fs from \"fs\"\nimport { slash, createRequireFromPath } from \"gatsby-core-utils\"\nimport { warnOnIncompatiblePeerDependency } from \"./validate\"\nimport { PackageJson } from \"../../..\"\nimport { IPluginInfo, PluginRef } from \"./types\"\nimport { createPluginId } from \"./utils/create-id\"\nimport { createFileContentHash } from \"./utils/create-hash\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { isString } from \"lodash\"\nimport { checkLocalPlugin } from \"./utils/check-local-plugin\"\nimport { getResolvedFieldsForPlugin } from \"../../utils/parcel/compile-gatsby-files\"\n\n/**\n * @param plugin\n * This should be a plugin spec object where possible but can also be the\n * name of a plugin.\n *\n * When it is a name, it can be a name of a local plugin, the name of a plugin\n * located in node_modules, or a Gatsby internal plugin. In the last case the\n * plugin will be an absolute path.\n * @param rootDir\n * This is the project location, from which are found the plugins\n */\nexport function resolvePlugin(plugin: PluginRef, rootDir: string): IPluginInfo {\n  const pluginName = isString(plugin) ? plugin : plugin.resolve\n\n  // Handle local plugins\n  const { validLocalPlugin, localPluginPath = `` } = checkLocalPlugin(\n    plugin,\n    rootDir\n  )\n\n  if (validLocalPlugin && localPluginPath) {\n    const packageJSON = JSON.parse(\n      fs.readFileSync(`${localPluginPath}/package.json`, `utf-8`)\n    ) as PackageJson\n    const name = packageJSON.name || pluginName\n    warnOnIncompatiblePeerDependency(name, packageJSON)\n\n    return {\n      resolve: localPluginPath,\n      name,\n      id: createPluginId(name),\n      version:\n        packageJSON?.version || createFileContentHash(localPluginPath, `**`),\n      ...getResolvedFieldsForPlugin(rootDir, name),\n    }\n  }\n\n  /**\n   * Here we have an absolute path to an internal plugin, or a name of a module\n   * which should be located in node_modules.\n   */\n  try {\n    const requireSource =\n      rootDir !== null\n        ? createRequireFromPath(`${rootDir}/:internal:`)\n        : require\n\n    // If the path is absolute, resolve the directory of the internal plugin,\n    // otherwise resolve the directory containing the package.json\n    const resolvedPath = slash(\n      path.dirname(\n        requireSource.resolve(\n          path.isAbsolute(pluginName)\n            ? pluginName\n            : `${pluginName}/package.json`\n        )\n      )\n    )\n\n    const packageJSON = JSON.parse(\n      fs.readFileSync(`${resolvedPath}/package.json`, `utf-8`)\n    )\n    warnOnIncompatiblePeerDependency(packageJSON.name, packageJSON)\n\n    return {\n      resolve: resolvedPath,\n      id: createPluginId(packageJSON.name),\n      name: packageJSON.name,\n      version: packageJSON.version,\n    }\n  } catch (err) {\n    if (process.env.gatsby_log_level === `verbose`) {\n      reporter.panicOnBuild(\n        `plugin \"${pluginName} threw the following error:\\n`,\n        err\n      )\n    } else {\n      reporter.panicOnBuild(\n        `There was a problem loading plugin \"${pluginName}\". Perhaps you need to install its package?\\nUse --verbose to see actual error.`\n      )\n    }\n    throw new Error(`unreachable`)\n  }\n}\n"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AAGA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,aAAa,CAACC,MAAiB,EAAEC,OAAe,EAAe;EAC7E,MAAMC,UAAU,GAAG,wBAASF,MAAM,CAAC,GAAGA,MAAM,GAAGA,MAAM,CAACG,OAAO;;EAE7D;EACA,MAAM;IAAEC,gBAAgB;IAAEC,eAAe,GAAI;EAAE,CAAC,GAAG,IAAAC,kCAAgB,EACjEN,MAAM,EACNC,OAAO,CACR;EAED,IAAIG,gBAAgB,IAAIC,eAAe,EAAE;IACvC,MAAME,WAAW,GAAGC,IAAI,CAACC,KAAK,CAC5BC,WAAE,CAACC,YAAY,CAAE,GAAEN,eAAgB,eAAc,EAAG,OAAM,CAAC,CAC7C;IAChB,MAAMO,IAAI,GAAGL,WAAW,CAACK,IAAI,IAAIV,UAAU;IAC3C,IAAAW,0CAAgC,EAACD,IAAI,EAAEL,WAAW,CAAC;IAEnD,OAAO;MACLJ,OAAO,EAAEE,eAAe;MACxBO,IAAI;MACJE,EAAE,EAAE,IAAAC,wBAAc,EAACH,IAAI,CAAC;MACxBI,OAAO,EACL,CAAAT,WAAW,aAAXA,WAAW,uBAAXA,WAAW,CAAES,OAAO,KAAI,IAAAC,iCAAqB,EAACZ,eAAe,EAAG,IAAG,CAAC;MACtE,GAAG,IAAAa,8CAA0B,EAACjB,OAAO,EAAEW,IAAI;IAC7C,CAAC;EACH;;EAEA;AACF;AACA;AACA;EACE,IAAI;IACF,MAAMO,aAAa,GACjBlB,OAAO,KAAK,IAAI,GACZ,IAAAmB,sCAAqB,EAAE,GAAEnB,OAAQ,aAAY,CAAC,GAC9CoB,OAAO;;IAEb;IACA;IACA,MAAMC,YAAY,GAAG,IAAAC,sBAAK,EACxBC,aAAI,CAACC,OAAO,CACVN,aAAa,CAAChB,OAAO,CACnBqB,aAAI,CAACE,UAAU,CAACxB,UAAU,CAAC,GACvBA,UAAU,GACT,GAAEA,UAAW,eAAc,CACjC,CACF,CACF;IAED,MAAMK,WAAW,GAAGC,IAAI,CAACC,KAAK,CAC5BC,WAAE,CAACC,YAAY,CAAE,GAAEW,YAAa,eAAc,EAAG,OAAM,CAAC,CACzD;IACD,IAAAT,0CAAgC,EAACN,WAAW,CAACK,IAAI,EAAEL,WAAW,CAAC;IAE/D,OAAO;MACLJ,OAAO,EAAEmB,YAAY;MACrBR,EAAE,EAAE,IAAAC,wBAAc,EAACR,WAAW,CAACK,IAAI,CAAC;MACpCA,IAAI,EAAEL,WAAW,CAACK,IAAI;MACtBI,OAAO,EAAET,WAAW,CAACS;IACvB,CAAC;EACH,CAAC,CAAC,OAAOW,GAAG,EAAE;IACZ,IAAIC,OAAO,CAACC,GAAG,CAACC,gBAAgB,KAAM,SAAQ,EAAE;MAC9CC,iBAAQ,CAACC,YAAY,CAClB,WAAU9B,UAAW,+BAA8B,EACpDyB,GAAG,CACJ;IACH,CAAC,MAAM;MACLI,iBAAQ,CAACC,YAAY,CAClB,uCAAsC9B,UAAW,iFAAgF,CACnI;IACH;IACA,MAAM,IAAI+B,KAAK,CAAE,aAAY,CAAC;EAChC;AACF"}