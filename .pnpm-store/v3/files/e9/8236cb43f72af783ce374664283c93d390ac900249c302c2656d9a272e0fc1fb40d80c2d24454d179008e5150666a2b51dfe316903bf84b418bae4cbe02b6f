{"version":3,"file":"render-dev-html.js","names":["startWorker","newWorker","WorkerPool","require","resolve","numWorkers","env","NODE_ENV","isCI","forceColors","GATSBY_EXPERIMENTAL_DEV_SSR","worker","initDevWorkerPool","changeCount","restartWorker","htmlComponentRendererPath","oldWorker","end","all","deleteModuleCache","cache","searchFileForString","substring","filePath","Promise","escapedSubString","replace","chunkRegex","RegExp","stream","fs","createReadStream","found","on","d","test","toString","close","ensurePathComponentInSSRBundle","page","directory","allowTimedFallback","report","panic","nodePath","join","ROUTES_DIRECTORY","componentChunkName","readAttempts","searchForStringInterval","setInterval","clearInterval","renderDevHTML","path","skipSsr","store","error","undefined","req","reject","startListener","pageObj","findPageByPath","getState","isClientOnlyPage","matchPath","actions","createServerVisitedPage","dispatch","getPageDataExperimental","Number","MAX_SAFE_INTEGER","recompileAndResumeWatching","needToRecompileSSRBundle","getDevSSRWebpack","stopWatching","serverData","pageMode","getPageMode","renderer","componentInstance","getPageChunk","getServerData","err","parseError","componentPath","component","publicDir","htmlString","single","renderHTML","props","html"],"sources":["../../../src/utils/dev-ssr/render-dev-html.ts"],"sourcesContent":["import { WorkerPool } from \"gatsby-worker\"\nimport fs from \"fs-extra\"\nimport nodePath from \"path\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport { isCI } from \"gatsby-core-utils\"\nimport type { Request } from \"express\"\nimport { ROUTES_DIRECTORY } from \"../../constants\"\nimport { startListener } from \"../../bootstrap/requires-writer\"\nimport { findPageByPath } from \"../find-page-by-path\"\nimport { getPageData as getPageDataExperimental } from \"../get-page-data\"\nimport { getDevSSRWebpack } from \"../../commands/build-html\"\nimport { GatsbyReduxStore } from \"../../redux\"\nimport { IGatsbyPage } from \"../../redux/types\"\nimport { getServerData, IServerData } from \"../get-server-data\"\nimport { getPageMode } from \"../page-mode\"\nimport { parseError, IErrorRenderMeta } from \"./parse-error\"\n\ntype GatsbyDevSSRWorkerPool = WorkerPool<\n  typeof import(\"./render-dev-html-child\")\n>\n\nconst startWorker = (): GatsbyDevSSRWorkerPool => {\n  const newWorker = new WorkerPool<typeof import(\"./render-dev-html-child\")>(\n    require.resolve(`./render-dev-html-child`),\n    {\n      numWorkers: 1,\n      env: {\n        NODE_ENV: isCI() ? `production` : `development`,\n        forceColors: `true`,\n        GATSBY_EXPERIMENTAL_DEV_SSR: `true`,\n      },\n    }\n  )\n\n  return newWorker\n}\n\nlet worker: GatsbyDevSSRWorkerPool\nexport const initDevWorkerPool = (): void => {\n  worker = startWorker()\n}\n\nlet changeCount = 0\nexport const restartWorker = (htmlComponentRendererPath: string): void => {\n  changeCount += 1\n  // Forking is expensive — each time we re-require the outputted webpack\n  // file, memory grows ~10 mb — 25 regenerations means ~250mb which seems\n  // like an acceptable amount of memory to grow before we reclaim it\n  // by rebooting the worker process.\n  if (changeCount > 25) {\n    const oldWorker = worker\n    const newWorker = startWorker()\n    worker = newWorker\n    oldWorker.end()\n    changeCount = 0\n  } else {\n    worker.all.deleteModuleCache(htmlComponentRendererPath)\n    delete require.cache[require.resolve(htmlComponentRendererPath)]\n  }\n}\n\nconst searchFileForString = (\n  substring: string,\n  filePath: string\n): Promise<boolean> =>\n  new Promise(resolve => {\n    const escapedSubString = substring.replace(/[.*+?^${}()|[\\]\\\\]/g, `\\\\$&`)\n\n    // See if the chunk is in the newComponents array (not the notVisited).\n    const chunkRegex = RegExp(\n      `exports.ssrComponents.*${escapedSubString}.*}`,\n      `gs`\n    )\n    const stream = fs.createReadStream(filePath)\n    let found = false\n    stream.on(`data`, function (d) {\n      if (chunkRegex.test(d.toString())) {\n        found = true\n        stream.close()\n        resolve(found)\n      }\n    })\n    stream.on(`error`, function () {\n      resolve(found)\n    })\n    stream.on(`close`, function () {\n      resolve(found)\n    })\n  })\n\nconst ensurePathComponentInSSRBundle = async (\n  page: IGatsbyPage,\n  directory: string,\n  allowTimedFallback: boolean\n): Promise<boolean> => {\n  // This shouldn't happen.\n  if (!page) {\n    report.panic(`page not found`, page)\n  }\n\n  // Now check if it's written to the correct path\n  const htmlComponentRendererPath = nodePath.join(\n    directory,\n    ROUTES_DIRECTORY,\n    `render-page.js`\n  )\n\n  // This search takes 1-10ms\n  // We do it as there can be a race conditions where two pages\n  // are requested at the same time which means that both are told render-page.js\n  // has changed when the first page is complete meaning the second\n  // page's component won't be in the render meaning its SSR will fail.\n  let found = await searchFileForString(\n    page.componentChunkName,\n    htmlComponentRendererPath\n  )\n\n  if (!found) {\n    await new Promise<void>(resolve => {\n      let readAttempts = 0\n      const searchForStringInterval = setInterval(async () => {\n        readAttempts += 1\n        found = await searchFileForString(\n          page.componentChunkName,\n          htmlComponentRendererPath\n        )\n        if (found || (allowTimedFallback && readAttempts > 5)) {\n          clearInterval(searchForStringInterval)\n          resolve()\n        }\n      }, 300)\n    })\n  }\n\n  return found\n}\n\ninterface IRenderDevHtmlProps {\n  path: string\n  page?: IGatsbyPage\n  skipSsr?: boolean\n  store: GatsbyReduxStore\n  error?: IErrorRenderMeta\n  htmlComponentRendererPath: string\n  directory: string\n  req: Request\n  allowTimedFallback: boolean\n}\n\nexport const renderDevHTML = ({\n  path,\n  page,\n  skipSsr = false,\n  store,\n  error = undefined,\n  htmlComponentRendererPath,\n  allowTimedFallback,\n  directory,\n  req,\n}: IRenderDevHtmlProps): Promise<{ html: string; serverData?: IServerData }> =>\n  // eslint-disable-next-line no-async-promise-executor\n  new Promise(async (resolve, reject) => {\n    startListener()\n    let pageObj\n    if (!page) {\n      pageObj = findPageByPath(store.getState(), path)\n    } else {\n      pageObj = page\n    }\n\n    let isClientOnlyPage = false\n    if (pageObj.matchPath) {\n      isClientOnlyPage = true\n    }\n\n    const { actions } = require(`../../redux/actions`)\n    const { createServerVisitedPage } = actions\n    // Record this page was requested. This will kick off adding its page\n    // component to the ssr bundle (if that's not already happened)\n    store.dispatch(createServerVisitedPage(pageObj.componentChunkName))\n\n    // Ensure the query has been run and written out.\n    try {\n      await getPageDataExperimental(\n        pageObj.path,\n        // 15000 is default timeout for this function - we keep it here for scenarios\n        // that allow waiting on it, and set to impossibly high value in case\n        // we want to ensure SSR happens\n        allowTimedFallback ? 15000 : Number.MAX_SAFE_INTEGER\n      )\n    } catch {\n      // If we can't get the page, it was probably deleted recently\n      // so let's just do a 404 page.\n      return reject(`404 page`)\n    }\n\n    // Resume the webpack watcher and wait for any compilation necessary to happen.\n    // We timeout after 1.5s as the user might not care per se about SSR.\n    //\n    // We pause and resume so there's no excess webpack activity during normal development.\n    const { recompileAndResumeWatching, needToRecompileSSRBundle } =\n      getDevSSRWebpack()\n\n    let stopWatching: (() => void) | undefined = undefined\n    if (recompileAndResumeWatching && needToRecompileSSRBundle) {\n      stopWatching = await recompileAndResumeWatching(allowTimedFallback)\n    }\n\n    // Wait for html-renderer to update w/ the page component.\n    // Note that webpack is still in watching mode, so even if it didn't recompile\n    // everything needed yet (there is debouncing happening in webpack), it still\n    // might update the bundle (until we call `stopWatching()` after check that component\n    // is in bundle)\n    const found = await ensurePathComponentInSSRBundle(\n      pageObj,\n      directory,\n      allowTimedFallback\n    )\n\n    if (stopWatching) {\n      stopWatching()\n    }\n\n    // If we can't find the page, just force set isClientOnlyPage\n    // which skips rendering the body (so we just serve a shell)\n    // and the page will render normally on the client.\n    //\n    // This only happens on the first time we try to render a page component\n    // and it's taking a while to bundle its page component.\n    if (!found) {\n      isClientOnlyPage = true\n    }\n\n    // If the user added the query string `skip-ssr`, we always just render an empty shell.\n    if (skipSsr) {\n      isClientOnlyPage = true\n    }\n\n    let serverData: IServerData | undefined = undefined\n    const pageMode = getPageMode(pageObj)\n    if (pageMode === `SSR` && found && !isClientOnlyPage) {\n      const renderer = require(htmlComponentRendererPath)\n      const componentInstance = await renderer.getPageChunk(pageObj)\n\n      try {\n        serverData = await getServerData(\n          req,\n          pageObj,\n          req.path,\n          componentInstance\n        )\n      } catch (err) {\n        return reject(\n          parseError({\n            err,\n            directory,\n            componentPath: pageObj.component,\n            htmlComponentRendererPath,\n          })\n        )\n      }\n    }\n\n    const publicDir = nodePath.join(directory, `public`)\n\n    try {\n      const htmlString = await worker.single.renderHTML({\n        path,\n        componentPath: pageObj.component,\n        htmlComponentRendererPath,\n        directory,\n        publicDir,\n        isClientOnlyPage,\n        error,\n        serverData: serverData?.props,\n      })\n      return resolve({ html: htmlString, serverData })\n    } catch (error) {\n      return reject(error)\n    }\n  })\n"],"mappings":"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"}