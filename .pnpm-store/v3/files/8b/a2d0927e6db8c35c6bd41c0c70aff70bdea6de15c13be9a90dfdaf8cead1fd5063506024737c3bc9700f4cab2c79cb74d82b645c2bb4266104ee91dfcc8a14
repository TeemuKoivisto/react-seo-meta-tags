{"version":3,"file":"cache.js","names":["MAX_CACHE_SIZE","TTL","Number","MAX_SAFE_INTEGER","GatsbyCache","constructor","name","store","fsStore","directory","path","join","global","__GATSBY","root","process","cwd","init","fs","ensureDirSync","configs","max","ttl","options","caches","map","cache","manager","caching","multiCaching","get","key","Promise","resolve","Error","err","res","undefined","set","value","args","del"],"sources":["../../src/utils/cache.ts"],"sourcesContent":["import manager, {\n  Store,\n  StoreConfig,\n  CachingConfig,\n  MultiCache,\n} from \"cache-manager\"\nimport fs from \"fs-extra\"\nimport * as fsStore from \"../cache/cache-fs\"\nimport path from \"path\"\n\nconst MAX_CACHE_SIZE = 250\nconst TTL = Number.MAX_SAFE_INTEGER\n\ninterface ICacheProperties {\n  name?: string\n  store?: Store\n}\n\nexport default class GatsbyCache {\n  public name: string\n  public store: Store\n  public directory: string\n  // TODO: remove `.cache` in v4. This is compat mode - cache-manager cache implementation\n  // expose internal cache that gives access to `.del` function that wasn't available in public\n  // cache interface (gatsby-plugin-sharp use it to clear no longer needed data)\n  public cache?: MultiCache\n\n  // @ts-ignore - set & get types are missing from fsStore?\n  constructor({ name = `db`, store = fsStore }: ICacheProperties = {}) {\n    this.name = name\n    this.store = store\n    this.directory = path.join(\n      global.__GATSBY?.root ?? process.cwd(),\n      `.cache`,\n      `caches`,\n      name\n    )\n  }\n\n  init(): GatsbyCache {\n    fs.ensureDirSync(this.directory)\n\n    const configs: Array<StoreConfig> = [\n      {\n        store: `memory`,\n        max: MAX_CACHE_SIZE,\n        ttl: TTL,\n      },\n      {\n        store: this.store,\n        ttl: TTL,\n        options: {\n          path: this.directory,\n          ttl: TTL,\n        },\n      },\n    ]\n\n    const caches = configs.map(cache => manager.caching(cache))\n\n    this.cache = manager.multiCaching(caches)\n\n    return this\n  }\n\n  async get<T = unknown>(key): Promise<T | undefined> {\n    return new Promise(resolve => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`\n        )\n      }\n      this.cache.get<T>(key, (err, res) => {\n        resolve(err ? undefined : res)\n      })\n    })\n  }\n\n  async set<T>(\n    key: string,\n    value: T,\n    args: CachingConfig = { ttl: TTL }\n  ): Promise<T | undefined> {\n    return new Promise(resolve => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`\n        )\n      }\n      this.cache.set(key, value, args, err => {\n        resolve(err ? undefined : value)\n      })\n    })\n  }\n\n  async del(key: string): Promise<void> {\n    if (!this.cache) {\n      throw new Error(\n        `GatsbyCache wasn't initialised yet, please run the init method first`\n      )\n    }\n\n    return this.cache.del(key)\n  }\n}\n"],"mappings":";;;;;AAAA;AAMA;AACA;AACA;AAAuB;AAAA;AAEvB,MAAMA,cAAc,GAAG,GAAG;AAC1B,MAAMC,GAAG,GAAGC,MAAM,CAACC,gBAAgB;AAOpB,MAAMC,WAAW,CAAC;EAI/B;EACA;EACA;;EAGA;EACAC,WAAW,CAAC;IAAEC,IAAI,GAAI,IAAG;IAAEC,KAAK,GAAGC;EAA0B,CAAC,GAAG,CAAC,CAAC,EAAE;IAAA;IACnE,IAAI,CAACF,IAAI,GAAGA,IAAI;IAChB,IAAI,CAACC,KAAK,GAAGA,KAAK;IAClB,IAAI,CAACE,SAAS,GAAGC,aAAI,CAACC,IAAI,8CACxBC,MAAM,CAACC,QAAQ,qDAAf,iBAAiBC,IAAI,yEAAIC,OAAO,CAACC,GAAG,EAAE,EACrC,QAAO,EACP,QAAO,EACRV,IAAI,CACL;EACH;EAEAW,IAAI,GAAgB;IAClBC,gBAAE,CAACC,aAAa,CAAC,IAAI,CAACV,SAAS,CAAC;IAEhC,MAAMW,OAA2B,GAAG,CAClC;MACEb,KAAK,EAAG,QAAO;MACfc,GAAG,EAAErB,cAAc;MACnBsB,GAAG,EAAErB;IACP,CAAC,EACD;MACEM,KAAK,EAAE,IAAI,CAACA,KAAK;MACjBe,GAAG,EAAErB,GAAG;MACRsB,OAAO,EAAE;QACPb,IAAI,EAAE,IAAI,CAACD,SAAS;QACpBa,GAAG,EAAErB;MACP;IACF,CAAC,CACF;IAED,MAAMuB,MAAM,GAAGJ,OAAO,CAACK,GAAG,CAACC,KAAK,IAAIC,qBAAO,CAACC,OAAO,CAACF,KAAK,CAAC,CAAC;IAE3D,IAAI,CAACA,KAAK,GAAGC,qBAAO,CAACE,YAAY,CAACL,MAAM,CAAC;IAEzC,OAAO,IAAI;EACb;EAEA,MAAMM,GAAG,CAAcC,GAAG,EAA0B;IAClD,OAAO,IAAIC,OAAO,CAACC,OAAO,IAAI;MAC5B,IAAI,CAAC,IAAI,CAACP,KAAK,EAAE;QACf,MAAM,IAAIQ,KAAK,CACZ,sEAAqE,CACvE;MACH;MACA,IAAI,CAACR,KAAK,CAACI,GAAG,CAAIC,GAAG,EAAE,CAACI,GAAG,EAAEC,GAAG,KAAK;QACnCH,OAAO,CAACE,GAAG,GAAGE,SAAS,GAAGD,GAAG,CAAC;MAChC,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;EAEA,MAAME,GAAG,CACPP,GAAW,EACXQ,KAAQ,EACRC,IAAmB,GAAG;IAAElB,GAAG,EAAErB;EAAI,CAAC,EACV;IACxB,OAAO,IAAI+B,OAAO,CAACC,OAAO,IAAI;MAC5B,IAAI,CAAC,IAAI,CAACP,KAAK,EAAE;QACf,MAAM,IAAIQ,KAAK,CACZ,sEAAqE,CACvE;MACH;MACA,IAAI,CAACR,KAAK,CAACY,GAAG,CAACP,GAAG,EAAEQ,KAAK,EAAEC,IAAI,EAAEL,GAAG,IAAI;QACtCF,OAAO,CAACE,GAAG,GAAGE,SAAS,GAAGE,KAAK,CAAC;MAClC,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;EAEA,MAAME,GAAG,CAACV,GAAW,EAAiB;IACpC,IAAI,CAAC,IAAI,CAACL,KAAK,EAAE;MACf,MAAM,IAAIQ,KAAK,CACZ,sEAAqE,CACvE;IACH;IAEA,OAAO,IAAI,CAACR,KAAK,CAACe,GAAG,CAACV,GAAG,CAAC;EAC5B;AACF;AAAC"}