{"version":3,"file":"gatsby-webpack-stats-extractor.js","names":["previousChunkMapJson","previousWebpackStatsJson","GatsbyWebpackStatsExtractor","constructor","publicPath","plugin","name","apply","compiler","hooks","done","tapAsync","stats","assets","assetsMap","childAssets","chunkGroup","compilation","chunkGroups","files","chunk","chunks","chunkReason","PARTIAL_HYDRATION_CHUNK_REASON","push","filter","f","slice","length","map","filename","rel","childChunkGroups","Object","entries","getChildrenByOrders","moduleGraph","chunkGraph","childFiles","childChunkGroup","webpackStats","toJson","all","assetsByChunkName","childAssetsByChunkName","newChunkMapJson","JSON","stringify","fs","writeFile","path","join","process","env","GATSBY_SLICES","scriptChunkMapping","chunkSliceContents","ensureDir","hashSliceContents","hash","assetSliceContents","polyfill","asset","endsWith","app","scriptsSliceHtmlChanged","ensureFileContent","store","dispatch","type","newWebpackStatsJson"],"sources":["../../src/utils/gatsby-webpack-stats-extractor.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport { Compiler } from \"webpack\"\nimport { PARTIAL_HYDRATION_CHUNK_REASON } from \"./webpack/plugins/partial-hydration\"\nimport { store } from \"../redux\"\nimport { ensureFileContent } from \"./ensure-file-content\"\n\nlet previousChunkMapJson: string | undefined\nlet previousWebpackStatsJson: string | undefined\n\nexport class GatsbyWebpackStatsExtractor {\n  private plugin: { name: string }\n  private publicPath: string\n\n  constructor(publicPath: string) {\n    this.plugin = { name: `GatsbyWebpackStatsExtractor` }\n    this.publicPath = publicPath\n  }\n  apply(compiler: Compiler): void {\n    compiler.hooks.done.tapAsync(this.plugin.name, async (stats, done) => {\n      const assets: { [key: string]: Array<string> } = {}\n      const assetsMap = {}\n      const childAssets = {}\n      for (const chunkGroup of stats.compilation.chunkGroups) {\n        if (chunkGroup.name) {\n          const files: Array<string> = []\n          for (const chunk of chunkGroup.chunks) {\n            if (chunk.chunkReason !== PARTIAL_HYDRATION_CHUNK_REASON) {\n              files.push(...chunk.files)\n            }\n          }\n          assets[chunkGroup.name] = files.filter(f => f.slice(-4) !== `.map`)\n          assetsMap[chunkGroup.name] = files\n            .filter(\n              f =>\n                f.slice(-4) !== `.map` &&\n                f.slice(0, chunkGroup.name?.length) === chunkGroup.name\n            )\n            .map(filename => `/${filename}`)\n\n          for (const [rel, childChunkGroups] of Object.entries(\n            chunkGroup.getChildrenByOrders(\n              stats.compilation.moduleGraph,\n              stats.compilation.chunkGraph\n            )\n          )) {\n            if (!(chunkGroup.name in childAssets)) {\n              childAssets[chunkGroup.name] = {}\n            }\n\n            const childFiles: Array<string> = []\n            for (const childChunkGroup of childChunkGroups) {\n              for (const chunk of childChunkGroup.chunks) {\n                childFiles.push(...chunk.files)\n              }\n            }\n\n            childAssets[chunkGroup.name][rel] = childFiles\n          }\n        }\n      }\n\n      const webpackStats = {\n        ...stats.toJson({ all: false, chunkGroups: true }),\n        assetsByChunkName: assets,\n        childAssetsByChunkName: childAssets,\n      }\n\n      const newChunkMapJson = JSON.stringify(assetsMap)\n      if (newChunkMapJson !== previousChunkMapJson) {\n        await fs.writeFile(\n          path.join(`public`, `chunk-map.json`),\n          newChunkMapJson\n        )\n\n        if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n          // Add chunk mapping metadata to scripts slice\n          const scriptChunkMapping = `window.___chunkMapping=${JSON.stringify(\n            newChunkMapJson\n          )};`\n\n          const chunkSliceContents = `\n          <script\n            id=\"gatsby-chunk-mapping\"\n          >\n            ${scriptChunkMapping}\n          </script>\n        `\n\n          await fs.ensureDir(path.join(`public`, `_gatsby`, `slices`))\n\n          const hashSliceContents = `<script>window.___webpackCompilationHash=\"${stats.hash}\";</script>`\n\n          const assetSliceContents: Array<string> = []\n\n          if (`polyfill` in assets && assets.polyfill) {\n            for (const asset of assets.polyfill) {\n              if (asset.endsWith(`.js`)) {\n                assetSliceContents.push(\n                  `<script src=\"${this.publicPath}/${asset}\" nomodule></script>`\n                )\n              }\n            }\n          }\n\n          if (`app` in assets && assets.app) {\n            for (const asset of assets.app) {\n              if (asset.endsWith(`.js`)) {\n                assetSliceContents.push(\n                  `<script src=\"${this.publicPath}/${asset}\" async></script>`\n                )\n              }\n            }\n          }\n\n          const scriptsSliceHtmlChanged = await ensureFileContent(\n            path.join(`public`, `_gatsby`, `slices`, `_gatsby-scripts-1.html`),\n            chunkSliceContents + hashSliceContents + assetSliceContents.join(``)\n          )\n\n          if (scriptsSliceHtmlChanged) {\n            store.dispatch({\n              type: `SLICES_SCRIPTS_REGENERATED`,\n            })\n          }\n        }\n\n        previousChunkMapJson = newChunkMapJson\n      }\n\n      const newWebpackStatsJson = JSON.stringify(webpackStats)\n      if (newWebpackStatsJson !== previousWebpackStatsJson) {\n        await fs.writeFile(\n          path.join(`public`, `webpack.stats.json`),\n          newWebpackStatsJson\n        )\n        previousWebpackStatsJson = newWebpackStatsJson\n      }\n\n      done()\n    })\n  }\n}\n"],"mappings":"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"}