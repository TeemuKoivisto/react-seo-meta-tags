{"version":3,"file":"get-config-file.js","names":["getConfigFile","siteDirectory","configName","distance","compiledResult","attemptImportCompiled","configModule","configFilePath","uncompiledResult","attemptImportUncompiled","attemptImport","configPath","resolveJSFilepath","rootDir","filePath","undefined","importedModule","maybeAddFileProtocol","preferDefault","compiledConfigPath","path","join","COMPILED_CACHE_DIR","error","report","panic","id","context","message","uncompiledConfigPath","testImportError","Error","tsConfig","nearMatch","checkTsAndNearMatch","isTSX","endsWith","isInSrcDir","warn","files","fs","readdir","file","name","ext","parse","isNearMatch"],"sources":["../../src/bootstrap/get-config-file.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport { testImportError } from \"../utils/test-import-error\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport path from \"path\"\nimport { COMPILED_CACHE_DIR } from \"../utils/parcel/compile-gatsby-files\"\nimport { isNearMatch } from \"../utils/is-near-match\"\nimport { resolveJSFilepath, maybeAddFileProtocol } from \"./resolve-js-file-path\"\nimport { preferDefault } from \"./prefer-default\"\n\nexport async function getConfigFile(\n  siteDirectory: string,\n  configName: string,\n  distance: number = 3\n): Promise<{\n  configModule: any\n  configFilePath: string\n}> {\n  const compiledResult = await attemptImportCompiled(siteDirectory, configName)\n\n  if (compiledResult?.configModule && compiledResult?.configFilePath) {\n    return compiledResult\n  }\n\n  const uncompiledResult = await attemptImportUncompiled(\n    siteDirectory,\n    configName,\n    distance\n  )\n\n  return uncompiledResult || {}\n}\n\nasync function attemptImport(\n  siteDirectory: string,\n  configPath: string\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  const configFilePath = await resolveJSFilepath({\n    rootDir: siteDirectory,\n    filePath: configPath,\n  })\n\n  // The file does not exist, no sense trying to import it\n  if (!configFilePath) {\n    return { configFilePath: ``, configModule: undefined }\n  }\n\n  const importedModule = await import(maybeAddFileProtocol(configFilePath))\n  const configModule = preferDefault(importedModule)\n\n  return { configFilePath, configModule }\n}\n\nasync function attemptImportCompiled(\n  siteDirectory: string,\n  configName: string\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  let compiledResult\n\n  try {\n    const compiledConfigPath = path.join(\n      `${siteDirectory}/${COMPILED_CACHE_DIR}`,\n      configName\n    )\n    compiledResult = await attemptImport(siteDirectory, compiledConfigPath)\n  } catch (error) {\n    report.panic({\n      id: `11902`,\n      error: error,\n      context: {\n        configName,\n        message: error.message,\n      },\n    })\n  }\n\n  return compiledResult\n}\n\nasync function attemptImportUncompiled(\n  siteDirectory: string,\n  configName: string,\n  distance: number\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  let uncompiledResult\n\n  const uncompiledConfigPath = path.join(siteDirectory, configName)\n\n  try {\n    uncompiledResult = await attemptImport(siteDirectory, uncompiledConfigPath)\n  } catch (error) {\n    if (!testImportError(uncompiledConfigPath, error)) {\n      report.panic({\n        id: `10123`,\n        error,\n        context: {\n          configName,\n          message: error.message,\n        },\n      })\n    }\n  }\n\n  if (uncompiledResult?.configFilePath) {\n    return uncompiledResult\n  }\n\n  const error = new Error(`Cannot find package '${uncompiledConfigPath}'`)\n\n  const { tsConfig, nearMatch } = await checkTsAndNearMatch(\n    siteDirectory,\n    configName,\n    distance\n  )\n\n  // gatsby-config.ts exists but compiled gatsby-config.js does not\n  if (tsConfig) {\n    report.panic({\n      id: `10127`,\n      error,\n      context: {\n        configName,\n      },\n    })\n  }\n\n  // gatsby-config is misnamed\n  if (nearMatch) {\n    const isTSX = nearMatch.endsWith(`.tsx`)\n    report.panic({\n      id: `10124`,\n      error,\n      context: {\n        configName,\n        nearMatch,\n        isTSX,\n      },\n    })\n  }\n\n  // gatsby-config is incorrectly located in src directory\n  const isInSrcDir = await resolveJSFilepath({\n    rootDir: siteDirectory,\n    filePath: path.join(siteDirectory, `src`, configName),\n    warn: false,\n  })\n\n  if (isInSrcDir) {\n    report.panic({\n      id: `10125`,\n      context: {\n        configName,\n      },\n    })\n  }\n\n  return uncompiledResult\n}\n\nasync function checkTsAndNearMatch(\n  siteDirectory: string,\n  configName: string,\n  distance: number\n): Promise<{\n  tsConfig: boolean\n  nearMatch: string\n}> {\n  const files = await fs.readdir(siteDirectory)\n\n  let tsConfig = false\n  let nearMatch = ``\n\n  for (const file of files) {\n    if (tsConfig || nearMatch) {\n      break\n    }\n\n    const { name, ext } = path.parse(file)\n\n    if (name === configName && ext === `.ts`) {\n      tsConfig = true\n      break\n    }\n\n    if (isNearMatch(name, configName, distance)) {\n      nearMatch = file\n    }\n  }\n\n  return {\n    tsConfig,\n    nearMatch,\n  }\n}\n"],"mappings":"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"}