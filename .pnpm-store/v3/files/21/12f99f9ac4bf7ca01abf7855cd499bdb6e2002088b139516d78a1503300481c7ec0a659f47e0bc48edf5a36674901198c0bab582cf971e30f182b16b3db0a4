{"version":3,"file":"create-graphql-runner.js","names":["createGraphQLRunner","store","reporter","parentSpan","graphqlTracing","undefined","runner","GraphQLRunner","eventTypes","forEach","type","emitter","on","query","context","queryName","then","result","errors","structuredErrors","map","e","file","stackTrace","parse","find","test","getFunctionName","structuredError","errorParser","message","location","start","line","getLineNumber","column","getColumnNumber","filePath","getFileName","error","fromGraphQLFunction","filter","Boolean","length","panicOnBuild"],"sources":["../../src/bootstrap/create-graphql-runner.ts"],"sourcesContent":["import stackTrace from \"stack-trace\"\nimport { Span } from \"opentracing\"\nimport { ExecutionResult, Source } from \"graphql\"\nimport { Store } from \"redux\"\n\nimport { GraphQLRunner } from \"../query/graphql-runner\"\nimport errorParser from \"../query/error-parser\"\nimport { emitter } from \"../redux\"\nimport { Reporter } from \"../..\"\nimport { IGatsbyState } from \"../redux/types\"\nimport { IMatch } from \"../types\"\n\nexport type Runner = (\n  query: string | Source,\n  context: Record<string, any>\n) => Promise<ExecutionResult>\n\nexport const createGraphQLRunner = (\n  store: Store<IGatsbyState>,\n  reporter: Reporter,\n  {\n    parentSpan,\n    graphqlTracing,\n  }: { parentSpan: Span | undefined; graphqlTracing?: boolean } = {\n    parentSpan: undefined,\n    graphqlTracing: false,\n  }\n): Runner => {\n  // TODO: Move tracking of changed state inside GraphQLRunner itself. https://github.com/gatsbyjs/gatsby/issues/20941\n  let runner: GraphQLRunner | undefined = new GraphQLRunner(store, {\n    graphqlTracing,\n  })\n\n  const eventTypes: Array<string> = [\n    `DELETE_CACHE`,\n    `CREATE_NODE`,\n    `DELETE_NODE`,\n    `SET_SCHEMA_COMPOSER`,\n    `SET_SCHEMA`,\n    `ADD_FIELD_TO_NODE`,\n    `ADD_CHILD_NODE_TO_PARENT_NODE`,\n  ]\n\n  eventTypes.forEach(type => {\n    emitter.on(type, () => {\n      runner = undefined\n    })\n  })\n\n  return (query, context): ReturnType<Runner> => {\n    if (!runner) {\n      runner = new GraphQLRunner(store, {\n        graphqlTracing,\n      })\n    }\n    return runner\n      .query(query, context, {\n        queryName: `gatsby-node query`,\n        parentSpan,\n      })\n      .then(result => {\n        if (result.errors) {\n          const structuredErrors = result.errors\n            .map(e => {\n              // Find the file where graphql was called.\n              const file = stackTrace\n                .parse(e)\n                .find(file => /createPages/.test(file.getFunctionName()))\n\n              if (file) {\n                const structuredError = errorParser({\n                  message: e.message,\n                  location: {\n                    start: {\n                      line: file.getLineNumber(),\n                      column: file.getColumnNumber(),\n                    },\n                  },\n                  filePath: file.getFileName(),\n                  error: e,\n                })\n                structuredError.context = {\n                  ...structuredError.context,\n                  fromGraphQLFunction: true,\n                }\n                return structuredError\n              }\n\n              return null\n            })\n            .filter(Boolean as unknown as (match) => match is IMatch)\n\n          if (structuredErrors.length) {\n            // panic on build exits the process\n            reporter.panicOnBuild(structuredErrors)\n          }\n        }\n\n        return result\n      })\n  }\n}\n"],"mappings":";;;;;AAAA;AAKA;AACA;AACA;AAUO,MAAMA,mBAAmB,GAAG,CACjCC,KAA0B,EAC1BC,QAAkB,EAClB;EACEC,UAAU;EACVC;AAC0D,CAAC,GAAG;EAC9DD,UAAU,EAAEE,SAAS;EACrBD,cAAc,EAAE;AAClB,CAAC,KACU;EACX;EACA,IAAIE,MAAiC,GAAG,IAAIC,4BAAa,CAACN,KAAK,EAAE;IAC/DG;EACF,CAAC,CAAC;EAEF,MAAMI,UAAyB,GAAG,CAC/B,cAAa,EACb,aAAY,EACZ,aAAY,EACZ,qBAAoB,EACpB,YAAW,EACX,mBAAkB,EAClB,+BAA8B,CAChC;EAEDA,UAAU,CAACC,OAAO,CAACC,IAAI,IAAI;IACzBC,cAAO,CAACC,EAAE,CAACF,IAAI,EAAE,MAAM;MACrBJ,MAAM,GAAGD,SAAS;IACpB,CAAC,CAAC;EACJ,CAAC,CAAC;EAEF,OAAO,CAACQ,KAAK,EAAEC,OAAO,KAAyB;IAC7C,IAAI,CAACR,MAAM,EAAE;MACXA,MAAM,GAAG,IAAIC,4BAAa,CAACN,KAAK,EAAE;QAChCG;MACF,CAAC,CAAC;IACJ;IACA,OAAOE,MAAM,CACVO,KAAK,CAACA,KAAK,EAAEC,OAAO,EAAE;MACrBC,SAAS,EAAG,mBAAkB;MAC9BZ;IACF,CAAC,CAAC,CACDa,IAAI,CAACC,MAAM,IAAI;MACd,IAAIA,MAAM,CAACC,MAAM,EAAE;QACjB,MAAMC,gBAAgB,GAAGF,MAAM,CAACC,MAAM,CACnCE,GAAG,CAACC,CAAC,IAAI;UACR;UACA,MAAMC,IAAI,GAAGC,mBAAU,CACpBC,KAAK,CAACH,CAAC,CAAC,CACRI,IAAI,CAACH,IAAI,IAAI,aAAa,CAACI,IAAI,CAACJ,IAAI,CAACK,eAAe,EAAE,CAAC,CAAC;UAE3D,IAAIL,IAAI,EAAE;YACR,MAAMM,eAAe,GAAG,IAAAC,oBAAW,EAAC;cAClCC,OAAO,EAAET,CAAC,CAACS,OAAO;cAClBC,QAAQ,EAAE;gBACRC,KAAK,EAAE;kBACLC,IAAI,EAAEX,IAAI,CAACY,aAAa,EAAE;kBAC1BC,MAAM,EAAEb,IAAI,CAACc,eAAe;gBAC9B;cACF,CAAC;cACDC,QAAQ,EAAEf,IAAI,CAACgB,WAAW,EAAE;cAC5BC,KAAK,EAAElB;YACT,CAAC,CAAC;YACFO,eAAe,CAACd,OAAO,GAAG;cACxB,GAAGc,eAAe,CAACd,OAAO;cAC1B0B,mBAAmB,EAAE;YACvB,CAAC;YACD,OAAOZ,eAAe;UACxB;UAEA,OAAO,IAAI;QACb,CAAC,CAAC,CACDa,MAAM,CAACC,OAAO,CAA0C;QAE3D,IAAIvB,gBAAgB,CAACwB,MAAM,EAAE;UAC3B;UACAzC,QAAQ,CAAC0C,YAAY,CAACzB,gBAAgB,CAAC;QACzC;MACF;MAEA,OAAOF,MAAM;IACf,CAAC,CAAC;EACN,CAAC;AACH,CAAC;AAAA"}