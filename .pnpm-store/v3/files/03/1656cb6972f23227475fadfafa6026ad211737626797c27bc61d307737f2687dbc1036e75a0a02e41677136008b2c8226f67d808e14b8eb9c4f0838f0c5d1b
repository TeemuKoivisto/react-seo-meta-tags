{"version":3,"file":"child.js","names":["originalModuleLoad","mod","_load","EngineValidationError","Error","constructor","request","relativeToRoot","parent","parentPath","filename","validate","directory","isMain","builtinModules","includes","allowedPrefixes","path","join","localRequire","createRequire","absPath","resolve","relative","allowedPrefix","startsWith","process","env","GATSBY_WORKER_MODULE_PATH","GraphQLEngine","require","graphqlEngine","dbPath","ready"],"sources":["../../../src/utils/validate-engines/child.ts"],"sourcesContent":["import mod from \"module\"\nimport * as path from \"path\"\n\n// @ts-ignore TS doesn't like accessing `_load`\nconst originalModuleLoad = mod._load\n\nclass EngineValidationError extends Error {\n  request: string\n  relativeToRoot: string\n  parentPath: string\n\n  constructor({\n    request,\n    relativeToRoot,\n    parent,\n  }: {\n    request: string\n    relativeToRoot: string\n    parent: mod\n  }) {\n    super(\n      `Generated engines use disallowed import \"${request}\". Only allowed imports are to Node.js builtin modules or engines internals.`\n    )\n    this.request = request\n    this.relativeToRoot = relativeToRoot\n    this.parentPath = parent.filename\n  }\n}\n\nexport async function validate(directory: string): Promise<void> {\n  // intercept module loading and validate no unexpected imports are happening\n  // @ts-ignore TS doesn't like accessing `_load`\n  mod._load = (request: string, parent: mod, isMain: boolean): any => {\n    // Allow all node builtins\n    if (mod.builtinModules.includes(request)) {\n      return originalModuleLoad(request, parent, isMain)\n    }\n\n    // Allow imports to modules in engines directory.\n    // For example: importing \".cache/page-ssr/routes/render-page\" from\n    // page-ssr engine should be allowed as it is part of engine.\n    const allowedPrefixes = [\n      path.join(`.cache`, `query-engine`),\n      path.join(`.cache`, `page-ssr`),\n    ]\n    const localRequire = mod.createRequire(parent.filename)\n    const absPath = localRequire.resolve(request)\n    const relativeToRoot = path.relative(directory, absPath)\n    for (const allowedPrefix of allowedPrefixes) {\n      if (relativeToRoot.startsWith(allowedPrefix)) {\n        return originalModuleLoad(request, parent, isMain)\n      }\n    }\n\n    // We throw on anything that is not allowed\n    // Runtime might have try/catch for it and continue to work\n    // (for example`msgpackr` have fallback if native `msgpack-extract` can't be loaded)\n    // and we don't fail validation in those cases because error we throw will be handled.\n    // We do want to fail validation if there is no fallback\n    throw new EngineValidationError({ request, relativeToRoot, parent })\n  }\n\n  // workaround for gatsby-worker issue:\n  // gatsby-worker gets bundled in engines and it will auto-init \"child\" module\n  // if GATSBY_WORKER_MODULE_PATH env var is set. To prevent this we just unset\n  // env var so it's falsy.\n  process.env.GATSBY_WORKER_MODULE_PATH = ``\n\n  // import engines, initiate them, if there is any error thrown it will be handled in parent process\n  const { GraphQLEngine } = require(path.join(\n    directory,\n    `.cache`,\n    `query-engine`\n  ))\n  require(path.join(directory, `.cache`, `page-ssr`))\n  const graphqlEngine = new GraphQLEngine({\n    dbPath: path.join(directory, `.cache`, `data`, `datastore`),\n  })\n  await graphqlEngine.ready()\n}\n"],"mappings":";;;;;AAAA;AACA;AAA4B;AAAA;AAE5B;AACA,MAAMA,kBAAkB,GAAGC,eAAG,CAACC,KAAK;AAEpC,MAAMC,qBAAqB,SAASC,KAAK,CAAC;EAKxCC,WAAW,CAAC;IACVC,OAAO;IACPC,cAAc;IACdC;EAKF,CAAC,EAAE;IACD,KAAK,CACF,4CAA2CF,OAAQ,8EAA6E,CAClI;IACD,IAAI,CAACA,OAAO,GAAGA,OAAO;IACtB,IAAI,CAACC,cAAc,GAAGA,cAAc;IACpC,IAAI,CAACE,UAAU,GAAGD,MAAM,CAACE,QAAQ;EACnC;AACF;AAEO,eAAeC,QAAQ,CAACC,SAAiB,EAAiB;EAC/D;EACA;EACAX,eAAG,CAACC,KAAK,GAAG,CAACI,OAAe,EAAEE,MAAW,EAAEK,MAAe,KAAU;IAClE;IACA,IAAIZ,eAAG,CAACa,cAAc,CAACC,QAAQ,CAACT,OAAO,CAAC,EAAE;MACxC,OAAON,kBAAkB,CAACM,OAAO,EAAEE,MAAM,EAAEK,MAAM,CAAC;IACpD;;IAEA;IACA;IACA;IACA,MAAMG,eAAe,GAAG,CACtBC,IAAI,CAACC,IAAI,CAAE,QAAO,EAAG,cAAa,CAAC,EACnCD,IAAI,CAACC,IAAI,CAAE,QAAO,EAAG,UAAS,CAAC,CAChC;IACD,MAAMC,YAAY,GAAGlB,eAAG,CAACmB,aAAa,CAACZ,MAAM,CAACE,QAAQ,CAAC;IACvD,MAAMW,OAAO,GAAGF,YAAY,CAACG,OAAO,CAAChB,OAAO,CAAC;IAC7C,MAAMC,cAAc,GAAGU,IAAI,CAACM,QAAQ,CAACX,SAAS,EAAES,OAAO,CAAC;IACxD,KAAK,MAAMG,aAAa,IAAIR,eAAe,EAAE;MAC3C,IAAIT,cAAc,CAACkB,UAAU,CAACD,aAAa,CAAC,EAAE;QAC5C,OAAOxB,kBAAkB,CAACM,OAAO,EAAEE,MAAM,EAAEK,MAAM,CAAC;MACpD;IACF;;IAEA;IACA;IACA;IACA;IACA;IACA,MAAM,IAAIV,qBAAqB,CAAC;MAAEG,OAAO;MAAEC,cAAc;MAAEC;IAAO,CAAC,CAAC;EACtE,CAAC;;EAED;EACA;EACA;EACA;EACAkB,OAAO,CAACC,GAAG,CAACC,yBAAyB,GAAI,EAAC;;EAE1C;EACA,MAAM;IAAEC;EAAc,CAAC,GAAGC,OAAO,CAACb,IAAI,CAACC,IAAI,CACzCN,SAAS,EACR,QAAO,EACP,cAAa,CACf,CAAC;EACFkB,OAAO,CAACb,IAAI,CAACC,IAAI,CAACN,SAAS,EAAG,QAAO,EAAG,UAAS,CAAC,CAAC;EACnD,MAAMmB,aAAa,GAAG,IAAIF,aAAa,CAAC;IACtCG,MAAM,EAAEf,IAAI,CAACC,IAAI,CAACN,SAAS,EAAG,QAAO,EAAG,MAAK,EAAG,WAAU;EAC5D,CAAC,CAAC;EACF,MAAMmB,aAAa,CAACE,KAAK,EAAE;AAC7B"}