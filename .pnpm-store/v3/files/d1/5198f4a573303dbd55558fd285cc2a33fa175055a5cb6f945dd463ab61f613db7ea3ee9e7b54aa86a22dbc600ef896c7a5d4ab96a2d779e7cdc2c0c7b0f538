{"version":3,"file":"bundle-webpack.js","names":["extensions","outputDir","path","join","process","cwd","cacheLocation","getApisToRemoveForQueryEngine","apisToKeep","Set","schemaCustomizationAPIs","add","apisToRemove","Object","keys","nodeApis","filter","api","has","createGraphqlEngineBundle","rootDir","reporter","isVerbose","schemaSnapshotString","fs","readFile","printQueryEnginePlugins","assetRelocatorUseEntry","loader","require","resolve","options","outputAssetBase","gatsbyPluginTSRequire","mod","createRequire","compiler","webpack","name","mode","entry","__dirname","output","filename","libraryTarget","target","externalsPresets","node","cache","type","buildDependencies","config","__filename","externals","builtinModules","reduce","acc","builtinModule","module","rules","oneOf","test","parser","amd","use","remove","jsx","exclude","presets","byDependency","esm","fullySpecified","alias","inquirer","lmdb","plugins","EnvironmentPlugin","DefinePlugin","JSON","stringify","SCHEMA_SNAPSHOT","env","GATSBY_SLICES","GATSBY_WEBPACK_LOGGING","includes","WebpackLoggingPlugin","Boolean","Promise","reject","run","err","stats","getResourcePath","webpackModule","ConcatenatedModule","resource","modules","firstSubModule","undefined","iterateModules","webpackModules","compilation","resourcePath","importedBy","moduleGraph","getIssuer","structuredError","id","context","package","advisory","close","closeErr","e"],"sources":["../../../src/schema/graphql-engine/bundle-webpack.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\n\nimport * as path from \"path\"\nimport * as fs from \"fs-extra\"\nimport webpack, { Module, NormalModule, Compilation } from \"webpack\"\nimport ConcatenatedModule from \"webpack/lib/optimize/ConcatenatedModule\"\nimport { printQueryEnginePlugins } from \"./print-plugins\"\nimport mod from \"module\"\nimport { WebpackLoggingPlugin } from \"../../utils/webpack/plugins/webpack-logging\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { schemaCustomizationAPIs } from \"./print-plugins\"\nimport type { GatsbyNodeAPI } from \"../../redux/types\"\nimport * as nodeApis from \"../../utils/api-node-docs\"\n\ntype Reporter = typeof reporter\n\nconst extensions = [`.mjs`, `.js`, `.json`, `.node`, `.ts`, `.tsx`]\n\nconst outputDir = path.join(process.cwd(), `.cache`, `query-engine`)\nconst cacheLocation = path.join(\n  process.cwd(),\n  `.cache`,\n  `webpack`,\n  `query-engine`\n)\n\nfunction getApisToRemoveForQueryEngine(): Array<GatsbyNodeAPI> {\n  const apisToKeep = new Set(schemaCustomizationAPIs)\n  apisToKeep.add(`onPluginInit`)\n\n  const apisToRemove = (Object.keys(nodeApis) as Array<GatsbyNodeAPI>).filter(\n    api => !apisToKeep.has(api)\n  )\n  return apisToRemove\n}\n\nexport async function createGraphqlEngineBundle(\n  rootDir: string,\n  reporter: Reporter,\n  isVerbose?: boolean\n): Promise<webpack.Compilation | undefined> {\n  const schemaSnapshotString = await fs.readFile(\n    path.join(rootDir, `.cache`, `schema.gql`),\n    `utf-8`\n  )\n  await printQueryEnginePlugins()\n\n  const assetRelocatorUseEntry = {\n    loader: require.resolve(`@vercel/webpack-asset-relocator-loader`),\n    options: {\n      outputAssetBase: `assets`,\n    },\n  }\n\n  const gatsbyPluginTSRequire = mod.createRequire(\n    require.resolve(`gatsby-plugin-typescript`)\n  )\n\n  const compiler = webpack({\n    name: `Query Engine`,\n    // mode: `production`,\n    mode: `none`,\n    entry: path.join(__dirname, `entry.js`),\n    output: {\n      path: outputDir,\n      filename: `index.js`,\n      libraryTarget: `commonjs`,\n    },\n    target: `node`,\n    externalsPresets: {\n      node: false,\n    },\n    cache: {\n      type: `filesystem`,\n      name: `graphql-engine`,\n      cacheLocation,\n      buildDependencies: {\n        config: [__filename],\n      },\n    },\n    // those are required in some runtime paths, but we don't need them\n    externals: [\n      `cbor-x`, // optional dep of lmdb-store, but we are using `msgpack` (default) encoding, so we don't need it\n      `babel-runtime/helpers/asyncToGenerator`, // undeclared dep of yurnalist (but used in code path we don't use)\n      `electron`, // :shrug: `got` seems to have electron specific code path\n      mod.builtinModules.reduce((acc, builtinModule) => {\n        if (builtinModule === `fs`) {\n          acc[builtinModule] = `global _actualFsWrapper`\n          acc[`node:${builtinModule}`] = `global _actualFsWrapper`\n        } else {\n          acc[builtinModule] = `commonjs ${builtinModule}`\n          acc[`node:${builtinModule}`] = `commonjs ${builtinModule}`\n        }\n\n        return acc\n      }, {}),\n    ],\n    module: {\n      rules: [\n        {\n          oneOf: [\n            {\n              // specific set of loaders for LMBD - our custom patch to massage lmdb to work with relocator -> relocator\n              test: /node_modules[/\\\\]lmdb[/\\\\].*\\.[cm]?js/,\n              // it is recommended for Node builds to turn off AMD support\n              parser: { amd: false },\n              use: [\n                assetRelocatorUseEntry,\n                {\n                  loader: require.resolve(`./lmdb-bundling-patch`),\n                },\n              ],\n            },\n            {\n              // specific set of loaders for gatsby-node files - our babel transform that removes lifecycles not needed for engine -> relocator\n              test: /gatsby-node\\.(cjs|mjs|js|ts)$/,\n              // it is recommended for Node builds to turn off AMD support\n              parser: { amd: false },\n              use: [\n                assetRelocatorUseEntry,\n                {\n                  loader: require.resolve(\n                    `../../utils/webpack/loaders/webpack-remove-exports-loader`\n                  ),\n                  options: {\n                    remove: getApisToRemoveForQueryEngine(),\n                    jsx: false,\n                  },\n                },\n              ],\n            },\n            {\n              // generic loader for all other cases than lmdb or gatsby-node - we don't do anything special other than using relocator on it\n              // For node binary relocations, include \".node\" files as well here\n              test: /\\.(cjs|mjs|js|ts|node)$/,\n              // it is recommended for Node builds to turn off AMD support\n              parser: { amd: false },\n              use: assetRelocatorUseEntry,\n            },\n          ],\n        },\n        {\n          test: /\\.ts$/,\n          exclude: /node_modules/,\n          use: {\n            loader: require.resolve(`babel-loader`),\n            options: {\n              presets: [\n                gatsbyPluginTSRequire.resolve(`@babel/preset-typescript`),\n              ],\n            },\n          },\n        },\n        {\n          test: /\\.m?js$/,\n          type: `javascript/auto`,\n          resolve: {\n            byDependency: {\n              esm: {\n                fullySpecified: false,\n              },\n            },\n          },\n        },\n        {\n          test: /\\.txt/,\n          type: `asset/resource`,\n        },\n        {\n          test: /\\.(graphqls?|gqls?)$/,\n          use: {\n            loader: require.resolve(`graphql-tag/loader`),\n          },\n        },\n      ],\n    },\n    resolve: {\n      extensions,\n      alias: {\n        \".cache\": process.cwd() + `/.cache/`,\n\n        [require.resolve(`gatsby-cli/lib/reporter/loggers/ink/index.js`)]:\n          false,\n        inquirer: false,\n        // only load one version of lmdb\n        lmdb: require.resolve(`lmdb`),\n        \"ts-node\": require.resolve(`./shims/ts-node`),\n        \"gatsby-sharp$\": require.resolve(`./shims/gatsby-sharp`),\n        \"graphql-import-node$\": require.resolve(`./shims/no-op-module`),\n        \"graphql-import-node/register$\":\n          require.resolve(`./shims/no-op-module`),\n      },\n    },\n    plugins: [\n      new webpack.EnvironmentPlugin([`GATSBY_CLOUD_IMAGE_CDN`]),\n      new webpack.DefinePlugin({\n        // \"process.env.GATSBY_LOGGER\": JSON.stringify(`yurnalist`),\n        \"process.env.GATSBY_SKIP_WRITING_SCHEMA_TO_FILE\": `true`,\n        \"process.env.NODE_ENV\": JSON.stringify(`production`),\n        SCHEMA_SNAPSHOT: JSON.stringify(schemaSnapshotString),\n        \"process.env.GATSBY_LOGGER\": JSON.stringify(`yurnalist`),\n        \"process.env.GATSBY_SLICES\": JSON.stringify(\n          !!process.env.GATSBY_SLICES\n        ),\n      }),\n      process.env.GATSBY_WEBPACK_LOGGING?.includes(`query-engine`) &&\n        new WebpackLoggingPlugin(rootDir, reporter, isVerbose),\n    ].filter(Boolean) as Array<webpack.WebpackPluginInstance>,\n  })\n\n  return new Promise((resolve, reject) => {\n    compiler.run((err, stats): void => {\n      function getResourcePath(\n        webpackModule?: Module | NormalModule | ConcatenatedModule | null\n      ): string | undefined {\n        if (webpackModule && !(webpackModule instanceof ConcatenatedModule)) {\n          return (webpackModule as NormalModule).resource\n        }\n\n        if (webpackModule?.modules) {\n          // ConcatenatedModule is a collection of modules so we have to go deeper to actually get a path,\n          // at this point we won't know which one so we just grab first module here\n          const [firstSubModule] = webpackModule.modules\n          return getResourcePath(firstSubModule)\n        }\n\n        return undefined\n      }\n\n      function iterateModules(\n        webpackModules: Set<Module>,\n        compilation: Compilation\n      ): void {\n        for (const webpackModule of webpackModules) {\n          if (webpackModule instanceof ConcatenatedModule) {\n            iterateModules(\n              (webpackModule as ConcatenatedModule).modules,\n              compilation\n            )\n          } else {\n            const resourcePath = getResourcePath(webpackModule)\n            if (resourcePath?.includes(`ts-node`)) {\n              const importedBy = getResourcePath(\n                compilation.moduleGraph.getIssuer(webpackModule)\n              )\n              const structuredError = {\n                id: `98011`,\n                context: {\n                  package: `ts-node`,\n                  importedBy,\n                  advisory: `Gatsby is supporting TypeScript natively (see https://gatsby.dev/typescript). \"ts-node\" might not be needed anymore at all, consider removing it.`,\n                },\n              }\n              throw structuredError\n            }\n          }\n        }\n      }\n\n      try {\n        if (stats?.compilation.modules) {\n          iterateModules(stats.compilation.modules, stats.compilation)\n        }\n\n        compiler.close(closeErr => {\n          if (err) {\n            return reject(err)\n          }\n          if (closeErr) {\n            return reject(closeErr)\n          }\n          return resolve(stats?.compilation)\n        })\n      } catch (e) {\n        reject(e)\n      }\n    })\n  })\n}\n"],"mappings":"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"}