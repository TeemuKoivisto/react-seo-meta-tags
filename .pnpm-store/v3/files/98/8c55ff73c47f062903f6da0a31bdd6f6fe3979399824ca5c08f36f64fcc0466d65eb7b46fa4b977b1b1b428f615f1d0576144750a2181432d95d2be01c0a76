{"version":3,"file":"schema.js","names":["setInferenceMetadata","setState","buildSchema","workerStore","store","getState","config","pathPrefix","Error","schemaSnapshotPath","path","join","program","directory","fs","pathExists","schemaSnapshot","readFile","dispatch","actions","createTypes","apiRunnerNode","build","fullMetadataBuild","parentSpan"],"sources":["../../../../src/utils/worker/child/schema.ts"],"sourcesContent":["import * as path from \"path\"\nimport * as fs from \"fs-extra\"\n\nimport { store } from \"../../../redux\"\nimport { actions } from \"../../../redux/actions\"\nimport { build } from \"../../../schema\"\nimport apiRunnerNode from \"../../api-runner-node\"\nimport { setState } from \"./state\"\n\nexport function setInferenceMetadata(): void {\n  setState([`inferenceMetadata`])\n}\n\nexport async function buildSchema(): Promise<void> {\n  const workerStore = store.getState()\n\n  // pathPrefix: '' will at least be defined when config is loaded\n  if ((workerStore?.config?.pathPrefix ?? null) === null) {\n    throw Error(\n      `Config loading didn't finish before attempting to build schema in worker`\n    )\n  }\n\n  const schemaSnapshotPath = path.join(\n    workerStore.program.directory,\n    `.cache`,\n    `schema.gql`\n  )\n\n  if (await fs.pathExists(schemaSnapshotPath)) {\n    const schemaSnapshot = await fs.readFile(schemaSnapshotPath, `utf-8`)\n    store.dispatch(actions.createTypes(schemaSnapshot))\n  }\n\n  setInferenceMetadata()\n\n  await apiRunnerNode(`createSchemaCustomization`)\n\n  // build() runs other lifecycles like \"createResolvers\" or \"setFieldsOnGraphQLNodeType\" internally\n  await build({ fullMetadataBuild: false, parentSpan: {} })\n}\n"],"mappings":";;;;;;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAkC;AAAA;AAE3B,SAASA,oBAAoB,GAAS;EAC3C,IAAAC,eAAQ,EAAC,CAAE,mBAAkB,CAAC,CAAC;AACjC;AAEO,eAAeC,WAAW,GAAkB;EAAA;EACjD,MAAMC,WAAW,GAAGC,YAAK,CAACC,QAAQ,EAAE;;EAEpC;EACA,IAAI,0BAACF,WAAW,aAAXA,WAAW,8CAAXA,WAAW,CAAEG,MAAM,wDAAnB,oBAAqBC,UAAU,yEAAI,IAAI,MAAM,IAAI,EAAE;IACtD,MAAMC,KAAK,CACR,0EAAyE,CAC3E;EACH;EAEA,MAAMC,kBAAkB,GAAGC,IAAI,CAACC,IAAI,CAClCR,WAAW,CAACS,OAAO,CAACC,SAAS,EAC5B,QAAO,EACP,YAAW,CACb;EAED,IAAI,MAAMC,EAAE,CAACC,UAAU,CAACN,kBAAkB,CAAC,EAAE;IAC3C,MAAMO,cAAc,GAAG,MAAMF,EAAE,CAACG,QAAQ,CAACR,kBAAkB,EAAG,OAAM,CAAC;IACrEL,YAAK,CAACc,QAAQ,CAACC,gBAAO,CAACC,WAAW,CAACJ,cAAc,CAAC,CAAC;EACrD;EAEAhB,oBAAoB,EAAE;EAEtB,MAAM,IAAAqB,sBAAa,EAAE,2BAA0B,CAAC;;EAEhD;EACA,MAAM,IAAAC,aAAK,EAAC;IAAEC,iBAAiB,EAAE,KAAK;IAAEC,UAAU,EAAE,CAAC;EAAE,CAAC,CAAC;AAC3D"}