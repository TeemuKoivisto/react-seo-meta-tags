{"version":3,"file":"requires-writer.js","names":["paramRe","SEGMENT_POINTS","STATIC_POINTS","DYNAMIC_POINTS","SPLAT_PENALTY","ROOT_POINTS","isRootSegment","segment","isDynamic","test","isSplat","hasContentFilePath","componentPath","includes","segmentize","uri","replace","split","rankRoute","path","reduce","score","lastHash","resetLastHash","getComponents","pages","slices","components","pickComponentFields","page","componentChunkName","hasHeadComponent","get","Head","values","c","getMatchPaths","createMatchPathEntry","index","matchPath","undefined","reporter","panic","matchPathPages","forEach","getPageMode","push","length","newMatches","isInsideMatchPath","find","pageWithMatchPath","match","sort","a","b","order","localeCompare","map","writeAll","state","program","matchPaths","cleanedSSRVisitedPageComponents","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","ssrVisitedPageComponents","visitedPages","filter","some","s","startsWith","newHash","md5","JSON","stringify","lazySyncRequires","joinPath","join","writeModule","devSSRWillInvalidate","syncRequires","asyncRequires","gatsby_executing_command","GATSBY_PARTIAL_HYDRATION","relativeComponentPath","relative","getAbsolutePathForVirtualModule","rqPrefix","slash","Boolean","writeAndMove","virtualFilePath","file","data","destination","directory","tmp","Date","now","fs","writeFile","then","move","overwrite","Promise","all","debouncedWriteAll","activity","activityTimer","id","start","store","getState","end","leading","listenerStarted","startListener","emitter","on","pendingActivity"],"sources":["../../src/bootstrap/requires-writer.ts"],"sourcesContent":["import _ from \"lodash\"\nimport path from \"path\"\nimport fs from \"fs-extra\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { match } from \"@gatsbyjs/reach-router\"\nimport { joinPath, md5, slash } from \"gatsby-core-utils\"\nimport { store, emitter } from \"../redux/\"\nimport { IGatsbyState, IGatsbyPage, IGatsbySlice } from \"../redux/types\"\nimport {\n  writeModule,\n  getAbsolutePathForVirtualModule,\n} from \"../utils/gatsby-webpack-virtual-modules\"\nimport { getPageMode } from \"../utils/page-mode\"\nimport { devSSRWillInvalidate } from \"../commands/build-html\"\n\ninterface IGatsbyPageComponent {\n  componentPath: string\n  componentChunkName: string\n  hasHeadComponent: boolean\n}\n\ninterface IGatsbyPageMatchPath {\n  path: string\n  matchPath: string | undefined\n}\n\n// path ranking algorithm copied (with small adjustments) from `@reach/router` (internal util, not exported from the package)\n// https://github.com/reach/router/blob/28a79e7fc3a3487cb3304210dc3501efb8a50eba/src/lib/utils.js#L216-L254\nconst paramRe = /^:(.+)/\n\nconst SEGMENT_POINTS = 4\nconst STATIC_POINTS = 3\nconst DYNAMIC_POINTS = 2\nconst SPLAT_PENALTY = 1\nconst ROOT_POINTS = 1\n\nconst isRootSegment = (segment: string): boolean => segment === ``\nconst isDynamic = (segment: string): boolean => paramRe.test(segment)\nconst isSplat = (segment: string): boolean => segment === `*`\nconst hasContentFilePath = (componentPath: string): boolean =>\n  componentPath.includes(`?__contentFilePath=`)\n\nconst segmentize = (uri: string): Array<string> =>\n  uri\n    // strip starting/ending slashes\n    .replace(/(^\\/+|\\/+$)/g, ``)\n    .split(`/`)\n\nconst rankRoute = (path: string): number =>\n  segmentize(path).reduce((score, segment) => {\n    score += SEGMENT_POINTS\n    if (isRootSegment(segment)) score += ROOT_POINTS\n    else if (isDynamic(segment)) score += DYNAMIC_POINTS\n    else if (isSplat(segment)) score -= SEGMENT_POINTS + SPLAT_PENALTY\n    else score += STATIC_POINTS\n    return score\n  }, 0)\n// end of copied `@reach/router` internals\n\nlet lastHash: string | null = null\n\nexport const resetLastHash = (): void => {\n  lastHash = null\n}\n\ntype IBareComponentData = Pick<\n  IGatsbyPageComponent,\n  `componentPath` | `componentChunkName`\n> & {\n  hasHeadComponent: boolean\n}\n\nexport const getComponents = (\n  pages: Array<IGatsbyPage>,\n  slices: IGatsbyState[\"slices\"],\n  components: IGatsbyState[\"components\"]\n): Array<IGatsbyPageComponent> => {\n  const pickComponentFields = (\n    page: IGatsbyPage | IGatsbySlice\n  ): IBareComponentData => {\n    return {\n      componentPath: page.componentPath,\n      componentChunkName: page.componentChunkName,\n      hasHeadComponent: components.get(page.componentPath)?.Head ?? false,\n    }\n  }\n\n  return _.orderBy(\n    _.uniqBy(\n      _.map([...pages, ...slices.values()], pickComponentFields),\n      c => c.componentChunkName\n    ),\n    c => c.componentChunkName\n  )\n}\n\n/**\n * Get all dynamic routes and sort them by most specific at the top\n * code is based on @reach/router match utility (https://github.com/reach/router/blob/152aff2352bc62cefc932e1b536de9efde6b64a5/src/lib/utils.js#L224-L254)\n */\nconst getMatchPaths = (\n  pages: Array<IGatsbyPage>\n): Array<IGatsbyPageMatchPath> => {\n  interface IMatchPathEntry extends IGatsbyPage {\n    index: number\n    score: number\n    matchPath: string\n  }\n\n  const createMatchPathEntry = (\n    page: IGatsbyPage,\n    index: number\n  ): IMatchPathEntry => {\n    const { matchPath } = page\n\n    if (matchPath === undefined) {\n      return reporter.panic(\n        `Error: matchPath property is undefined for page ${page.path}, should be a string`\n      ) as never\n    }\n\n    return {\n      ...page,\n      matchPath,\n      index,\n      score: rankRoute(matchPath),\n    }\n  }\n\n  const matchPathPages: Array<IMatchPathEntry> = []\n\n  pages.forEach((page: IGatsbyPage, index: number): void => {\n    if (page.matchPath && getPageMode(page) === `SSG`) {\n      matchPathPages.push(createMatchPathEntry(page, index))\n    }\n  })\n\n  // Pages can live in matchPaths, to keep them working without doing another network request\n  // we save them in matchPath. We use `@reach/router` path ranking to score paths/matchPaths\n  // and sort them so more specific paths are before less specific paths.\n  // More info in https://github.com/gatsbyjs/gatsby/issues/16097\n  // small speedup: don't bother traversing when no matchPaths found.\n  if (matchPathPages.length) {\n    const newMatches: Array<IMatchPathEntry> = []\n\n    pages.forEach((page: IGatsbyPage, index: number): void => {\n      const isInsideMatchPath = !!matchPathPages.find(\n        pageWithMatchPath =>\n          !page.matchPath && match(pageWithMatchPath.matchPath, page.path)\n      )\n\n      if (isInsideMatchPath) {\n        newMatches.push(\n          createMatchPathEntry(\n            {\n              ...page,\n              matchPath: page.path,\n            },\n            index\n          )\n        )\n      }\n    })\n    // Add afterwards because the new matches are not relevant for the existing search\n    matchPathPages.push(...newMatches)\n  }\n\n  return matchPathPages\n    .sort((a, b) => {\n      // The higher the score, the higher the specificity of our matchPath\n      const order = b.score - a.score\n      if (order !== 0) {\n        return order\n      }\n\n      // if specificity is the same we do lexigraphic comparison of path to ensure\n      // deterministic order regardless of order pages where created\n      return a.matchPath.localeCompare(b.matchPath)\n    })\n    .map(({ path, matchPath }) => {\n      return { path, matchPath }\n    })\n}\n\n// Write out pages information.\nexport const writeAll = async (state: IGatsbyState): Promise<boolean> => {\n  const { program, slices } = state\n  const pages = [...state.pages.values()]\n  const matchPaths = getMatchPaths(pages)\n  const components = getComponents(pages, slices, state.components)\n  let cleanedSSRVisitedPageComponents: Array<IGatsbyPageComponent> = []\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const ssrVisitedPageComponents = [\n      ...(state.visitedPages.get(`server`)?.values() || []),\n    ]\n\n    // Remove any page components that no longer exist.\n    cleanedSSRVisitedPageComponents = components.filter(\n      c =>\n        ssrVisitedPageComponents.some(s => s === c.componentChunkName) ||\n        c.componentChunkName.startsWith(`slice---`)\n    )\n  }\n\n  const newHash = await md5(\n    JSON.stringify({\n      matchPaths,\n      components,\n      cleanedSSRVisitedPageComponents,\n    })\n  )\n\n  if (newHash === lastHash) {\n    // Nothing changed. No need to rewrite files\n    return false\n  }\n\n  lastHash = newHash\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    // Create file with sync requires of visited page components files.\n\n    const lazySyncRequires = `exports.ssrComponents = {\\n${cleanedSSRVisitedPageComponents\n      .map(\n        (c: IGatsbyPageComponent): string =>\n          `  \"${c.componentChunkName}\": require(\"${joinPath(c.componentPath)}\")`\n      )\n      .join(`,\\n`)}\n  }\\n\\n`\n\n    writeModule(`$virtual/ssr-sync-requires`, lazySyncRequires)\n    // if this is executed, webpack should mark it as invalid, but sometimes there is some timing race\n    // so we also explicitly set flag here as well\n    devSSRWillInvalidate()\n  }\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `\n// prefer default export if available\nconst preferDefault = m => (m && m.default) || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      (c: IGatsbyPageComponent): string =>\n        `  \"${c.componentChunkName}\": preferDefault(require(\"${joinPath(\n          c.componentPath\n        )}\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = ``\n\n  if (\n    process.env.gatsby_executing_command === `develop` ||\n    (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_PARTIAL_HYDRATION)\n  ) {\n    asyncRequires = `exports.components = {\\n${components\n      .map((c: IGatsbyPageComponent): string => {\n        // we need a relative import path to keep contenthash the same if directory changes\n        const relativeComponentPath = path.relative(\n          getAbsolutePathForVirtualModule(`$virtual`),\n          c.componentPath\n        )\n\n        const rqPrefix = hasContentFilePath(relativeComponentPath) ? `&` : `?`\n\n        return `  \"${c.componentChunkName}\": () => import(\"${slash(\n          `./${relativeComponentPath}`\n        )}${rqPrefix}export=default\" /* webpackChunkName: \"${\n          c.componentChunkName\n        }\" */)`\n      })\n      .join(`,\\n`)}\n}\\n\\n\n\nexports.head = {\\n${components\n      .map((c: IGatsbyPageComponent): string | undefined => {\n        if (!c.hasHeadComponent) {\n          return undefined\n        }\n        // we need a relative import path to keep contenthash the same if directory changes\n        const relativeComponentPath = path.relative(\n          getAbsolutePathForVirtualModule(`$virtual`),\n          c.componentPath\n        )\n\n        const rqPrefix = hasContentFilePath(relativeComponentPath) ? `&` : `?`\n\n        return `  \"${c.componentChunkName}\": () => import(\"${slash(\n          `./${relativeComponentPath}`\n        )}${rqPrefix}export=head\" /* webpackChunkName: \"${\n          c.componentChunkName\n        }head\" */)`\n      })\n      .filter(Boolean)\n      .join(`,\\n`)}\n}\\n\\n`\n  } else {\n    asyncRequires = `exports.components = {\\n${components\n      .map((c: IGatsbyPageComponent): string => {\n        // we need a relative import path to keep contenthash the same if directory changes\n        const relativeComponentPath = path.relative(\n          getAbsolutePathForVirtualModule(`$virtual`),\n          c.componentPath\n        )\n        return `  \"${c.componentChunkName}\": () => import(\"${slash(\n          `./${relativeComponentPath}`\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n      })\n      .join(`,\\n`)}\n}\\n\\n`\n  }\n\n  const writeAndMove = (\n    virtualFilePath: string,\n    file: string,\n    data: string\n  ): Promise<void> => {\n    writeModule(virtualFilePath, data)\n\n    // files in .cache are not used anymore as part of webpack builds, but\n    // still can be used by other tools (for example `gatsby serve` reads\n    // `match-paths.json` to setup routing)\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  await Promise.all([\n    writeAndMove(`$virtual/sync-requires.js`, `sync-requires.js`, syncRequires),\n    writeAndMove(\n      `$virtual/async-requires.js`,\n      `async-requires.js`,\n      asyncRequires\n    ),\n    writeAndMove(\n      `$virtual/match-paths.json`,\n      `match-paths.json`,\n      JSON.stringify(matchPaths, null, 4)\n    ),\n  ])\n\n  return true\n}\n\nconst debouncedWriteAll = _.debounce(\n  async (): Promise<void> => {\n    const activity = reporter.activityTimer(`write out requires`, {\n      id: `requires-writer`,\n    })\n    activity.start()\n    await writeAll(store.getState())\n    activity.end()\n  },\n  500,\n  {\n    // using \"leading\" can cause double `writeAll` call - particularly\n    // when refreshing data using `/__refresh` hook.\n    leading: false,\n  }\n)\n\n/**\n * Start listening to CREATE/DELETE_PAGE events so we can rewrite\n * files as required\n */\nlet listenerStarted = false\nexport const startListener = (): void => {\n  // Only start the listener once.\n  if (listenerStarted) {\n    return\n  }\n  listenerStarted = true\n\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    /**\n     * Start listening to CREATE_SERVER_VISITED_PAGE events so we can rewrite\n     * files as required\n     */\n    emitter.on(`CREATE_SERVER_VISITED_PAGE`, async (): Promise<void> => {\n      // this event only happen on new additions\n      devSSRWillInvalidate()\n      reporter.pendingActivity({ id: `requires-writer` })\n      debouncedWriteAll()\n    })\n  }\n\n  emitter.on(`CREATE_PAGE`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, (): void => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n}\n"],"mappings":"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"}