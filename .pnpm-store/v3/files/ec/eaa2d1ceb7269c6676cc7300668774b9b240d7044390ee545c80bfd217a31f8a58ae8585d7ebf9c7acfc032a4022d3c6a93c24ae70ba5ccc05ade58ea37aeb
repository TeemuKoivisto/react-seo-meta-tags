{"version":3,"file":"index.js","names":["path","require","debug","fs","_","getPathToLayoutComponent","DEFAULT_FILE_EXTENSIONS_CATEGORIES","js","jsx","ts","tsx","cjs","mjs","coffee","json","yaml","yml","css","sass","scss","less","jpeg","jpg","jfif","png","tiff","webp","avif","gif","woff","woff2","module","exports","GatsbyThemeComponentShadowingResolverPlugin","constructor","projectRoot","themes","extensions","extensionsCategory","map","themeName","additionalShadowExtensions","buildAdditionalShadowExtensions","extensionsByCategory","groupBy","ext","substring","additionalExtensions","category","exts","Object","entries","push","key","value","sort","a","b","length","apply","resolver","getHook","tapAsync","request","stack","callback","_gatsbyThemeShadowingOriginalRequestPath","theme","component","getThemeAndComponent","context","issuer","requestPathIsIssuerShadowPath","issuerPath","userSiteDir","originalRequestPath","originalRequestComponent","basename","builtComponentPath","resolveComponentPath","doResolve","hooks","describedRelative","filter","themesArray","join","concat","reverse","themeDir","acceptableShadowFileNames","getAcceptableShadowFileNames","possibleComponentPath","dir","readdirSync","dirname","e","existsDir","filepath","matchingShadowFile","find","shadowFile","includes","allMatchingThemes","startsWith","matchingThemes","uniqBy","Error","split","getBaseShadowDirsForThemes","Array","from","shadowFiles","flatMap","comp","componentName","matchingEntry","entry","endsWith","additionalNames","baseName","slice","legacyAdditionalNames","uniq"],"sources":["../../../src/internal-plugins/webpack-theme-component-shadowing/index.js"],"sourcesContent":["const path = require(`path`)\nconst debug = require(`debug`)(`gatsby:component-shadowing`)\nconst fs = require(`fs`)\nconst _ = require(`lodash`)\nconst { getPathToLayoutComponent } = require(`gatsby-core-utils`)\n\n// A file can be shadowed by a file of the same extension, or a file of a\n// \"compatible\" file extension; two files extensions are compatible if they both\n// belongs to the same \"category\". For example, a .JS file (that is code), may\n// be shadowed by a .TS file or a .JSX file (both are code), but not by a .CSS\n// file (that is a stylesheet) or a .PNG file (that is an image). The following\n// list establish to which category a given file extension belongs. Note that if\n// a file is not present in this list, then it can only be shadowed by a file\n// of the same extension.\n\n// FIXME: Determine how this list can be extended by user/plugins\nconst DEFAULT_FILE_EXTENSIONS_CATEGORIES = {\n  // Code formats\n  js: `code`,\n  jsx: `code`,\n  ts: `code`,\n  tsx: `code`,\n  cjs: `code`,\n  mjs: `code`,\n  coffee: `code`,\n\n  // JSON-like data formats\n  json: `json`,\n  yaml: `json`,\n  yml: `json`,\n\n  // Stylesheets formats\n  css: `stylesheet`,\n  sass: `stylesheet`,\n  scss: `stylesheet`,\n  less: `stylesheet`,\n  \"css.js\": `stylesheet`,\n\n  // Images formats\n  jpeg: `image`,\n  jpg: `image`,\n  jfif: `image`,\n  png: `image`,\n  tiff: `image`,\n  webp: `image`,\n  avif: `image`,\n  gif: `image`,\n\n  // Fonts\n  woff: `font`,\n  woff2: `font`,\n}\n\n// TO-DO:\n//  - implement ability to add/remove shadowed modules from the webpack chain as file are being created/deleted\n//    ( https://github.com/gatsbyjs/gatsby/issues/11456 ):\n//    - this will also need to add memo invalidation for page template shadowing:\n//      see memoized `shadowCreatePagePath` function used in `createPage` action creator.\n\nmodule.exports = class GatsbyThemeComponentShadowingResolverPlugin {\n  constructor({ projectRoot, themes, extensions, extensionsCategory }) {\n    debug(\n      `themes list`,\n      themes.map(({ themeName }) => themeName)\n    )\n    this.themes = themes\n    this.projectRoot = projectRoot\n\n    this.extensions = extensions ?? []\n    this.extensionsCategory = {\n      ...DEFAULT_FILE_EXTENSIONS_CATEGORIES,\n      ...extensionsCategory,\n    }\n    this.additionalShadowExtensions = this.buildAdditionalShadowExtensions()\n  }\n\n  buildAdditionalShadowExtensions() {\n    const extensionsByCategory = _.groupBy(\n      this.extensions,\n      ext => this.extensionsCategory[ext.substring(1)] || `undefined`\n    )\n\n    const additionalExtensions = []\n    for (const [category, exts] of Object.entries(extensionsByCategory)) {\n      if (category === `undefined`) continue\n      for (const ext of exts) {\n        additionalExtensions.push({ key: ext, value: exts })\n      }\n    }\n\n    // Sort extensions in reverse length order, so that something such as\n    // \".css.js\" get caught before \".js\"\n    return additionalExtensions.sort(\n      ({ key: a }, { key: b }) => a.length <= b.length\n    )\n  }\n\n  apply(resolver) {\n    // This hook is executed very early and captures the original file name\n    resolver\n      .getHook(`resolve`)\n      .tapAsync(\n        `GatsbyThemeComponentShadowingResolverPlugin`,\n        (request, stack, callback) => {\n          if (!request._gatsbyThemeShadowingOriginalRequestPath) {\n            request._gatsbyThemeShadowingOriginalRequestPath = request.request\n          }\n          return callback()\n        }\n      )\n\n    // This is where the magic really happens\n    resolver\n      .getHook(`before-resolved`)\n      .tapAsync(\n        `GatsbyThemeComponentShadowingResolverPlugin`,\n        (request, stack, callback) => {\n          const [theme, component] = this.getThemeAndComponent(request.path)\n          if (!theme) {\n            return callback()\n          }\n\n          if (\n            /**\n             * if someone adds\n             * ```\n             * modules: [path.resolve(__dirname, /src'), 'node_modules'],\n             * ```\n             * to the webpack config, `issuer` is `null`, so we skip this check.\n             * note that it's probably a bad idea in general to set `modules`\n             * like this in a theme, but we also shouldn't artificially break\n             * people that do.\n             */\n            request.context.issuer &&\n            /**\n             * An issuer is the file making the require request. It can\n             * be in a user's site or a theme. If the issuer is requesting\n             * a path in the shadow chain that it participates in, then we\n             * will let the request through as normal. Otherwise, we\n             * engage the shadowing algorithm.\n             */\n            this.requestPathIsIssuerShadowPath({\n              component,\n              theme,\n              issuerPath: request.context.issuer,\n              userSiteDir: this.projectRoot,\n            })\n          ) {\n            return callback()\n          }\n\n          const originalRequestPath =\n            request._gatsbyThemeShadowingOriginalRequestPath\n          const originalRequestComponent = path.basename(originalRequestPath)\n\n          // This is the shadowing algorithm.\n          const builtComponentPath = this.resolveComponentPath({\n            theme,\n            component,\n            originalRequestComponent,\n          })\n\n          if (builtComponentPath) {\n            return resolver.doResolve(\n              resolver.hooks.describedRelative,\n              { ...request, path: builtComponentPath },\n              null,\n              {},\n              callback\n            )\n          } else {\n            return callback()\n          }\n        }\n      )\n  }\n\n  // check the user's project and the theme files\n  resolveComponentPath({ theme, component, originalRequestComponent }) {\n    // don't include matching theme in possible shadowing paths\n    const themes = this.themes.filter(\n      ({ themeName }) => themeName !== theme.themeName\n    )\n\n    const themesArray = [\n      path.join(this.projectRoot, `src`, theme.themeName),\n    ].concat(\n      themes\n        .reverse()\n        .map(({ themeDir }) => path.join(themeDir, `src`, theme.themeName))\n    )\n\n    const acceptableShadowFileNames = this.getAcceptableShadowFileNames(\n      path.basename(component),\n      originalRequestComponent\n    )\n\n    for (const theme of themesArray) {\n      const possibleComponentPath = path.join(\n        theme,\n        getPathToLayoutComponent(component)\n      )\n      debug(`possibleComponentPath`, possibleComponentPath)\n\n      let dir\n      try {\n        // we use fs/path instead of require.resolve to work with\n        // TypeScript and alternate syntaxes\n        dir = fs.readdirSync(path.dirname(possibleComponentPath))\n      } catch (e) {\n        continue\n      }\n      const existsDir = dir.map(filepath => path.basename(filepath))\n\n      // if no exact path, search for extension\n      const matchingShadowFile = acceptableShadowFileNames.find(shadowFile =>\n        existsDir.includes(shadowFile)\n      )\n      if (matchingShadowFile) {\n        return path.join(\n          path.dirname(possibleComponentPath),\n          matchingShadowFile\n        )\n      }\n    }\n    return null\n  }\n\n  getThemeAndComponent(filepath) {\n    // find out which theme's src/components dir we're requiring from\n    const allMatchingThemes = this.themes.filter(({ themeDir }) =>\n      filepath.startsWith(path.join(themeDir, `src`))\n    )\n\n    // The same theme can be included twice in the themes list causing multiple\n    // matches. This case should only be counted as a single match for that theme.\n    const matchingThemes = _.uniqBy(allMatchingThemes, `themeName`)\n\n    // 0 matching themes happens a lot for paths we don't want to handle\n    // > 1 matching theme means we have a path like\n    //   `gatsby-theme-blog/src/components/gatsby-theme-something/src/components`\n    if (matchingThemes.length > 1) {\n      throw new Error(\n        `Gatsby can't differentiate between themes ${matchingThemes\n          .map(theme => theme.themeName)\n          .join(` and `)} for path ${filepath}`\n      )\n    }\n\n    if (matchingThemes.length === 0) {\n      return [null, null]\n    }\n\n    const theme = matchingThemes[0]\n\n    // get the location of the component relative to its theme's src/\n    const [, component] = filepath.split(path.join(theme.themeDir, `src`))\n\n    return [theme, component]\n  }\n\n  // given a theme name, return all of the possible shadow locations\n  getBaseShadowDirsForThemes(theme) {\n    return Array.from(this.themes)\n      .reverse()\n      .map(({ themeName, themeDir }) => {\n        if (themeName === theme) {\n          return path.join(themeDir, `src`)\n        } else {\n          return path.join(themeDir, `src`, theme)\n        }\n      })\n  }\n\n  requestPathIsIssuerShadowPath({ theme, component, issuerPath, userSiteDir }) {\n    if (!theme || !component) {\n      return false\n    }\n\n    // get list of potential shadow locations\n    const shadowFiles = this.getBaseShadowDirsForThemes(theme.themeName)\n      .concat(path.join(userSiteDir, `src`, theme.themeName))\n      .map(dir => path.join(dir, component))\n      .flatMap(comp => this.getAcceptableShadowFileNames(comp))\n\n    // if the issuer is requesting a path that is a potential shadow path of itself\n    return shadowFiles.includes(issuerPath)\n  }\n\n  getAcceptableShadowFileNames(componentName, originalRequestComponent) {\n    const matchingEntry = this.additionalShadowExtensions.find(entry =>\n      componentName.endsWith(entry.key)\n    )\n\n    let additionalNames = []\n    if (matchingEntry) {\n      const baseName = componentName.slice(0, -matchingEntry.key.length)\n      additionalNames = matchingEntry.value.map(ext => `${baseName}${ext}`)\n    }\n\n    let legacyAdditionalNames = []\n    if (originalRequestComponent) {\n      legacyAdditionalNames = this.extensions.map(\n        ext => `${originalRequestComponent}${ext}`\n      )\n    }\n\n    return _.uniq([componentName, ...additionalNames, ...legacyAdditionalNames])\n  }\n}\n"],"mappings":"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"}