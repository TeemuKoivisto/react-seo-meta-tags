{"version":3,"file":"source-nodes.js","names":["deleteNode","actions","discoverPluginsWithoutNodes","storeState","nodes","nodeOwnerSet","Set","forEach","node","add","internal","owner","flattenedPlugins","filter","plugin","nodeAPIs","includes","has","name","map","warnForPluginsWithoutNodes","state","pluginsWithNoNodes","report","warn","getStaleNodes","rootNode","next","undefined","whileCount","parent","getNode","console","log","nodesTouched","id","deleteStaleNodes","staleNodes","store","dispatch","isInitialSourcing","sourcingCount","webhookBody","pluginName","parentSpan","deferNodeMutation","traceId","sourceNodesApiRunner","getDataStore","ready","getState","iterateNodes","apiFinished","apiName"],"sources":["../../src/utils/source-nodes.ts"],"sourcesContent":["import report from \"gatsby-cli/lib/reporter\"\nimport { Span } from \"opentracing\"\nimport { sourceNodesApiRunner } from \"./source-nodes-api-runner\"\nimport { store } from \"../redux\"\nimport { getDataStore, getNode } from \"../datastore\"\nimport { actions } from \"../redux/actions\"\nimport { IGatsbyState, IGatsbyNode } from \"../redux/types\"\nimport type { GatsbyIterable } from \"../datastore/common/iterable\"\n\nconst { deleteNode } = actions\n\n/**\n * Finds the name of all plugins which implement Gatsby APIs that\n * may create nodes, but which have not actually created any nodes.\n */\nfunction discoverPluginsWithoutNodes(\n  storeState: IGatsbyState,\n  nodes: GatsbyIterable<IGatsbyNode>\n): Array<string> {\n  // Find out which plugins own already created nodes\n  const nodeOwnerSet = new Set([`default-site-plugin`])\n  nodes.forEach(node => nodeOwnerSet.add(node.internal.owner))\n\n  return storeState.flattenedPlugins\n    .filter(\n      plugin =>\n        // \"Can generate nodes\"\n        plugin.nodeAPIs.includes(`sourceNodes`) &&\n        // \"Has not generated nodes\"\n        !nodeOwnerSet.has(plugin.name)\n    )\n    .map(plugin => plugin.name)\n}\n\n/**\n * Warn about plugins that should have created nodes but didn't.\n */\nfunction warnForPluginsWithoutNodes(\n  state: IGatsbyState,\n  nodes: GatsbyIterable<IGatsbyNode>\n): void {\n  const pluginsWithNoNodes = discoverPluginsWithoutNodes(state, nodes)\n\n  pluginsWithNoNodes.map(name =>\n    report.warn(\n      `The ${name} plugin has generated no Gatsby nodes. Do you need it? This could also suggest the plugin is misconfigured.`\n    )\n  )\n}\n\n/**\n * Return the set of nodes for which its root node has not been touched\n */\nfunction getStaleNodes(\n  state: IGatsbyState,\n  nodes: GatsbyIterable<IGatsbyNode>\n): GatsbyIterable<IGatsbyNode> {\n  return nodes.filter(node => {\n    let rootNode = node\n    let next: IGatsbyNode | undefined = undefined\n\n    let whileCount = 0\n    do {\n      next = rootNode.parent ? getNode(rootNode.parent) : undefined\n      if (next) {\n        rootNode = next\n      }\n    } while (next && ++whileCount < 101)\n\n    if (whileCount > 100) {\n      console.log(\n        `It looks like you have a node that's set its parent as itself`,\n        rootNode\n      )\n    }\n\n    return !state.nodesTouched.has(rootNode.id)\n  })\n}\n\n/**\n * Find all stale nodes and delete them\n */\nfunction deleteStaleNodes(\n  state: IGatsbyState,\n  nodes: GatsbyIterable<IGatsbyNode>\n): void {\n  const staleNodes = getStaleNodes(state, nodes)\n\n  staleNodes.forEach(node => store.dispatch(deleteNode(node)))\n}\n\nlet isInitialSourcing = true\nlet sourcingCount = 0\nexport default async ({\n  webhookBody,\n  pluginName,\n  parentSpan,\n  deferNodeMutation = false,\n}: {\n  webhookBody: unknown\n  pluginName?: string\n  parentSpan?: Span\n  deferNodeMutation?: boolean\n}): Promise<void> => {\n  const traceId = isInitialSourcing\n    ? `initial-sourceNodes`\n    : `sourceNodes #${sourcingCount}`\n  await sourceNodesApiRunner({\n    traceId,\n    deferNodeMutation,\n    parentSpan,\n    webhookBody,\n    pluginName,\n  })\n\n  await getDataStore().ready()\n\n  // We only warn for plugins w/o nodes and delete stale nodes on the first sourcing.\n  if (isInitialSourcing) {\n    const state = store.getState()\n    const nodes = getDataStore().iterateNodes()\n\n    warnForPluginsWithoutNodes(state, nodes)\n\n    deleteStaleNodes(state, nodes)\n    isInitialSourcing = false\n  }\n\n  store.dispatch(actions.apiFinished({ apiName: `sourceNodes` }))\n\n  sourcingCount += 1\n}\n"],"mappings":"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"}