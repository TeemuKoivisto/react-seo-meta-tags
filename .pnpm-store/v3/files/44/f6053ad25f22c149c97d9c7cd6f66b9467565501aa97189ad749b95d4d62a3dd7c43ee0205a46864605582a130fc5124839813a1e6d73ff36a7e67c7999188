{"version":3,"file":"jobsv2.js","names":["initialState","incomplete","Map","complete","jobsByRequest","jobsV2Reducer","state","action","type","cleanState","cleanStateKeys","Object","keys","isOutdatedJobsState","length","some","key","prototype","hasOwnProperty","call","cacheIsCorrupt","job","payload","set","contentDigest","jobContentDigest","result","get","Error","delete","inputPaths","requestId","jobs","Set","add"],"sources":["../../../src/redux/reducers/jobsv2.ts"],"sourcesContent":["import {\n  ICreateJobV2Action,\n  IRemoveStaleJobV2Action,\n  IEndJobV2Action,\n  IGatsbyState,\n  IGatsbyIncompleteJobV2,\n  IGatsbyCompleteJobV2,\n  IDeleteCacheAction,\n  ISetJobV2Context,\n  IClearJobV2Context,\n} from \"../types\"\n\nconst initialState = (): IGatsbyState[\"jobsV2\"] => {\n  return {\n    incomplete: new Map(),\n    complete: new Map(),\n    jobsByRequest: new Map(),\n  }\n}\n\nexport const jobsV2Reducer = (\n  state = initialState(),\n  action:\n    | ICreateJobV2Action\n    | IRemoveStaleJobV2Action\n    | IEndJobV2Action\n    | ISetJobV2Context\n    | IClearJobV2Context\n    | IDeleteCacheAction\n): IGatsbyState[\"jobsV2\"] => {\n  switch (action.type) {\n    case `DELETE_CACHE`: {\n      // Wipe the cache if state shape doesn't match the initial shape\n      // It is possible when the old cache is loaded for the new version of this reducer\n      const cleanState = initialState()\n      const cleanStateKeys = Object.keys(cleanState)\n\n      const isOutdatedJobsState =\n        cleanStateKeys.length !== Object.keys(state).length ||\n        cleanStateKeys.some(\n          key => !Object.prototype.hasOwnProperty.call(state, key)\n        )\n\n      return action.cacheIsCorrupt || isOutdatedJobsState ? cleanState : state\n    }\n\n    case `CREATE_JOB_V2`: {\n      const { job } = action.payload\n\n      state.incomplete.set(job.contentDigest, {\n        job,\n      } as IGatsbyIncompleteJobV2)\n\n      return state\n    }\n\n    case `END_JOB_V2`: {\n      const { jobContentDigest, result } = action.payload\n      const { job } = state.incomplete.get(\n        jobContentDigest\n      ) as IGatsbyIncompleteJobV2\n\n      if (!job) {\n        throw new Error(\n          `If you encounter this error, it's probably a Gatsby internal bug. Please open an issue reporting us this.`\n        )\n      }\n\n      state.incomplete.delete(job.contentDigest)\n\n      // inputPaths is used to make sure the job is not stale\n      state.complete.set(job.contentDigest, {\n        result,\n        inputPaths: job.inputPaths,\n      } as IGatsbyCompleteJobV2)\n\n      return state\n    }\n\n    case `REMOVE_STALE_JOB_V2`: {\n      const { contentDigest } = action.payload\n      state.incomplete.delete(contentDigest)\n      state.complete.delete(contentDigest)\n\n      return state\n    }\n\n    case `SET_JOB_V2_CONTEXT`: {\n      const { requestId, job } = action.payload\n\n      let jobs = state.jobsByRequest.get(requestId)\n      if (!jobs) {\n        jobs = new Set<string>()\n        state.jobsByRequest.set(requestId, jobs)\n      }\n      jobs.add(job.contentDigest)\n\n      return state\n    }\n\n    case `CLEAR_JOB_V2_CONTEXT`: {\n      const { requestId } = action.payload\n      state.jobsByRequest.delete(requestId)\n    }\n  }\n\n  return state\n}\n"],"mappings":";;;;AAYA,MAAMA,YAAY,GAAG,MAA8B;EACjD,OAAO;IACLC,UAAU,EAAE,IAAIC,GAAG,EAAE;IACrBC,QAAQ,EAAE,IAAID,GAAG,EAAE;IACnBE,aAAa,EAAE,IAAIF,GAAG;EACxB,CAAC;AACH,CAAC;AAEM,MAAMG,aAAa,GAAG,CAC3BC,KAAK,GAAGN,YAAY,EAAE,EACtBO,MAMsB,KACK;EAC3B,QAAQA,MAAM,CAACC,IAAI;IACjB,KAAM,cAAa;MAAE;QACnB;QACA;QACA,MAAMC,UAAU,GAAGT,YAAY,EAAE;QACjC,MAAMU,cAAc,GAAGC,MAAM,CAACC,IAAI,CAACH,UAAU,CAAC;QAE9C,MAAMI,mBAAmB,GACvBH,cAAc,CAACI,MAAM,KAAKH,MAAM,CAACC,IAAI,CAACN,KAAK,CAAC,CAACQ,MAAM,IACnDJ,cAAc,CAACK,IAAI,CACjBC,GAAG,IAAI,CAACL,MAAM,CAACM,SAAS,CAACC,cAAc,CAACC,IAAI,CAACb,KAAK,EAAEU,GAAG,CAAC,CACzD;QAEH,OAAOT,MAAM,CAACa,cAAc,IAAIP,mBAAmB,GAAGJ,UAAU,GAAGH,KAAK;MAC1E;IAEA,KAAM,eAAc;MAAE;QACpB,MAAM;UAAEe;QAAI,CAAC,GAAGd,MAAM,CAACe,OAAO;QAE9BhB,KAAK,CAACL,UAAU,CAACsB,GAAG,CAACF,GAAG,CAACG,aAAa,EAAE;UACtCH;QACF,CAAC,CAA2B;QAE5B,OAAOf,KAAK;MACd;IAEA,KAAM,YAAW;MAAE;QACjB,MAAM;UAAEmB,gBAAgB;UAAEC;QAAO,CAAC,GAAGnB,MAAM,CAACe,OAAO;QACnD,MAAM;UAAED;QAAI,CAAC,GAAGf,KAAK,CAACL,UAAU,CAAC0B,GAAG,CAClCF,gBAAgB,CACS;QAE3B,IAAI,CAACJ,GAAG,EAAE;UACR,MAAM,IAAIO,KAAK,CACZ,2GAA0G,CAC5G;QACH;QAEAtB,KAAK,CAACL,UAAU,CAAC4B,MAAM,CAACR,GAAG,CAACG,aAAa,CAAC;;QAE1C;QACAlB,KAAK,CAACH,QAAQ,CAACoB,GAAG,CAACF,GAAG,CAACG,aAAa,EAAE;UACpCE,MAAM;UACNI,UAAU,EAAET,GAAG,CAACS;QAClB,CAAC,CAAyB;QAE1B,OAAOxB,KAAK;MACd;IAEA,KAAM,qBAAoB;MAAE;QAC1B,MAAM;UAAEkB;QAAc,CAAC,GAAGjB,MAAM,CAACe,OAAO;QACxChB,KAAK,CAACL,UAAU,CAAC4B,MAAM,CAACL,aAAa,CAAC;QACtClB,KAAK,CAACH,QAAQ,CAAC0B,MAAM,CAACL,aAAa,CAAC;QAEpC,OAAOlB,KAAK;MACd;IAEA,KAAM,oBAAmB;MAAE;QACzB,MAAM;UAAEyB,SAAS;UAAEV;QAAI,CAAC,GAAGd,MAAM,CAACe,OAAO;QAEzC,IAAIU,IAAI,GAAG1B,KAAK,CAACF,aAAa,CAACuB,GAAG,CAACI,SAAS,CAAC;QAC7C,IAAI,CAACC,IAAI,EAAE;UACTA,IAAI,GAAG,IAAIC,GAAG,EAAU;UACxB3B,KAAK,CAACF,aAAa,CAACmB,GAAG,CAACQ,SAAS,EAAEC,IAAI,CAAC;QAC1C;QACAA,IAAI,CAACE,GAAG,CAACb,GAAG,CAACG,aAAa,CAAC;QAE3B,OAAOlB,KAAK;MACd;IAEA,KAAM,sBAAqB;MAAE;QAC3B,MAAM;UAAEyB;QAAU,CAAC,GAAGxB,MAAM,CAACe,OAAO;QACpChB,KAAK,CAACF,aAAa,CAACyB,MAAM,CAACE,SAAS,CAAC;MACvC;EAAC;EAGH,OAAOzB,KAAK;AACd,CAAC;AAAA"}