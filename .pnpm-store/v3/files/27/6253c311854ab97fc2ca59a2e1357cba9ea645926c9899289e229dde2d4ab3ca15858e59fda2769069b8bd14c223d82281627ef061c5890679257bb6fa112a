{"version":3,"file":"standalone-regenerate.js","names":["run","process","env","GATSBY_SLICES","console","log","loadConfigAndPlugins","siteDirectory","cwd","fs","remove","e","state","store","getState","buildActivityTimer","reporter","activityTimer","start","Promise","all","createGraphqlEngineBundle","createPageSSRBundle","rootDir","components","staticQueriesByTemplate","webpackCompilationHash","isVerbose","program","verbose","err","panic","end","validateEnginesActivity","validateEngines","error","id","context"],"sources":["../../../src/schema/graphql-engine/standalone-regenerate.ts"],"sourcesContent":["#!/usr/bin/env node\n\n/*\nthis is used for development purposes only\nto be able to run `gatsby build` once to source data\nand print schema and then just rebundle graphql-engine\nwith source file changes and test re-built engine quickly\n\nUsage:\nThere need to be at least one successful `gatsby build`\nbefore starting to use this script (warm up datastore,\ngenerate \"page-ssr\" bundle). Once that's done you can\nrun following command in test site directory:\n\n```shell\nnode node_modules/gatsby/dist/schema/graphql-engine/standalone-regenerate.js\n```\n*/\n\nimport { createGraphqlEngineBundle } from \"./bundle-webpack\"\nimport { createPageSSRBundle } from \"./../../utils/page-ssr-module/bundle-webpack\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { loadConfigAndPlugins } from \"../../utils/worker/child/load-config-and-plugins\"\nimport * as fs from \"fs-extra\"\nimport { store } from \"../../redux\"\nimport { validateEngines } from \"../../utils/validate-engines\"\n\nasync function run(): Promise<void> {\n  process.env.GATSBY_SLICES = `1`\n  // load config\n  console.log(`loading config and plugins`)\n  await loadConfigAndPlugins({\n    siteDirectory: process.cwd(),\n  })\n\n  try {\n    console.log(`clearing webpack cache\\n\\n`)\n    // get rid of cache if it exist\n    await fs.remove(process.cwd() + `/.cache/webpack/query-engine`)\n    await fs.remove(process.cwd() + `/.cache/webpack/page-ssr`)\n  } catch (e) {\n    // eslint-disable no-empty\n  }\n\n  const state = store.getState()\n\n  // recompile\n  const buildActivityTimer = reporter.activityTimer(\n    `Building Rendering Engines`\n  )\n  try {\n    buildActivityTimer.start()\n    await Promise.all([\n      createGraphqlEngineBundle(process.cwd(), reporter, true),\n      createPageSSRBundle({\n        rootDir: process.cwd(),\n        components: store.getState().components,\n        staticQueriesByTemplate: state.staticQueriesByTemplate,\n        webpackCompilationHash: state.webpackCompilationHash, // we set webpackCompilationHash above\n        reporter,\n        isVerbose: state.program.verbose,\n      }),\n    ])\n  } catch (err) {\n    buildActivityTimer.panic(err)\n  } finally {\n    buildActivityTimer.end()\n  }\n\n  // validate\n  const validateEnginesActivity = reporter.activityTimer(\n    `Validating Rendering Engines`\n  )\n  validateEnginesActivity.start()\n  try {\n    await validateEngines(process.cwd())\n  } catch (error) {\n    validateEnginesActivity.panic({ id: `98001`, context: {}, error })\n  } finally {\n    validateEnginesActivity.end()\n  }\n\n  console.log(`DONE`)\n}\n\nrun()\n"],"mappings":"AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAfA;;AAAA;AAiBA;AACA;AACA;AACA;AACA;AACA;AACA;AAA8D;AAAA;AAE9D,eAAeA,GAAG,GAAkB;EAClCC,OAAO,CAACC,GAAG,CAACC,aAAa,GAAI,GAAE;EAC/B;EACAC,OAAO,CAACC,GAAG,CAAE,4BAA2B,CAAC;EACzC,MAAM,IAAAC,0CAAoB,EAAC;IACzBC,aAAa,EAAEN,OAAO,CAACO,GAAG;EAC5B,CAAC,CAAC;EAEF,IAAI;IACFJ,OAAO,CAACC,GAAG,CAAE,4BAA2B,CAAC;IACzC;IACA,MAAMI,EAAE,CAACC,MAAM,CAACT,OAAO,CAACO,GAAG,EAAE,GAAI,8BAA6B,CAAC;IAC/D,MAAMC,EAAE,CAACC,MAAM,CAACT,OAAO,CAACO,GAAG,EAAE,GAAI,0BAAyB,CAAC;EAC7D,CAAC,CAAC,OAAOG,CAAC,EAAE;IACV;EAAA;EAGF,MAAMC,KAAK,GAAGC,YAAK,CAACC,QAAQ,EAAE;;EAE9B;EACA,MAAMC,kBAAkB,GAAGC,iBAAQ,CAACC,aAAa,CAC9C,4BAA2B,CAC7B;EACD,IAAI;IACFF,kBAAkB,CAACG,KAAK,EAAE;IAC1B,MAAMC,OAAO,CAACC,GAAG,CAAC,CAChB,IAAAC,wCAAyB,EAACpB,OAAO,CAACO,GAAG,EAAE,EAAEQ,iBAAQ,EAAE,IAAI,CAAC,EACxD,IAAAM,mCAAmB,EAAC;MAClBC,OAAO,EAAEtB,OAAO,CAACO,GAAG,EAAE;MACtBgB,UAAU,EAAEX,YAAK,CAACC,QAAQ,EAAE,CAACU,UAAU;MACvCC,uBAAuB,EAAEb,KAAK,CAACa,uBAAuB;MACtDC,sBAAsB,EAAEd,KAAK,CAACc,sBAAsB;MAAE;MACtDV,QAAQ,EAARA,iBAAQ;MACRW,SAAS,EAAEf,KAAK,CAACgB,OAAO,CAACC;IAC3B,CAAC,CAAC,CACH,CAAC;EACJ,CAAC,CAAC,OAAOC,GAAG,EAAE;IACZf,kBAAkB,CAACgB,KAAK,CAACD,GAAG,CAAC;EAC/B,CAAC,SAAS;IACRf,kBAAkB,CAACiB,GAAG,EAAE;EAC1B;;EAEA;EACA,MAAMC,uBAAuB,GAAGjB,iBAAQ,CAACC,aAAa,CACnD,8BAA6B,CAC/B;EACDgB,uBAAuB,CAACf,KAAK,EAAE;EAC/B,IAAI;IACF,MAAM,IAAAgB,gCAAe,EAACjC,OAAO,CAACO,GAAG,EAAE,CAAC;EACtC,CAAC,CAAC,OAAO2B,KAAK,EAAE;IACdF,uBAAuB,CAACF,KAAK,CAAC;MAAEK,EAAE,EAAG,OAAM;MAAEC,OAAO,EAAE,CAAC,CAAC;MAAEF;IAAM,CAAC,CAAC;EACpE,CAAC,SAAS;IACRF,uBAAuB,CAACD,GAAG,EAAE;EAC/B;EAEA5B,OAAO,CAACC,GAAG,CAAE,MAAK,CAAC;AACrB;AAEAL,GAAG,EAAE"}