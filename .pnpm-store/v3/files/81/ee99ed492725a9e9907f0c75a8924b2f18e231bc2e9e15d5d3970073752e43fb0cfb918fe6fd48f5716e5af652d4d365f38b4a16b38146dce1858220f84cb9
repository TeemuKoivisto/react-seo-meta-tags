{"version":3,"file":"build-html.js","names":["isPreview","process","env","GATSBY_IS_PREVIEW","devssrWebpackCompiler","SSRBundleReceivedInvalidEvent","SSRBundleWillInvalidate","devSSRWillInvalidate","activeRecompilations","getDevSSRWebpack","gatsby_executing_command","Error","watcher","compiler","recompileAndResumeWatching","allowTimedFallback","isResolved","Promise","resolve","stopWatching","suspend","timeout","finish","emitter","off","clearTimeout","on","resume","setTimeout","needToRecompileSSRBundle","oldHash","newHash","runWebpack","compilerConfig","stage","directory","isDevSSREnabledAndViable","GATSBY_EXPERIMENTAL_DEV_SSR","reject","webpack","hooks","invalid","tap","isFirstCompile","watch","ignored","err","stats","emit","hash","restartWorker","require","ROUTES_DIRECTORY","close","build","then","doBuildRenderer","webpackConfig","hasErrors","reporter","panicOnBuild","structureWebpackErrors","compilation","errors","rendererPath","doBuildPartialHydrationRenderer","buildRenderer","program","parentSpan","config","buildPartialHydrationRenderer","rule","module","rules","match","test","use","Array","isArray","push","loader","cache","output","path","join","alias","e","deleteRenderer","fs","remove","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","Stage","BuildHTML","envVars","NODE_ENV","gatsby_log_level","segments","sessionId","Date","now","webpackCompilationHash","store","getState","renderHTML","single","renderHTMLProd","renderHTMLDev","uniqueUnsafeBuiltinUsedStacks","Set","Bluebird","map","pageSegment","renderHTMLResult","paths","htmlRenderMeta","seenErrors","errorMessages","Map","all","Object","entries","previewErrors","pagePath","error","has","stack","set","pagePaths","add","prettyError","createErrorFromString","errorMessageStr","codeFrame","errorMessage","get","value","values","p","id","context","dispatch","type","payload","GATSBY_SLICES","slicesPropsPerPage","_pagePath","arrayOfUsages","unsafeBuiltinsUsageByPagePath","unsafeUsageStack","tick","length","size","console","warn","unsafeBuiltinUsedStack","warningMessage","renderPartialHydrationQueue","assetPrefix","pathPrefix","renderPartialHydrationProd","getPublicPath","BuildHTMLError","constructor","message","getOwnPropertyNames","forEach","key","doBuildPages","buildError","pageData","getPageData","modifiedPageDataForErrorMessage","modifyPageDataForErrorMessage","JSON","stringify","buildHTML","GATSBY_PARTIAL_HYDRATION","buildHTMLPagesAndDeleteStaleArtifacts","buildUtils","markHtmlDirtyIfResultOfUsedStaticQueryChanged","toRegenerate","toDelete","toCleanupFromTrackedState","calcDirtyHtmlFiles","buildHTMLActivityProgress","createProgress","start","errorPath","undefinedGlobal","extractUndefinedGlobal","panic","end","info","keepPageRenderer","buildSlices","stitchSlicesIntoPagesHTML","publicDir","deletePageDataActivityTimer","activityTimer","removePageFiles","state","slicesProps","sliceId","props","sliceName","hasChildren","dirty","html","bySliceId","slices","from","renderSlices","stichSlicesActivity","pagesThatNeedToStitchSlices","stichQueue","fastq","cb","stitchSliceForAPage","page","getPageMode","idle","drain"],"sources":["../../src/commands/build-html.ts"],"sourcesContent":["import Bluebird from \"bluebird\"\nimport fs from \"fs-extra\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { createErrorFromString } from \"gatsby-cli/lib/reporter/errors\"\nimport { chunk } from \"lodash\"\nimport { build, watch } from \"../utils/webpack/bundle\"\nimport * as path from \"path\"\nimport fastq from \"fastq\"\n\nimport { emitter, store } from \"../redux\"\nimport webpack from \"webpack\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { structureWebpackErrors } from \"../utils/webpack-error-utils\"\nimport * as buildUtils from \"./build-utils\"\nimport { getPageData } from \"../utils/get-page-data\"\n\nimport { Span } from \"opentracing\"\nimport { IProgram, Stage } from \"./types\"\nimport { ROUTES_DIRECTORY } from \"../constants\"\nimport { PackageJson } from \"../..\"\nimport { getPublicPath } from \"../utils/get-public-path\"\n\nimport type { GatsbyWorkerPool } from \"../utils/worker/pool\"\nimport { stitchSliceForAPage } from \"../utils/slices/stitching\"\nimport type { ISlicePropsEntry } from \"../utils/worker/child/render-html\"\nimport { getPageMode } from \"../utils/page-mode\"\nimport { extractUndefinedGlobal } from \"../utils/extract-undefined-global\"\nimport { modifyPageDataForErrorMessage } from \"../utils/page-data\"\n\ntype IActivity = any // TODO\n\nconst isPreview = process.env.GATSBY_IS_PREVIEW === `true`\n\nexport interface IBuildArgs extends IProgram {\n  directory: string\n  sitePackageJson: PackageJson\n  prefixPaths: boolean\n  noUglify: boolean\n  logPages: boolean\n  writeToFile: boolean\n  profile: boolean\n  graphqlTracing: boolean\n  openTracingConfigFile: string\n  // TODO remove in v4\n  keepPageRenderer: boolean\n}\n\ninterface IBuildRendererResult {\n  rendererPath: string\n  stats: webpack.Stats\n  close: ReturnType<typeof watch>[\"close\"]\n}\n\nlet devssrWebpackCompiler: webpack.Watching | undefined\nlet SSRBundleReceivedInvalidEvent = true\nlet SSRBundleWillInvalidate = false\n\nexport function devSSRWillInvalidate(): void {\n  // we only get one `invalid` callback, so if we already\n  // set this to true, we can't really await next `invalid` event\n  if (!SSRBundleReceivedInvalidEvent) {\n    SSRBundleWillInvalidate = true\n  }\n}\n\nlet activeRecompilations = 0\n\nexport const getDevSSRWebpack = (): {\n  recompileAndResumeWatching: (\n    allowTimedFallback: boolean\n  ) => Promise<() => void>\n  needToRecompileSSRBundle: boolean\n} => {\n  if (process.env.gatsby_executing_command !== `develop`) {\n    throw new Error(`This function can only be called in development`)\n  }\n\n  const watcher = devssrWebpackCompiler as webpack.Watching\n  const compiler = (devssrWebpackCompiler as webpack.Watching).compiler\n  if (watcher && compiler) {\n    return {\n      recompileAndResumeWatching: async function recompileAndResumeWatching(\n        allowTimedFallback: boolean\n      ): Promise<() => void> {\n        let isResolved = false\n        return await new Promise<() => void>(resolve => {\n          function stopWatching(): void {\n            activeRecompilations--\n            if (activeRecompilations === 0) {\n              watcher.suspend()\n            }\n          }\n          let timeout\n          function finish(): void {\n            emitter.off(`DEV_SSR_COMPILATION_DONE`, finish)\n            if (!isResolved) {\n              isResolved = true\n              resolve(stopWatching)\n            }\n            if (timeout) {\n              clearTimeout(timeout)\n            }\n          }\n          emitter.on(`DEV_SSR_COMPILATION_DONE`, finish)\n          // we reset it before we start compilation to be able to catch any invalid events\n          SSRBundleReceivedInvalidEvent = false\n          if (activeRecompilations === 0) {\n            watcher.resume()\n          }\n          activeRecompilations++\n\n          if (allowTimedFallback) {\n            // Timeout after 1.5s.\n            timeout = setTimeout(() => {\n              if (!isResolved) {\n                isResolved = true\n                resolve(stopWatching)\n              }\n            }, 1500)\n          }\n        })\n      },\n      needToRecompileSSRBundle:\n        SSRBundleReceivedInvalidEvent || SSRBundleWillInvalidate,\n    }\n  } else {\n    return {\n      needToRecompileSSRBundle: false,\n      recompileAndResumeWatching: (): Promise<() => void> =>\n        Promise.resolve((): void => {}),\n    }\n  }\n}\n\nlet oldHash = ``\nlet newHash = ``\nconst runWebpack = (\n  compilerConfig,\n  stage: Stage,\n  directory: string\n): Promise<{\n  stats: webpack.Stats\n  close: ReturnType<typeof watch>[\"close\"]\n}> => {\n  const isDevSSREnabledAndViable =\n    process.env.GATSBY_EXPERIMENTAL_DEV_SSR && stage === `develop-html`\n\n  return new Promise((resolve, reject) => {\n    if (isDevSSREnabledAndViable) {\n      const compiler = webpack(compilerConfig)\n\n      // because of this line we can't use our watch helper\n      // These things should use emitter\n      compiler.hooks.invalid.tap(`ssr file invalidation`, () => {\n        SSRBundleReceivedInvalidEvent = true\n        SSRBundleWillInvalidate = false // we were waiting for this event, we are no longer waiting for it\n      })\n\n      let isFirstCompile = true\n      const watcher = compiler.watch(\n        {\n          ignored: /node_modules/,\n        },\n        (err, stats) => {\n          // this runs multiple times\n          emitter.emit(`DEV_SSR_COMPILATION_DONE`)\n          if (isFirstCompile) {\n            watcher.suspend()\n            isFirstCompile = false\n          }\n\n          if (err) {\n            return reject(err)\n          } else {\n            newHash = stats?.hash || ``\n\n            const {\n              restartWorker,\n            } = require(`../utils/dev-ssr/render-dev-html`)\n            // Make sure we use the latest version during development\n            if (oldHash !== `` && newHash !== oldHash) {\n              restartWorker(`${directory}/${ROUTES_DIRECTORY}render-page.js`)\n            }\n\n            oldHash = newHash\n\n            return resolve({\n              stats: stats as webpack.Stats,\n              close: () =>\n                new Promise((resolve, reject): void =>\n                  watcher.close(err => (err ? reject(err) : resolve()))\n                ),\n            })\n          }\n        }\n      )\n      devssrWebpackCompiler = watcher\n    } else {\n      build(compilerConfig).then(\n        ({ stats, close }) => {\n          resolve({ stats, close })\n        },\n        err => reject(err)\n      )\n    }\n  })\n}\n\nconst doBuildRenderer = async (\n  directory: string,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<IBuildRendererResult> => {\n  const { stats, close } = await runWebpack(webpackConfig, stage, directory)\n  if (stats?.hasErrors()) {\n    reporter.panicOnBuild(\n      structureWebpackErrors(stage, stats.compilation.errors)\n    )\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return {\n    rendererPath: `${directory}/${ROUTES_DIRECTORY}render-page.js`,\n    stats,\n    close,\n  }\n}\n\nconst doBuildPartialHydrationRenderer = async (\n  directory: string,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<IBuildRendererResult> => {\n  const { stats, close } = await runWebpack(webpackConfig, stage, directory)\n  if (stats?.hasErrors()) {\n    reporter.panicOnBuild(\n      structureWebpackErrors(stage, stats.compilation.errors)\n    )\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return {\n    rendererPath: `${directory}/${ROUTES_DIRECTORY}render-page.js`,\n    stats,\n    close,\n  }\n}\n\nexport const buildRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<IBuildRendererResult> => {\n  const config = await webpackConfig(program, program.directory, stage, null, {\n    parentSpan,\n  })\n\n  return doBuildRenderer(program.directory, config, stage)\n}\n\nexport const buildPartialHydrationRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<IBuildRendererResult> => {\n  const config = await webpackConfig(program, program.directory, stage, null, {\n    parentSpan,\n  })\n\n  for (const rule of config.module.rules) {\n    if (`./test.js`.match(rule.test)) {\n      if (!rule.use) {\n        rule.use = []\n      }\n      if (!Array.isArray(rule.use)) {\n        rule.use = [rule.use]\n      }\n      rule.use.push({\n        loader: require.resolve(\n          `../utils/webpack/loaders/partial-hydration-reference-loader`\n        ),\n      })\n    }\n  }\n\n  // TODO add caching\n  config.cache = false\n\n  config.output.path = path.join(\n    program.directory,\n    `.cache`,\n    `partial-hydration`\n  )\n\n  // require.resolve might fail the build if the package is not installed\n  // Instead of failing it'll be ignored\n  try {\n    // TODO collect javascript aliases to match the partial hydration bundle\n    config.resolve.alias[`gatsby-plugin-image`] = require.resolve(\n      `gatsby-plugin-image/dist/gatsby-image.browser.modern`\n    )\n  } catch (e) {\n    // do nothing\n  }\n\n  return doBuildPartialHydrationRenderer(program.directory, config, stage)\n}\n\n// TODO remove after v4 release and update cloud internals\nexport const deleteRenderer = async (rendererPath: string): Promise<void> => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\nexport interface IRenderHtmlResult {\n  unsafeBuiltinsUsageByPagePath: Record<string, Array<string>>\n  previewErrors: Record<string, any>\n\n  slicesPropsPerPage: Record<\n    string,\n    Record<\n      string,\n      {\n        props: Record<string, unknown>\n        sliceName: string\n        hasChildren: boolean\n      }\n    >\n  >\n}\n\nconst renderHTMLQueue = async (\n  workerPool: GatsbyWorkerPool,\n  activity: IActivity,\n  htmlComponentRendererPath: string,\n  pages: Array<string>,\n  stage: Stage = Stage.BuildHTML\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars: Array<[string, string | undefined]> = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n\n  const sessionId = Date.now()\n\n  const { webpackCompilationHash } = store.getState()\n\n  const renderHTML =\n    stage === `build-html`\n      ? workerPool.single.renderHTMLProd\n      : workerPool.single.renderHTMLDev\n\n  const uniqueUnsafeBuiltinUsedStacks = new Set<string>()\n\n  try {\n    await Bluebird.map(segments, async pageSegment => {\n      const renderHTMLResult = await renderHTML({\n        envVars,\n        htmlComponentRendererPath,\n        paths: pageSegment,\n        sessionId,\n        webpackCompilationHash,\n      })\n\n      if (isPreview) {\n        const htmlRenderMeta = renderHTMLResult as IRenderHtmlResult\n        const seenErrors = new Set()\n        const errorMessages = new Map()\n        await Promise.all(\n          Object.entries(htmlRenderMeta.previewErrors).map(\n            async ([pagePath, error]) => {\n              if (!seenErrors.has(error.stack)) {\n                errorMessages.set(error.stack, {\n                  pagePaths: [pagePath],\n                })\n                seenErrors.add(error.stack)\n                const prettyError = createErrorFromString(\n                  error.stack,\n                  `${htmlComponentRendererPath}.map`\n                )\n\n                const errorMessageStr = `${prettyError.stack}${\n                  prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n                }`\n\n                const errorMessage = errorMessages.get(error.stack)\n                errorMessage.errorMessage = errorMessageStr\n                errorMessages.set(error.stack, errorMessage)\n              } else {\n                const errorMessage = errorMessages.get(error.stack)\n                errorMessage.pagePaths.push(pagePath)\n                errorMessages.set(error.stack, errorMessage)\n              }\n            }\n          )\n        )\n\n        for (const value of errorMessages.values()) {\n          const errorMessage = `The following page(s) saw this error when building their HTML:\\n\\n${value.pagePaths\n            .map(p => `- ${p}`)\n            .join(`\\n`)}\\n\\n${value.errorMessage}`\n          reporter.error({\n            id: `95314`,\n            context: { errorMessage },\n          })\n        }\n      }\n\n      if (stage === `build-html`) {\n        const htmlRenderMeta = renderHTMLResult as IRenderHtmlResult\n        store.dispatch({\n          type: `HTML_GENERATED`,\n          payload: pageSegment,\n        })\n\n        if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n          store.dispatch({\n            type: `SET_SLICES_PROPS`,\n            payload: htmlRenderMeta.slicesPropsPerPage,\n          })\n        }\n\n        for (const [_pagePath, arrayOfUsages] of Object.entries(\n          htmlRenderMeta.unsafeBuiltinsUsageByPagePath\n        )) {\n          for (const unsafeUsageStack of arrayOfUsages) {\n            uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n          }\n        }\n      }\n\n      if (activity && activity.tick) {\n        activity.tick(pageSegment.length)\n      }\n    })\n  } catch (e) {\n    if (e?.context?.unsafeBuiltinsUsageByPagePath) {\n      for (const [_pagePath, arrayOfUsages] of Object.entries(\n        e.context.unsafeBuiltinsUsageByPagePath\n      )) {\n        // @ts-ignore TS doesn't know arrayOfUsages is Iterable\n        for (const unsafeUsageStack of arrayOfUsages) {\n          uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n        }\n      }\n    }\n    throw e\n  } finally {\n    if (uniqueUnsafeBuiltinUsedStacks.size > 0) {\n      console.warn(\n        `Unsafe builtin method was used, future builds will need to rebuild all pages`\n      )\n      store.dispatch({\n        type: `SSR_USED_UNSAFE_BUILTIN`,\n      })\n    }\n\n    for (const unsafeBuiltinUsedStack of uniqueUnsafeBuiltinUsedStacks) {\n      const prettyError = createErrorFromString(\n        unsafeBuiltinUsedStack,\n        `${htmlComponentRendererPath}.map`\n      )\n\n      const warningMessage = `${prettyError.stack}${\n        prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n      }`\n\n      reporter.warn(warningMessage)\n    }\n  }\n}\n\nconst renderPartialHydrationQueue = async (\n  workerPool: GatsbyWorkerPool,\n  activity: IActivity,\n  pages: Array<string>,\n  program: IProgram\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars: Array<[string, string | undefined]> = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n  const sessionId = Date.now()\n\n  const { config } = store.getState()\n  const { assetPrefix, pathPrefix } = config\n\n  // Let the error bubble up\n  await Promise.all(\n    segments.map(async pageSegment => {\n      await workerPool.single.renderPartialHydrationProd({\n        envVars,\n        paths: pageSegment,\n        sessionId,\n        pathPrefix: getPublicPath({ assetPrefix, pathPrefix, ...program }),\n      })\n\n      if (activity && activity.tick) {\n        activity.tick(pageSegment.length)\n      }\n    })\n  )\n}\n\nclass BuildHTMLError extends Error {\n  codeFrame = ``\n  context?: {\n    path: string\n  }\n\n  constructor(error: Error) {\n    super(error.message)\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach(key => {\n      this[key] = error[key]\n    })\n  }\n}\n\nexport const doBuildPages = async (\n  rendererPath: string,\n  pagePaths: Array<string>,\n  activity: IActivity,\n  workerPool: GatsbyWorkerPool,\n  stage: Stage\n): Promise<void> => {\n  try {\n    await renderHTMLQueue(workerPool, activity, rendererPath, pagePaths, stage)\n  } catch (error) {\n    const prettyError = createErrorFromString(error, `${rendererPath}.map`)\n\n    const buildError = new BuildHTMLError(prettyError)\n    buildError.context = error.context\n\n    if (error?.context?.path) {\n      const pageData = await getPageData(error.context.path)\n      const modifiedPageDataForErrorMessage =\n        modifyPageDataForErrorMessage(pageData)\n\n      const errorMessage = `Truncated page data information for the failed page \"${\n        error.context.path\n      }\": ${JSON.stringify(modifiedPageDataForErrorMessage, null, 2)}`\n\n      // This is our only error during preview so customize it a bit + add the\n      // pretty build error.\n      if (isPreview) {\n        reporter.error({\n          id: `95314`,\n          context: { errorMessage },\n          error: buildError,\n        })\n      } else {\n        reporter.error(errorMessage)\n      }\n    }\n\n    // Don't crash the builder when we're in preview-mode.\n    if (!isPreview) {\n      throw buildError\n    }\n  }\n}\n\n// TODO remove in v4 - this could be a \"public\" api\nexport const buildHTML = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}: {\n  program: IProgram\n  stage: Stage\n  pagePaths: Array<string>\n  activity: IActivity\n  workerPool: GatsbyWorkerPool\n}): Promise<void> => {\n  const rendererPath = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n  await doBuildPages(rendererPath, pagePaths, activity, workerPool, stage)\n\n  if (\n    (process.env.GATSBY_PARTIAL_HYDRATION === `true` ||\n      process.env.GATSBY_PARTIAL_HYDRATION === `1`) &&\n    _CFLAGS_.GATSBY_MAJOR === `5`\n  ) {\n    await renderPartialHydrationQueue(workerPool, activity, pagePaths, program)\n  }\n}\n\nexport async function buildHTMLPagesAndDeleteStaleArtifacts({\n  workerPool,\n  parentSpan,\n  program,\n}: {\n  workerPool: GatsbyWorkerPool\n  parentSpan?: Span\n  program: IBuildArgs\n}): Promise<{\n  toRegenerate: Array<string>\n  toDelete: Array<string>\n}> {\n  const rendererPath = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n  buildUtils.markHtmlDirtyIfResultOfUsedStaticQueryChanged()\n\n  const { toRegenerate, toDelete, toCleanupFromTrackedState } =\n    buildUtils.calcDirtyHtmlFiles(store.getState())\n\n  store.dispatch({\n    type: `HTML_TRACKED_PAGES_CLEANUP`,\n    payload: toCleanupFromTrackedState,\n  })\n\n  if (toRegenerate.length > 0) {\n    const buildHTMLActivityProgress = reporter.createProgress(\n      `Building static HTML for pages`,\n      toRegenerate.length,\n      0,\n      {\n        parentSpan,\n      }\n    )\n    buildHTMLActivityProgress.start()\n    try {\n      await doBuildPages(\n        rendererPath,\n        toRegenerate,\n        buildHTMLActivityProgress,\n        workerPool,\n        Stage.BuildHTML\n      )\n    } catch (err) {\n      let id = `95313`\n      const context = {\n        errorPath: err.context && err.context.path,\n        undefinedGlobal: ``,\n      }\n\n      const undefinedGlobal = extractUndefinedGlobal(err)\n\n      if (undefinedGlobal) {\n        id = `95312`\n        context.undefinedGlobal = undefinedGlobal\n      }\n\n      buildHTMLActivityProgress.panic({\n        id,\n        context,\n        error: err,\n      })\n    }\n    buildHTMLActivityProgress.end()\n  } else {\n    reporter.info(`There are no new or changed html files to build.`)\n  }\n\n  if (\n    (process.env.GATSBY_PARTIAL_HYDRATION === `true` ||\n      process.env.GATSBY_PARTIAL_HYDRATION === `1`) &&\n    _CFLAGS_.GATSBY_MAJOR === `5`\n  ) {\n    if (toRegenerate.length > 0) {\n      const buildHTMLActivityProgress = reporter.createProgress(\n        `Building partial HTML for pages`,\n        toRegenerate.length,\n        0,\n        {\n          parentSpan,\n        }\n      )\n      try {\n        buildHTMLActivityProgress.start()\n        await renderPartialHydrationQueue(\n          workerPool,\n          buildHTMLActivityProgress,\n          toRegenerate,\n          program\n        )\n      } catch (error) {\n        // Generic error with page path and useful stack trace, accurate code frame can be a future improvement\n        buildHTMLActivityProgress.panic({\n          id: `80000`,\n          context: error.context,\n          error,\n        })\n      } finally {\n        buildHTMLActivityProgress.end()\n      }\n    }\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR !== `5` && !program.keepPageRenderer) {\n    try {\n      await deleteRenderer(rendererPath)\n    } catch (err) {\n      // pass through\n    }\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR === `5` && process.env.GATSBY_SLICES) {\n    await buildSlices({\n      program,\n      workerPool,\n      parentSpan,\n    })\n\n    await stitchSlicesIntoPagesHTML({\n      publicDir: path.join(program.directory, `public`),\n      parentSpan,\n    })\n  }\n\n  if (toDelete.length > 0) {\n    const publicDir = path.join(program.directory, `public`)\n    const deletePageDataActivityTimer = reporter.activityTimer(\n      `Delete previous page data`\n    )\n    deletePageDataActivityTimer.start()\n    await buildUtils.removePageFiles(publicDir, toDelete)\n\n    deletePageDataActivityTimer.end()\n  }\n\n  return { toRegenerate, toDelete }\n}\n\nexport async function buildSlices({\n  program,\n  workerPool,\n  parentSpan,\n}: {\n  workerPool: GatsbyWorkerPool\n  parentSpan?: Span\n  program: IBuildArgs\n}): Promise<void> {\n  const state = store.getState()\n\n  // for now we always render everything, everytime\n  const slicesProps: Array<ISlicePropsEntry> = []\n  for (const [\n    sliceId,\n    { props, sliceName, hasChildren, pages, dirty },\n  ] of state.html.slicesProps.bySliceId.entries()) {\n    if (dirty && pages.size > 0) {\n      slicesProps.push({\n        sliceId,\n        props,\n        sliceName,\n        hasChildren,\n      })\n    }\n  }\n\n  if (slicesProps.length > 0) {\n    const buildHTMLActivityProgress = reporter.activityTimer(\n      `Building slices HTML (${slicesProps.length})`,\n      {\n        parentSpan,\n      }\n    )\n    buildHTMLActivityProgress.start()\n\n    const htmlComponentRendererPath = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n    try {\n      const slices = Array.from(state.slices.entries())\n\n      await workerPool.single.renderSlices({\n        publicDir: path.join(program.directory, `public`),\n        htmlComponentRendererPath,\n        slices,\n        slicesProps,\n      })\n    } catch (err) {\n      const prettyError = createErrorFromString(\n        err.stack,\n        `${htmlComponentRendererPath}.map`\n      )\n\n      const undefinedGlobal = extractUndefinedGlobal(err)\n\n      let id = `11339`\n\n      if (undefinedGlobal) {\n        id = `11340`\n        err.context.undefinedGlobal = undefinedGlobal\n      }\n\n      buildHTMLActivityProgress.panic({\n        id,\n        context: err.context,\n        error: prettyError,\n      })\n    } finally {\n      buildHTMLActivityProgress.end()\n    }\n\n    // for now separate action for cleaning dirty flag and removing stale entries\n    store.dispatch({\n      type: `SLICES_PROPS_RENDERED`,\n      payload: slicesProps,\n    })\n  } else {\n    reporter.info(`There are no new or changed slice html files to build.`)\n  }\n\n  store.dispatch({\n    type: `SLICES_PROPS_REMOVE_STALE`,\n  })\n}\n\nexport async function stitchSlicesIntoPagesHTML({\n  publicDir,\n  parentSpan,\n}: {\n  publicDir: string\n  parentSpan?: Span\n}): Promise<void> {\n  const stichSlicesActivity = reporter.activityTimer(`stiching slices`, {\n    parentSpan,\n  })\n  stichSlicesActivity.start()\n  try {\n    const {\n      html: { pagesThatNeedToStitchSlices },\n      pages,\n    } = store.getState()\n\n    const stichQueue = fastq<void, string, void>(async (pagePath, cb) => {\n      await stitchSliceForAPage({ pagePath, publicDir })\n      cb(null)\n    }, 25)\n\n    for (const pagePath of pagesThatNeedToStitchSlices) {\n      const page = pages.get(pagePath)\n      if (!page) {\n        continue\n      }\n\n      if (getPageMode(page) === `SSG`) {\n        stichQueue.push(pagePath)\n      }\n    }\n\n    if (!stichQueue.idle()) {\n      await new Promise(resolve => {\n        stichQueue.drain = resolve as () => unknown\n      })\n    }\n\n    store.dispatch({ type: `SLICES_STITCHED` })\n  } finally {\n    stichSlicesActivity.end()\n  }\n}\n"],"mappings":"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"}